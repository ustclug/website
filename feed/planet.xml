<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="4.3.3">Jekyll</generator><link href="https://lug.ustc.edu.cn/feed/planet.xml" rel="self" type="application/atom+xml" /><link href="https://lug.ustc.edu.cn/" rel="alternate" type="text/html" /><updated>2024-08-20T19:05:17+08:00</updated><id>https://lug.ustc.edu.cn/feed/planet.xml</id><title type="html">LUG @ USTC | Planet</title><subtitle>中国科学技术大学 Linux 用户协会</subtitle><author><name>USTCLUG</name></author><entry><title type="html">使用 Rclone 备份 OneDrive 内容</title><link href="https://lug.ustc.edu.cn/planet/2024/05/onedrive-backup-with-rclone/" rel="alternate" type="text/html" title="使用 Rclone 备份 OneDrive 内容" /><published>2024-05-10T00:00:00+08:00</published><updated>2024-05-11T14:48:35+08:00</updated><id>https://lug.ustc.edu.cn/planet/2024/05/onedrive-backup-with-rclone</id><content type="html" xml:base="https://lug.ustc.edu.cn/planet/2024/05/onedrive-backup-with-rclone/"><![CDATA[<p>本文用于介绍如何使用 Rclone 备份 OneDrive 内容。</p>
      <h2 id="rclone-简介">Rclone 简介</h2>
      <p>Rclone 是一个命令行工具，用于同步文件和目录到和从云存储服务。它支持 Google Drive、Amazon S3、Dropbox、Microsoft OneDrive、Yandex Disk、Box 和其他一些云存储服务。Rclone 是一个 Go 程序，可以在 Windows、macOS、Linux 和其他操作系统上运行。</p>
      <h2 id="安装-rclone">安装 Rclone</h2>
      <p>Rclone 官方的下载链接在 <a href="https://rclone.org/downloads/">这里</a>。你可以根据自己的操作系统下载对应的版本。</p>
      <p>部分常见的包管理工具也提供了 Rclone 的安装方式，例如：</p>
      <ul>
        <li>
          <p>在 Windows 上，你可以使用 Chocolatey 安装 Rclone：</p>
          <div class="language-bash highlighter-rouge">
            <div class="highlight">
              <pre class="highlight"><code>choco <span class="nb">install </span>rclone
</code></pre>
            </div>
    </div>
        </li>
        <li>
          <p>在 Windows 上，你也可以使用 Winget 安装 Rclone：</p>
          <div class="language-bash highlighter-rouge">
            <div class="highlight">
              <pre class="highlight"><code>winget <span class="nb">install </span>Rclone.Rclone
</code></pre>
            </div>
    </div>
        </li>
        <li>
          <p>在 macOS 上，你可以使用 Homebrew 安装 Rclone：</p>
          <div class="language-bash highlighter-rouge">
            <div class="highlight">
              <pre class="highlight"><code>brew <span class="nb">install </span>rclone
</code></pre>
            </div>
    </div>
        </li>
        <li>
          <p>在 Ubuntu 上，你可以使用 apt 安装 Rclone：</p>
          <div class="language-bash highlighter-rouge">
            <div class="highlight">
              <pre class="highlight"><code><span class="nb">sudo </span>apt <span class="nb">install </span>rclone
</code></pre>
            </div>
    </div>
        </li>
        <li>
          <p>更多包管理器的安装方法可以参考 <a href="https://rclone.org/install/#package-manager">Rclone 官方文档</a>。</p>
        </li>
      </ul>
      <p>运行 <code class="language-plaintext highlighter-rouge">rclone --version</code> 来检查 Rclone 是否安装成功，如果正常，你应该类似看到如下输出：</p>
      <div class="language-console highlighter-rouge">
        <div class="highlight">
          <pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>rclone <span class="nt">--version</span>
<span class="go">rclone v1.66.0
- os/version: darwin 14.5 (64 bit)
- os/kernel: 23.5.0 (arm64)
- os/type: darwin
- os/arch: arm64 (ARMv8 compatible)
- go/version: go1.22.1
- go/linking: dynamic
- go/tags: none
</span></code></pre>
        </div>
      </div>
      <h2 id="配置-rclone">配置 Rclone</h2>
      <p>我们在这里以 <code class="language-plaintext highlighter-rouge">mail.ustc.edu.cn</code> 为例，做一个 step-by-step 的教程：</p>
      <div class="language-bash highlighter-rouge">
        <div class="highlight">
          <pre class="highlight"><code>rclone config
</code></pre>
        </div>
      </div>
      <div class="language-console highlighter-rouge">
        <div class="highlight">
          <pre class="highlight"><code><span class="go">No remotes found, make a new one?
n) New remote
s) Set configuration password
q) Quit config
</span><span class="gp">n/s/q&gt;</span><span class="w">
</span></code></pre>
        </div>
      </div>
      <p>输入 <code class="language-plaintext highlighter-rouge">n</code>，然后回车。</p>
      <div class="language-console highlighter-rouge">
        <div class="highlight">
          <pre class="highlight"><code><span class="go">Enter name for new remote.
</span><span class="gp">name&gt;</span><span class="w">
</span></code></pre>
        </div>
      </div>
      <p>输入一个名字，这里我们输入 <code class="language-plaintext highlighter-rouge">onedrive</code>，然后回车。</p>
      <div class="language-console highlighter-rouge">
        <div class="highlight">
          <pre class="highlight"><code><span class="go">Option Storage.
Type of storage to configure.
Choose a number from below, or type in your own value.
 1 / 1Fichier
   \ (fichier)
 2 / Akamai NetStorage
   \ (netstorage)
 3 / Alias for an existing remote
   \ (alias)
 4 / Amazon S3 Compliant Storage Providers including AWS, Alibaba, ArvanCloud, Ceph, ChinaMobile, Cloudflare, DigitalOcean, Dreamhost, GCS, HuaweiOBS, IBMCOS, IDrive, IONOS, LyveCloud, Leviia, Liara, Linode, Minio, Netease, Petabox, RackCorp, Rclone, Scaleway, SeaweedFS, StackPath, Storj, Synology, TencentCOS, Wasabi, Qiniu and others
   \ (s3)

</span><span class="c">...
</span><span class="go">
33 / Microsoft OneDrive
   \ (onedrive)

</span><span class="c">...
</span><span class="go">
</span><span class="gp">Storage&gt;</span><span class="w">
</span></code></pre>
        </div>
      </div>
      <p>输入 <code class="language-plaintext highlighter-rouge">onedrive</code>，然后回车。</p>
      <div class="language-console highlighter-rouge">
        <div class="highlight">
          <pre class="highlight"><code><span class="go">Option client_id.
OAuth Client Id.
Leave blank normally.
Enter a value. Press Enter to leave empty.
</span><span class="gp">client_id&gt;</span><span class="w">
</span><span class="go">
Option client_secret.
OAuth Client Secret.
Leave blank normally.
Enter a value. Press Enter to leave empty.
</span><span class="gp">client_secret&gt;</span><span class="w">
</span><span class="go">
Option region.
Choose national cloud region for OneDrive.
Choose a number from below, or type in your own string value.
Press Enter for the default (global).
 1 / Microsoft Cloud Global
   \ (global)
 2 / Microsoft Cloud for US Government
   \ (us)
 3 / Microsoft Cloud Germany
   \ (de)
 4 / Azure and Office 365 operated by Vnet Group in China
   \ (cn)
</span><span class="gp">region&gt;</span><span class="w">
</span><span class="go">
Edit advanced config?
y) Yes
n) No (default)
</span><span class="gp">y/n&gt;</span><span class="w">
</span><span class="go">
Use web browser to automatically authenticate rclone with remote?
 * Say Y if the machine running rclone has a web browser you can use
 * Say N if running rclone on a (remote) machine without web browser access
If not sure try Y. If Y failed, try N.

y) Yes (default)
n) No
</span><span class="gp">y/n&gt;</span><span class="w">
</span></code></pre>
        </div>
      </div>
      <p>这里我们都直接回车，不输入任何内容。(五次回车)</p>
      <p>在这其中会弹出一个网页，让你登录你的 OneDrive 账号，然后授权 Rclone 访问你的 OneDrive 账号。</p>
      <div class="language-console highlighter-rouge">
        <div class="highlight">
          <pre class="highlight"><code><span class="go">Option config_type.
Type of connection
Choose a number from below, or type in an existing string value.
Press Enter for the default (onedrive).
 1 / OneDrive Personal or Business
   \ (onedrive)
 2 / Root Sharepoint site
   \ (sharepoint)
   / Sharepoint site name or URL
 3 | E.g. mysite or https://contoso.sharepoint.com/sites/mysite
   \ (url)
 4 / Search for a Sharepoint site
   \ (search)
 5 / Type in driveID (advanced)
   \ (driveid)
 6 / Type in SiteID (advanced)
   \ (siteid)
   / Sharepoint server-relative path (advanced)
 7 | E.g. /teams/hr
   \ (path)
</span><span class="gp">config_type&gt;</span><span class="w">
</span></code></pre>
        </div>
      </div>
      <p>这里我们直接回车，不输入任何内容。</p>
      <div class="language-console highlighter-rouge">
        <div class="highlight">
          <pre class="highlight"><code><span class="go">Option config_driveid.
Select drive you want to use
Choose a number from below, or type in your own string value.
Press Enter for the default (b!****************************************************************).
 1 / OneDrive (business)
   \ (b!****************************************************************)
</span><span class="gp">config_driveid&gt;</span><span class="w">
</span><span class="go">
Drive OK?

Found drive "root" of type "business"
URL: https://mailustceducn-my.sharepoint.com/personal/tiankaima_mail_ustc_edu_cn/Documents

y) Yes (default)
n) No
</span><span class="gp">y/n&gt;</span><span class="w">
</span><span class="go">
Configuration complete.
Options:
- type: onedrive
- token:
***
- drive_id: b!****************************************************************
- drive_type: business
Keep this "onedrive" remote?
y) Yes this is OK (default)
e) Edit this remote
d) Delete this remote
</span><span class="gp">y/e/d&gt;</span><span class="w">
</span></code></pre>
        </div>
      </div>
      <p>依旧是直接回车，不输入任何内容。</p>
      <div class="language-console highlighter-rouge">
        <div class="highlight">
          <pre class="highlight"><code><span class="go">Current remotes:

Name                 Type
====                 ====
onedrive             onedrive

e) Edit existing remote
n) New remote
d) Delete remote
r) Rename remote
c) Copy remote
s) Set configuration password
q) Quit config
</span><span class="gp">e/n/d/r/c/s/q&gt;</span><span class="w">
</span></code></pre>
        </div>
      </div>
      <p>输入 <code class="language-plaintext highlighter-rouge">q</code>，然后回车。现在我们已经配置好了 Rclone。</p>
      <h2 id="将文件从-onedrive-备份到本地">将文件从 OneDrive 备份到本地</h2>
      <div class="language-console highlighter-rouge">
        <div class="highlight">
          <pre class="highlight"><code><span class="go">rclone copy onedrive: /path/to/local/folder -P
</span></code></pre>
        </div>
      </div>
      <h2 id="总结">总结</h2>
      <p>Rclone 是个非常强大的工具，支持的云存储服务也非常多，你可以通过 <code class="language-plaintext highlighter-rouge">rclone config</code> 来配置其他的云存储服务。</p>
      <p>限于篇幅和时间关系，本文只介绍了 Rclone 的基本使用方法，更多的功能和用法请参考 <a href="https://rclone.org/docs/">Rclone 官方文档</a>。</p>
      <p>如果您对这篇内容有任何问题或建议，欢迎 <a href="https://lug.ustc.edu.cn/wiki/lug/contact/">联系我们</a>。</p>
      ]]></content><author><name>tiankaima</name></author><category term="Tech Tutorial" /><category term="rclone" /><category term="OneDrive" /><summary type="html"><![CDATA[本文用于介绍如何使用 Rclone 备份 OneDrive 内容。]]></summary></entry><entry><title type="html">菜鸡写给菜鸡的 NetHack 入门教程</title><link href="https://lug.ustc.edu.cn/planet/2021/09/nethack-gitgud/" rel="alternate" type="text/html" title="菜鸡写给菜鸡的 NetHack 入门教程" /><published>2021-09-27T00:00:00+08:00</published><updated>2021-10-18T09:09:24+08:00</updated><id>https://lug.ustc.edu.cn/planet/2021/09/nethack-gitgud</id><content type="html" xml:base="https://lug.ustc.edu.cn/planet/2021/09/nethack-gitgud/"><![CDATA[<!-- Workaround for jekyll-titles-from-headings -->
      <h2 id="教程说明">教程说明</h2>
      <p>本教程只介绍最基本的操作和游戏刚刚开始阶段的策略，帮助新手活过第一层。引用内容为补充或 Fun facts，可以忽略。图中游戏“截图”均为字符界面的直接复制——虽然没有了颜色或加粗效果，但还是觉得这样更合适一些。</p>
      <h2 id="关于">关于</h2>
      <p>NetHack 是一款历史悠久的 Roguelike 游戏，基于龙与地下城规则，也有着 Roguelike 典型特征：随机生成地图，永久死亡，难度和复杂度非常高。同时，游戏中也融合了各种文化和领域的元素，并且有多种有趣的提示信息和死亡方式。</p>
      <blockquote>
        <p>总有一二十年才通关的老玩家说 NetHack 不难——或许和某些其他 Roguelike 相比确实如此，但这和你有什么关系呢？</p>
      </blockquote>
      <p>此游戏默认只有字符界面，以下为一个游戏画面，可以感受一下：</p>
      <div class="language-plaintext highlighter-rouge">
        <div class="highlight">
          <pre class="highlight"><code>This kobold corpse tastes terrible!--More--

                                                       --------
                      ----------                       |......-
                      |........|`######################-......|
                      |........|     -----------       |&lt;.....|
                      |........|     |.........|  #####.....{.|
                      |........-#####|.........-###    --------
                      |........|    #..........|
                      --------|-     -------.---
                             ##
                              ##
                              #
                             #
                     --------.--
                     |$........|
                     |.........|
    ------------    #..........|
    |.....@.d..|    #|..........
    |.....^.....#####|....&gt;....|
    ------------     -----------

Petergu the Stripling          St:15 Dx:14 Co:18 In:9 Wi:7 Ch:10 Lawful
Dlvl:1 $:11 HP:7(16) Pw:1(2) AC:6 Xp:1
</code></pre>
        </div>
      </div>
      <blockquote>
        <p>贴图模式也是有的，但是不如字符模式经典</p>
      </blockquote>
      <h2 id="安装和配置">安装和配置</h2>
      <p>如果你使用 Linux 等操作系统，那么 NetHack 多半可以直接从软件源中安装：包名通常为 <code class="language-plaintext highlighter-rouge">nethack</code> 或 <code class="language-plaintext highlighter-rouge">nethack-console</code>。如果使用 Windows，可以在<a href="https://nethack.org/v366/ports/download-win.html">官方网站</a>下载。建议使用默认的英文版。</p>
      <p>为了更好地游戏体验，在 Linux 上推荐将以下内容添加至 <code class="language-plaintext highlighter-rouge">~/.nethackrc</code> 配置文件（这也是 Ubuntu 中自带的配置）。</p>
      <pre><code class="language-dosini">#
# System-wide NetHack configuration file for tty-based NetHack.
#

OPTIONS=windowtype:tty,toptenwin,hilite_pet
OPTIONS=fixinv,safe_pet,sortpack,tombstone,color
OPTIONS=verbose,news,fruit:potato
OPTIONS=dogname:Slinky
OPTIONS=catname:Rex
OPTIONS=pickup_types:$
OPTIONS=nomail

# Enable this if you want to see your inventory sorted in alphabetical
# order by item instead of by index letter:
# OPTIONS=sortloot:full
# or if you just want containers sorted:
# OPTIONS=sortloot:loot

#
# Some sane menucolor defaults
#

OPTIONS=menucolors
MENUCOLOR=" blessed "=green
MENUCOLOR=" holy "=green
MENUCOLOR=" uncursed "=yellow
MENUCOLOR=" cursed "=red
MENUCOLOR=" unholy "=red
MENUCOLOR=" cursed .* (being worn)"=orange&amp;underline
</code></pre>
      <h2 id="开局">开局</h2>
      <p>运行 NetHack 后将看到以下提示：</p>
      <div class="language-plaintext highlighter-rouge">
        <div class="highlight">
          <pre class="highlight"><code>NetHack, Copyright 1985-2020
         By Stichting Mathematisch Centrum and M. Stephenson.
         Version 3.6.6 Unix, built Mar 18 18:21:43 2020.
         See license for details.


Shall I pick character's race, role, gender and alignment for you? [ynaq]
</code></pre>
        </div>
      </div>
      <p>你可以按 <code class="language-plaintext highlighter-rouge">n</code> 然后自己选择人物的种族（人类，矮人，精灵，地精，兽人）、角色（考古学家、骑士、游客等 13 种）、性别（男、女）和阵营（守序、中立、混乱），或者按 <code class="language-plaintext highlighter-rouge">y</code> 让系统随机选一个。对于新手，女武神（Valkyrie）、野蛮人（Barbarian）和武士（Samurai）是开局较为容易的角色，虽然我觉得巫师（Wizard）的游戏体验比较有趣。</p>
      <blockquote>
        <p>性别和阵营可以在游戏中因道具改变</p>
      </blockquote>
      <blockquote>
        <p>每个角色的每个阵营对应一个不同的神。其中僧侣（Monk）的神是中国神话传说中的”人物”：山海经、赤松子和黄帝</p>
      </blockquote>
      <p>选好之后根据提示按 <code class="language-plaintext highlighter-rouge">y</code> 开始。出现 <code class="language-plaintext highlighter-rouge">--More--</code> 时说明提示未显示完，按空格到下一句话。</p>
      <blockquote>
        <p>被怪打一下后出现 <code class="language-plaintext highlighter-rouge">--More--</code>，下一句话基本是 <code class="language-plaintext highlighter-rouge">You die...</code></p>
      </blockquote>
      <div class="language-plaintext highlighter-rouge">
        <div class="highlight">
          <pre class="highlight"><code>Hello petergu, welcome to NetHack!  You are a neutral male human Wizard.
--More--




  -----
  |..@|
  |.f(|
  |x..|
  |...|
  |?..+
  -----









Petergu the Evoker             St:9 Dx:8 Co:16 In:17 Wi:14 Ch:11 Neutral
Dlvl:1 $:0 HP:12(12) Pw:7(7) AC:9 Xp:1
</code></pre>
        </div>
      </div>
      <p>图中，<code class="language-plaintext highlighter-rouge">@</code> 是你，身边白底（复制出来看不到了）的 <code class="language-plaintext highlighter-rouge">f</code> 是你的宠物猫，<code class="language-plaintext highlighter-rouge">x</code> 是一只怪（grid bug），<code class="language-plaintext highlighter-rouge">+</code> 是关着的门。各种字符代表什么需要慢慢记忆，或者按 <code class="language-plaintext highlighter-rouge">/</code> 然后根据提示再按 <code class="language-plaintext highlighter-rouge">/</code>，移动光标查看地图上的信息，结束按 <code class="language-plaintext highlighter-rouge">ESC</code>。</p>
      <blockquote>
        <p>无论任何时候都要仔细阅读提示。这和学习 Linux 命令行是一样的。</p>
      </blockquote>
      <p>底栏是各种状态。新手主要要关注的就是 HP，即生命值；AC，Armor Class，代表防御，越低越好；以及可能出现在底栏的其他临时状态，比如失明（Blind）。其他属性的含义可在 Wiki 上查询。</p>
      <blockquote>
        <p>HP 降为 0 只是最无聊的死亡方式</p>
      </blockquote>
      <p>按 <code class="language-plaintext highlighter-rouge">i</code> 可以打开装备栏查看自己的物品。空格返回。</p>
      <div class="language-plaintext highlighter-rouge">
        <div class="highlight">
          <pre class="highlight"><code> Weapons
 a - a blessed +1 quarterstaff (weapon in hands)
 Armor
 b - an uncursed +0 cloak of magic resistance (being worn)
 Scrolls
 i - an uncursed scroll of magic mapping
 j - an uncursed scroll of enchant weapon
 k - an uncursed scroll of remove curse
 Spellbooks
 l - a blessed spellbook of force bolt
 m - an uncursed spellbook of create monster
 Potions
 f - an uncursed potion of gain ability
 g - an uncursed potion of monster detection
 h - an uncursed potion of healing
 Rings
 d - an uncursed ring of fire resistance
 e - an uncursed ring of invisibility
 Wands
 c - a wand of magic missile (0:4)
 Tools
 n - a magic marker (0:55)
 o - an uncursed blindfold
 (end)
</code></pre>
        </div>
      </div>
      <p>按 <code class="language-plaintext highlighter-rouge">Ctrl-X</code> 可以查看自身可以查看的属性。空格翻页和返回。</p>
      <blockquote>
        <p>更多的属性不能自我感觉到，只有特殊情况下才会显示出来</p>
      </blockquote>
      <div class="language-plaintext highlighter-rouge">
        <div class="highlight">
          <pre class="highlight"><code> Petergu the Wizard's attributes:

 Background:
  You are an Evoker, a level 1 male human Wizard.
  You are neutral, on a mission for Thoth
  who is opposed by Ptah (lawful) and Anhur (chaotic).
  You are in the Dungeons of Doom, on level 1.
  You entered the dungeon 9 turns ago.
  There is a full moon in effect.
  You have 0 experience points.

 Basics:
  You have all 12 hit points.
  You have all 7 energy points (spell power).
  Your armor class is 9.
  Your wallet is empty.
  Autopickup is on for '$' plus thrown.

 Current Characteristics:
  Your strength is 9.
  Your dexterity is 8.
  Your constitution is 16.
  Your intelligence is 17.
 (1 of 2)
</code></pre>
        </div>
      </div>
      <p>“静态”操作就这些：因为 NetHack 是回合制游戏，你可以随时查看这些信息并在进行动作前充分思考。</p>
      <p>那么接下来的任务就是活下去了。毕竟，游戏的目的是在地牢深处找到炎多的护符（Amulet of Yendor）并将其献给自己的神，而不是原地不动。</p>
      <h2 id="游戏开始">游戏开始</h2>
      <p>首先是<strong>移动</strong>。推荐的移动方式是和 Vim 操作类似的 8 个方向的 <code class="language-plaintext highlighter-rouge">hjklyubn</code>，当然新手用四个方向键也未尝不可。</p>
      <blockquote>
        <p>事实上，用方向键移动 as good as dead。按下一个移动键不松手也是常见的死亡原因。</p>
        <p>可以用大写的 <code class="language-plaintext highlighter-rouge">HJKLYUBN</code> 向一个方向长距离移动</p>
      </blockquote>
      <p>比如说，按下箭头或 <code class="language-plaintext highlighter-rouge">j</code> 移动到门边上。移动途中，<code class="language-plaintext highlighter-rouge">x</code> 被猫杀死了。</p>
      <blockquote>
        <p><code class="language-plaintext highlighter-rouge">Rex misses the grid bug. Rex bites the grid bug.</code></p>
        <p><code class="language-plaintext highlighter-rouge">Rex bites the grid bug. The grid bug is killed!</code></p>
      </blockquote>
      <blockquote>
        <p>按 <code class="language-plaintext highlighter-rouge">Ctrl-P</code> 可以查看之前的消息。</p>
      </blockquote>
      <blockquote>
        <p>前期，宠物比你战斗力强也是常有的事</p>
      </blockquote>
      <div class="language-plaintext highlighter-rouge">
        <div class="highlight">
          <pre class="highlight"><code> -----
 |..&lt;|
 |..(|
 |..f|
 |...|
 |..@+
 -----
</code></pre>
        </div>
      </div>
      <p><strong>开门</strong>才能出去。按 <code class="language-plaintext highlighter-rouge">ol</code> 开右侧（<code class="language-plaintext highlighter-rouge">l</code> 移动方向）的门。之后就可以向右探险了。沿着过道（<code class="language-plaintext highlighter-rouge">#</code>）走了一段，发现没有路了。</p>
      <div class="language-plaintext highlighter-rouge">
        <div class="highlight">
          <pre class="highlight"><code>-----
|..&lt;|
|..(|
|...|
|...|
|...-#
-----#
     ###
       #
       #
       ###f
          @
</code></pre>
        </div>
      </div>
      <p>这也是常见操作：需要搜索以下才能找到路。按 <code class="language-plaintext highlighter-rouge">s</code> <strong>搜索</strong>，或者更常用的，按 <code class="language-plaintext highlighter-rouge">10s</code> 搜索 10 次。如果没有路就再来 10 次。发现了隐藏的门，于是继续开门走进屋子。</p>
      <div class="language-plaintext highlighter-rouge">
        <div class="highlight">
          <pre class="highlight"><code>You find a hidden door.





  -----
  |..&lt;|
  |..(|
  |...|
  |...|
  |...-#
  -----#
       ###
         #
         #
         ###f
            @+
</code></pre>
        </div>
      </div>
      <p>屋子里有一个 <code class="language-plaintext highlighter-rouge">[</code> ，走到物品上方并按 <code class="language-plaintext highlighter-rouge">,</code> <strong>捡起</strong>。<code class="language-plaintext highlighter-rouge">p - a splint mail.</code>。这是一件盔甲，按 <code class="language-plaintext highlighter-rouge">w</code> <strong>穿戴</strong>，再按 <code class="language-plaintext highlighter-rouge">？</code> 选择可穿戴的物品，<code class="language-plaintext highlighter-rouge">p</code> 选择新捡到的盔甲。<code class="language-plaintext highlighter-rouge">You cannot wear armor over a cloak.</code>，先把外套<strong>脱下</strong>。按 <code class="language-plaintext highlighter-rouge">T</code>，看提示已经脱掉了，再穿盔甲，然后再次 <code class="language-plaintext highlighter-rouge">W</code> 穿上外套。这是可以看见 AC 降为 3，盔甲不错。</p>
      <blockquote>
        <p>我们的运气不错。如果发现 <code class="language-plaintext highlighter-rouge">AC</code> 上升，多半是盔甲被诅咒（cursed），并且被诅咒的兵器和物品无法脱下。</p>
      </blockquote>
      <div class="language-plaintext highlighter-rouge">
        <div class="highlight">
          <pre class="highlight"><code>                                             ----------------
                                            #@d.............|
  -----                                     f|...............           ....
  |..&lt;|                                  #### ..............|
  |..(|                                  ####+ .............+
  |...|                                  ##    --------- ----
  |...|                                  ##
  |...-#                                 ##
  -----#     ---------                   ##
       ###   |.......|      -----+----  ###
         #   |.......|      |.........###
         #   |.......|      |.......{|####
         ####|........######-........|
            #-.......|      |........|
             |.......|      |..&gt;.....|
             ---------      |........|
                            ----------

Petergu the Evoker             St:9 Dx:8 Co:16 In:17 Wi:14 Ch:11 Neutral
Dlvl:1 $:0 HP:10(12) Pw:7(7) AC:3 Xp:1
</code></pre>
        </div>
      </div>
      <p>继续探险，开门看见一只豺狼。直接按向右移动的键（<code class="language-plaintext highlighter-rouge">l</code>）<strong>攻击</strong>它。几步之后，狼被打死，你也只剩 8 HP 了。</p>
      <blockquote>
        <p>当然，见到怪不掂量一下自己的能力就直接攻击并不是好的策略。</p>
      </blockquote>
      <blockquote>
        <p>比如如果正面击打一个冰冻之眼（Frozen eye），你会被冻住若干回合，然后被旁边路过的小怪打死。</p>
      </blockquote>
      <blockquote>
        <p>可以按 <code class="language-plaintext highlighter-rouge">.</code> 原地休息，这会缓慢回复失去的 HP。</p>
      </blockquote>
      <div class="language-plaintext highlighter-rouge">
        <div class="highlight">
          <pre class="highlight"><code>You kill the jackal!  You hear water falling on coins.



                                             ----------------
                                            f@%.............|
  -----                                     #|...............           ....
  |..&lt;|                                  #### ..............|
  |..(|                                  ####+ .............+
  |...|                                  ##    --------- ----
  |...|                                  ##
  |...-#                                 ##
  -----#     ---------                   ##
       ###   |.......|      -----+----  ###
         #   |.......|      |.........###
         #   |.......|      |.......{|####
         ####|........######-........|
            #-.......|      |........|
             |.......|      |..&gt;.....|
             ---------      |........|
                            ----------

Petergu the Evoker             St:9 Dx:8 Co:16 In:17 Wi:14 Ch:11 Neutral
Dlvl:1 $:0 HP:8(12) Pw:7(7) AC:3 Xp:1
</code></pre>
        </div>
      </div>
      <p>可以看到提示狼被打死。同时你听到一些声音。</p>
      <blockquote>
        <p><code class="language-plaintext highlighter-rouge">You hear water falling on coins.</code> 的意思是本层有喷泉（中间屋子里的 <code class="language-plaintext highlighter-rouge">{</code>）</p>
      </blockquote>
      <p>地上的 <code class="language-plaintext highlighter-rouge">%</code> 是狼的尸体。杀死怪物后你多半希望<strong>吃掉</strong>尸体，否则没有食物会饿死。移动到 <code class="language-plaintext highlighter-rouge">%</code> 上方并按 <code class="language-plaintext highlighter-rouge">e</code>，选择 <code class="language-plaintext highlighter-rouge">y</code> 吃掉。</p>
      <blockquote>
        <p><code class="language-plaintext highlighter-rouge">You see here a jackal corpse.</code></p>
        <p><code class="language-plaintext highlighter-rouge">There is a jackal corpse here; eat it? [ynq] (n) y</code></p>
        <p><code class="language-plaintext highlighter-rouge">This jackal corpse tastes okay. You finish eating the jackal corpse.</code></p>
      </blockquote>
      <blockquote>
        <p>当然，不是什么都能吃。有些怪的尸体会让你中毒。如果因此呕吐，你会变得更饿。然而有些尸体可以让你获得某些能力（比如抵抗中毒、抵抗寒冷等）。如果触摸鸡头蛇怪（cockatrace）的尸体，会变成石头。</p>
      </blockquote>
      <p>这时，可以看到我们吃饱了，变得 Satiated。</p>
      <blockquote>
        <p>这时继续大量吃东西可能会被噎死。</p>
      </blockquote>
      <p>同时发现，有一扇锁着的门。我们目前没有撬锁工具，只能<strong>踢</strong>开。按 <code class="language-plaintext highlighter-rouge">Ctrl-D</code> 然后方向 <code class="language-plaintext highlighter-rouge">h</code> 踢门几次。</p>
      <div class="language-plaintext highlighter-rouge">
        <div class="highlight">
          <pre class="highlight"><code>This door is locked.



                                             ----------------
                                            #-..............|            -----
  -----                                     #|.f.............           .....|
  |..&lt;|                                  ####|..............|
  |..(|                                  ####+@.............+
  |...|                                  ##  ----------- ----
  |...|                                  ##
  |...-#                                 ##
  -----#     ---------                   ##
       ###   |.......|      -----+----  ###
         #   |.......|      |.........###
         #   |.......|      |.......{|####
         ####|........######-........|
            #-.......|      |........|
             |.......|      |..&gt;.....|
             ---------      |........|
                            ----------

Petergu the Evoker             St:9 Dx:8 Co:16 In:17 Wi:14 Ch:11 Neutral
Dlvl:1 $:0 HP:9(12) Pw:7(7) AC:3 Xp:1
</code></pre>
        </div>
      </div>
      <p>我们踢门多次门才打开，中途来了两只狼，第一只被猫一击咬死，第二只也被猫一击咬死。</p>
      <blockquote>
        <p><code class="language-plaintext highlighter-rouge">This door is locked.</code></p>
        <p><code class="language-plaintext highlighter-rouge">WHAMMM!!! Rex misses the jackal.</code></p>
        <p><code class="language-plaintext highlighter-rouge">WHAMMM!!! Rex bites the jackal. The jackal is killed!</code></p>
        <p><code class="language-plaintext highlighter-rouge">WHAMMM!!!</code></p>
        <p><code class="language-plaintext highlighter-rouge">WHAMMM!!!</code></p>
        <p><code class="language-plaintext highlighter-rouge">WHAMMM!!!</code></p>
        <p><code class="language-plaintext highlighter-rouge">As you kick the door, it crashes open! The jackal bites!</code></p>
        <p><code class="language-plaintext highlighter-rouge">Rex misses the jackal.</code></p>
        <p><code class="language-plaintext highlighter-rouge">You miss the jackal. The jackal bites! Rex bites the jackal.</code></p>
        <p><code class="language-plaintext highlighter-rouge">The jackal is killed!</code></p>
      </blockquote>
      <blockquote>
        <p>注意到图右边部分显示的房间了吗？因为从隔壁房间的门口“路过”，视野所限只能看到屋内的一部分。字符界面不代表没有光照的处理。</p>
      </blockquote>
      <p>一层探险结束后，捡到了一些其他护身符和戒指等。因为捡东西过多，处于 <code class="language-plaintext highlighter-rouge">Burdened</code> 状态。走到 <code class="language-plaintext highlighter-rouge">&gt;</code> 的位置，按 <code class="language-plaintext highlighter-rouge">&gt;</code> <strong>下行</strong>到下一层地牢。</p>
      <blockquote>
        <p>负重是非常不好的，但本人就是不想扔东西。</p>
      </blockquote>
      <blockquote>
        <p><code class="language-plaintext highlighter-rouge">You fall down the stairs.</code></p>
      </blockquote>
      <blockquote>
        <p>下楼的时候宠物如果在你身边一格以内，会和你一起下去。否则会被留在原地，并逐渐野化</p>
      </blockquote>
      <p>这时候，背包里已经有一些不知道是什么的装备了。</p>
      <blockquote>
        <p><code class="language-plaintext highlighter-rouge">r - a sapphire ring</code></p>
        <p><code class="language-plaintext highlighter-rouge">t - a pyramidal amulet</code></p>
      </blockquote>
      <p><strong>鉴定物品</strong>（Identification）是 NetHack 中重要而困难的。最基础的方法就是亲自体验：<code class="language-plaintext highlighter-rouge">P</code> - <code class="language-plaintext highlighter-rouge">?</code> - <code class="language-plaintext highlighter-rouge">t</code> 戴上护身符。好像没什么变化，仍然不知道是什么。按 <code class="language-plaintext highlighter-rouge">R</code> 移除。戒指也一样，什么也没鉴定成。只能作罢。</p>
      <blockquote>
        <p>鉴定物品的高级技巧有很多，比如在商店观察卖出价格。</p>
      </blockquote>
      <blockquote>
        <p>NetHack 中每种戒指、护身符和卷轴有不同的外观。每一局游戏中外观和功能的对应保持不变，但不同局游戏的这种对应是随机的。这一点并不是 trivial 的，因为，比如说，戒指的材质（金属、石头等）不一样，从而决定了每一局中玩家能通过变身（polymorph）并吃掉戒指获得何种永久属性。</p>
      </blockquote>
      <p>继续同样的探险。看到商店，但我们没有钱，只好离开。</p>
      <blockquote>
        <p><code class="language-plaintext highlighter-rouge">"Hello, petergu! Welcome to Akhalataki's used armor dealership!"</code></p>
      </blockquote>
      <blockquote>
        <p>攻击商店老板是非常不明智的行为。但是，如果店内有死亡魔杖（Wand of death），可以用其将老板杀死并获得所有的物品。如果有许愿魔杖（Wand of wishing），可以许愿得到死亡魔杖。这二者的基础价格都是 1200，很容易被认出。</p>
      </blockquote>
      <blockquote>
        <p>如果你是游客（Tourist），并且穿着夏威夷 T 恤（Hawaiian shirt），会被商店老板加价“宰客”。</p>
      </blockquote>
      <blockquote>
        <p>宠物可以捡起商店中的物品并在店门外放下—— shoplifting。</p>
        <p><code class="language-plaintext highlighter-rouge">You hear someone cursing shoplifters.</code></p>
      </blockquote>
      <div class="language-plaintext highlighter-rouge">
        <div class="highlight">
          <pre class="highlight"><code>         #
        ##
        #
        #
--------|--
|.......@.|
|[[[[[[f@[|
|[[[[[)[[)|
|))[[.[[[[|
-----------
</code></pre>
        </div>
      </div>
      <p>捡到并戴上一枚红宝石戒指后，发现这是被诅咒的——摘不下来了。然而还不知道它是干什么的，但多半不是什么好东西。</p>
      <blockquote>
        <p><code class="language-plaintext highlighter-rouge">E - a cursed ruby ring (on right hand)</code></p>
      </blockquote>
      <div class="language-plaintext highlighter-rouge">
        <div class="highlight">
          <pre class="highlight"><code>You see here a blindfold.  You faint from lack of food.--More--

                                       ------
                                       |....|
                                      #......###
                           ------######|....|  ##     ------
      ----------------     |....-######|....|   ###   |....|
      |..............-     |....|#     |....|     ####....F|
      .......@..F....|     |....|      |....|         |....-##
      |......f.......|     |..^..      --)---         ------ ###  ------------
      ---.------------     -|-.--        #                     ###..{........|
         ###                #            #####                    |..........|
           ####             #                ##                   |........&gt;.|
             -.----      ---.-      ----------.--                 ------------
             |....|      |...|      ............|
             |....|      |...|      |...........|
             |....|      |...|      |.&lt;.........+
             |.....######-...|      |...........|
             ------      -----      -------------



Petergu the Evoker             St:8 Dx:8 Co:16 In:17 Wi:14 Ch:11 Neutral
Dlvl:3 $:28 HP:15(15) Pw:23(23) AC:1 Xp:2 Fainted Burdened Deaf
</code></pre>
        </div>
      </div>
      <p>不久之后，因饥饿晕倒。戴上的戒指多半是 Ring of hunger。按 <code class="language-plaintext highlighter-rouge">e</code> 吃一个鸡蛋，回过神来。正好背包里有解除诅咒的卷轴，读一个：按 <code class="language-plaintext highlighter-rouge">r</code> - <code class="language-plaintext highlighter-rouge">?</code> - <code class="language-plaintext highlighter-rouge">k</code>。</p>
      <blockquote>
        <p><code class="language-plaintext highlighter-rouge">As you read the scroll, it disappears.--More--</code></p>
        <p><code class="language-plaintext highlighter-rouge">You feel like someone is helping you. Rex misses the lichen.--More--</code></p>
      </blockquote>
      <p>然后，戒指就可以摘下来了。</p>
      <p>又饿了，吃个鸡蛋结果变质了。</p>
      <blockquote>
        <p><code class="language-plaintext highlighter-rouge">Blecch! Rotten food! The world spins and goes dark.</code></p>
      </blockquote>
      <p>又走了一阵，没有吃的了（因为尸体都让猫吃了），已经晕倒，怎么办？只有神能救我们了。</p>
      <blockquote>
        <p><code class="language-plaintext highlighter-rouge">Wizard Needs Food, Badly!</code></p>
      </blockquote>
      <p><code class="language-plaintext highlighter-rouge">#pray</code></p>
      <blockquote>
        <p><code class="language-plaintext highlighter-rouge">You begin praying to Thoth. You are surrounded by a shimmering light.--More--</code></p>
        <p><code class="language-plaintext highlighter-rouge">You finish your prayer. You feel that Thoth is well-pleased.--More--</code></p>
        <p><code class="language-plaintext highlighter-rouge">Your stomach feels content.</code></p>
      </blockquote>
      <p><strong>祈祷</strong>是非常强大的——看，这就饱了。但是如果频繁祈祷，神会对我们生气。</p>
      <blockquote>
        <p>原地祈祷三次，就会被雷劈死。</p>
      </blockquote>
      <div class="language-plaintext highlighter-rouge">
        <div class="highlight">
          <pre class="highlight"><code>

                                                 --------
                            ---------------######........#
           --------         |..@&gt;.........|#     |......|#     -----
           |......|         |.............|#    #-..B...|#     |...|
           |...:..|         ---|-----------#    #|......|#     |...|
           |......|            #   ##   ####    #|.......##    |...|
           |......|         ##*##########       #.......| #####....|
           |......|        ##  #    #####     ###-------- #    |...|
           -----|--       ##   #        #     # #         #    -|---
                #         #  ###        ##    ##          #     #
                #        ##  #           #    #           #     #
                #        #---.------     #    #           #     #
                #        #|........|    -|----#           ##    ##
                #       ##|........|    |..|&gt;|#            ####--|---------
               ##     ### |........|    |....|#               #...........|
           ----.-     #   |&lt;.......|    |....-#                |..........|
           |.....######   |........|    ------                 |..........|
           |...{| ######  .........|                           ------------
           ------         ----------

Petergu the Evoker             St:9 Dx:8 Co:16 In:17 Wi:14 Ch:11 Neutral
Dlvl:4 $:62 HP:15(15) Pw:23(23) AC:1 Xp:2 Burdened
</code></pre>
        </div>
      </div>
      <p>发现，本层有两个下楼梯。这是因为有一个是通往支线任务地精矿洞（Gnomish Mines）的。这个支线较难，如果不是女武神等前期强角色基本不要擅自进入。支线地图是这种风格，周围都是地精 <code class="language-plaintext highlighter-rouge">G</code>。稍微进去一下，立刻被围攻。幸亏猫比较强打死几只怪。还剩 7 HP 逃了出来。当然，矿洞里装备也很多，我们换了双鞋子，现在 <code class="language-plaintext highlighter-rouge">AC</code> 是 0，而代价是沉重的盔甲和行动不便。</p>
      <blockquote>
        <p><code class="language-plaintext highlighter-rouge">b - an uncursed +0 cloak of magic resistance (being worn)</code></p>
        <p><code class="language-plaintext highlighter-rouge">p - a +0 splint mail (being worn)</code></p>
        <p><code class="language-plaintext highlighter-rouge">B - a +0 iron skull cap (being worn)</code></p>
        <p><code class="language-plaintext highlighter-rouge">I - a +0 pair of hard shoes (being worn)</code></p>
      </blockquote>
      <div class="language-plaintext highlighter-rouge">
        <div class="highlight">
          <pre class="highlight"><code>   ---
   |..--
 ---....- -
 |.......|.
  .........-
   -.......|
    -......|
     -..f..--
     --.....|
      -..G..|
   |....|...| ---
   | ----.......|
       -.@......|
      |.........|
      |.......---
      ..*.G.....
     ------------
</code></pre>
        </div>
      </div>
      <p>下一层看到一个箱子。可以 <code class="language-plaintext highlighter-rouge">#loot</code> <strong>抢劫</strong>。但箱子上锁了，所以可以踢几脚把锁打开。</p>
      <blockquote>
        <p>这么做的代价是箱内的药水和易碎的魔杖会损坏。</p>
      </blockquote>
      <blockquote>
        <p><code class="language-plaintext highlighter-rouge">THUD! You break open the lock!</code></p>
      </blockquote>
      <div class="language-plaintext highlighter-rouge">
        <div class="highlight">
          <pre class="highlight"><code>You see here a large box.


                                                           -----
                  -----------     #########################....|
                  |.........|    ###########        #      |...|
                  |.........|    #------      ------       .....
                  |.........|    #.....| #####...&lt;.|       |...|
                #`|..f..&gt;...|    #|.....##    |...)|       --.--
                 #-...@.....+     |....|      |...)|         #
                 #-----------    #-.----      |....|         #
                 #####        ##  ##          |....|###      #
                   # ################        #---.--##############
                              #              `############ --.-+-|----
                   .                               ###     ..........|
                  |.                                       |.........|
                  |.                                       |...... ..|
                  |.                                       |.........|
                  ---                                      |.........|
                                                           -----------


Petergu the Conjurer           St:9 Dx:8 Co:16 In:17 Wi:14 Ch:11 Neutral
Dlvl:5 $:75 HP:25(25) Pw:31(31) AC:0 Xp:3 Burdened
</code></pre>
        </div>
      </div>
      <p>然而箱子是空的。</p>
      <blockquote>
        <p>你也可以往箱子里放一些东西。</p>
      </blockquote>
      <p>下一层看到了一些类似宫殿的东西。中间有先知，可以花 50 块钱向它咨询（<code class="language-plaintext highlighter-rouge">#chat</code>）。</p>
      <div class="language-plaintext highlighter-rouge">
        <div class="highlight">
          <pre class="highlight"><code>You see here a statue of a plains centaur.


                                                   -------
             ------------           ###############-....*|
             |..........|        ####              |.....|
             ...........| ############        #####-.^....
             |.....&lt;....|##     #-----|-------#    -------
             -|----------#       |C.........C.#
              ############       |.....C.....|#
                                 |...-----...|
                                 |...|.{.|...|
                                 |..@|{.{|C..|
                                 |.....{.|...|
                                 |..f-----...|
                                 |.....C.....|
                                 |C.........C|
                                 -------------




Petergu the Conjurer           St:9 Dx:8 Co:16 In:17 Wi:14 Ch:11 Neutral
Dlvl:6 $:75 HP:25(25) Pw:31(31) AC:0 Xp:3 Burdened
</code></pre>
        </div>
      </div>
      <p>下一层，遇到一只巨大的蝙蝠（Giant bat），被咬到残血后我们逃跑，但是它追了过来，狭路相逢。</p>
      <div class="language-plaintext highlighter-rouge">
        <div class="highlight">
          <pre class="highlight"><code>The giant bat bites!--More--

                                          -----                       -----
                                          |...|                #######-...|
                                         #|....#################      |...|
                                         #-...|#                      |...|
                                         #|...|                       -...|
                                         #|...|                       |.&gt;.|
                                         #-----                       ---.-
                                         ##                              #
                                         #                               *
                                        ###                              #
                                         # #                             #
                                         ###                             #
                                           #                          -|-|-
                                           #                          |...|
                                           #                          |...|
                                          +######B@######`            ...&lt;|
                                         .|#                          -----
                                         .-#
                                         --#

Petergu the Conjurer           St:9 Dx:8 Co:16 In:17 Wi:14 Ch:11 Neutral
Dlvl:7 $:88 HP:5(29) Pw:43(43) AC:0 Xp:4 Burdened
</code></pre>
        </div>
      </div>
      <blockquote>
        <p><code class="language-plaintext highlighter-rouge">You die...--More--</code></p>
        <p><code class="language-plaintext highlighter-rouge">Do you want your possessions identified? [ynq] (n) </code></p>
      </blockquote>
      <p>于是毙命此地。</p>
      <p>死后游戏会问你要不要看看你的东西到底是什么。你可以看一眼。</p>
      <div class="language-plaintext highlighter-rouge">
        <div class="highlight">
          <pre class="highlight"><code> L - 3 uncursed scrolls of blank paper
 R - an uncursed scroll of fire
 Spellbooks
 l - a blessed spellbook of force bolt
 m - an uncursed spellbook of create monster
 x - an uncursed spellbook of slow monster
 Potions
 f - an uncursed potion of gain ability
 g - an uncursed potion of monster detection
 h - an uncursed potion of healing
 G - an uncursed potion of sickness
 O - an uncursed potion of water
 S - a blessed potion of sleeping
 Rings
 d - an uncursed ring of fire resistance
 e - an uncursed ring of invisibility
 r - an uncursed ring of cold resistance
 E - an uncursed ring of aggravate monster
 H - an uncursed ring of sustain ability
 Wands
 c - a wand of magic missile (0:4)
 Tools
 n - a magic marker (0:55)
 (2 of 3)
</code></pre>
        </div>
      </div>
      <p>通常，如果看了，就会发现背包有至少一件能避免死亡的物品（比如残血之后喝个药之类的，或者这个 magic missile 看起来很 promising）。然而生命只有一次，这就是 Roguelike。</p>
      <div class="language-plaintext highlighter-rouge">
        <div class="highlight">
          <pre class="highlight"><code>
                       ----------
                      /          \
                     /    REST    \
                    /      IN      \
                   /     PEACE      \
                  /                  \
                  |     petergu      |
                  |      88 Au       |
                  |   killed by a    |
                  |    giant bat     |
                  |                  |
                  |                  |
                  |       2021       |
                 *|     *  *  *      | *
        _________)/\\_//(\/(/\)/\//\/|_)_______


Goodbye petergu the Wizard...

You died in The Dungeons of Doom on dungeon level 7 with 704 points,
and 88 pieces of gold, after 3310 moves.
You were level 4 with a maximum of 29 hit points when you died.
</code></pre>
        </div>
      </div>
      <h2 id="尾声">尾声</h2>
      <p>通过本菜鸡的一局典型游戏流程，希望你已经了解了 NetHack 的基本操作，并能够在地下城中跌跌撞撞地存活一段有限大的时间。仍然有非常多重要的机制和操作本教程中没有提及（甚至 BUC 都没有说），这就要各位自己寻找了。对于一般玩家，要胜任这种游戏，作弊、剧透甚至是阅读源代码都是有必要而并不可耻的行为。</p>
      <h2 id="参考资料">参考资料</h2>
      <ul>
        <li><a href="https://nethackwiki.com">https://nethackwiki.com</a></li>
        <li><a href="https://www.zhihu.com/question/40177337">https://www.zhihu.com/question/40177337</a></li>
        <li><a href="https://www.melankolia.net/nethack/nethack.guide.html">https://www.melankolia.net/nethack/nethack.guide.html</a></li>
        <li><a href="https://nethack.org/">https://nethack.org/</a></li>
        <li><a href="https://github.com/regymm/nethackassistant">https://github.com/regymm/nethackassistant</a></li>
        <li><a href="https://alt.org/nethack/">https://alt.org/nethack/</a></li>
      </ul>
      ]]></content><author><name>petergu</name></author><category term="Tutorial" /><category term="游戏" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">用 Python 处理大物实验数据</title><link href="https://lug.ustc.edu.cn/planet/2021/01/physexp-using-python/" rel="alternate" type="text/html" title="用 Python 处理大物实验数据" /><published>2021-01-25T00:00:00+08:00</published><updated>2021-01-26T19:25:49+08:00</updated><id>https://lug.ustc.edu.cn/planet/2021/01/physexp-using-python</id><content type="html" xml:base="https://lug.ustc.edu.cn/planet/2021/01/physexp-using-python/"><![CDATA[<p>身为某<a href="http://世界一流退学.com">世界一流退学</a>的学生，大物实验自然是逃不过。本人有幸选择了大物实验最多的专业方向，从一级做到六级，直到上学期刚刚结束。大物实验里数据处理是占了很多时间的，那么怎么才能「优雅」地完成这一工作呢？</p>
    <h2 id="开始">开始</h2>
    <p>大一的时候讲座推荐的软件是 Origin，画图、拟合等虽然方便，但完全鼠标操作，并且只有 Windows 上能运行，Wine 上有时会遇到个别功能不好用，很影响体验（当时我的电脑配置不好，玩不起虚拟机）。思来想去，还是觉得 Python 比较自然，于是故事就这样开始了。</p>
    <p>在一级、二级大物中，需求基本是：散点画图（有时是对数）、线性拟合、组合的画图，以及不确定度计算和一般的数值计算。输入输出方面，要手工输入有时候多达几页的手写数据，画出来的图打印上交、计算出的结果手写进实验报告。</p>
    <p>Python 做这些事情其实都不困难。画图用 Matplotlib 非常方便，也可以直接保存图片。数据计算自然是 NumPy。线性拟合的话，最初选择了 SciPy。输入输出还是比较基本，从文件读入。</p>
    <p>于是，第一个实验「自由落体」的数据和处理就是这样：</p>
    <div class="language-plaintext highlighter-rouge">
      <div class="highlight">
        <pre class="highlight"><code>#光电门间距 H cm
#数量级
e -2
90.0	90.0	90.0	80.0	80.0	80.0	70.0	70.0	70.0	60.0	60.0	60.0	50.0	50.0	50.0	40.0	40.0	40.0	30.0	30.0	30.0	20.0	20.0	20.0
#时间差 t ms
e -3
331.6	331.5	331.8	307.9	307.9	307.9	282.9	282.8	282.9	255.8	255.7	255.7	226.9	227.0	226.9	195.2	195.2	195.2	159.9	159.9	159.8	119.2	119.1	119.2
</code></pre>
      </div>
    </div>
    <div class="language-python highlighter-rouge">
      <div class="highlight">
        <pre class="highlight"><code><span class="c1">#!/usr/bin/env python3
# -*- coding: utf-8 -*-
</span><span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="n">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">from</span> <span class="n">scipy</span> <span class="kn">import</span> <span class="n">stats</span>
<span class="kn">import</span> <span class="n">math</span>
<span class="c1">#avoid font problem
</span><span class="n">plt</span><span class="p">.</span><span class="n">rcParams</span><span class="p">[</span><span class="sh">'</span><span class="s">font.sans-serif</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="sh">'</span><span class="s">SimHei</span><span class="sh">'</span><span class="p">]</span>
<span class="n">plt</span><span class="p">.</span><span class="n">rcParams</span><span class="p">[</span><span class="sh">'</span><span class="s">axes.unicode_minus</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
<span class="c1">#read data
</span><span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
<span class="c1">#order of magnitude
</span><span class="n">oom</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">fin</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="sh">'</span><span class="s">./data.txt</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">r</span><span class="sh">'</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">fin</span><span class="p">.</span><span class="nf">readlines</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sh">'</span><span class="s">#</span><span class="sh">'</span><span class="p">:</span>
        <span class="c1">#line start with # is comment
</span>        <span class="k">pass</span>
    <span class="k">elif</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sh">'</span><span class="s">e</span><span class="sh">'</span><span class="p">:</span>
        <span class="n">oom</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="nf">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">data</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([</span><span class="nf">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="nf">pow</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">oom</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">i</span><span class="p">.</span><span class="nf">split</span><span class="p">()]))</span>
        <span class="n">oom</span> <span class="o">=</span> <span class="mi">0</span>
<span class="c1"># print(data)
### main processing ###
</span><span class="n">l</span> <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">y0</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">data</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">y0</span> <span class="o">/</span> <span class="n">x</span><span class="p">)</span>
<span class="n">y1</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="n">slope</span><span class="p">,</span> <span class="n">intercept</span><span class="p">,</span> <span class="n">r_value</span><span class="p">,</span> <span class="n">p_value</span><span class="p">,</span> <span class="n">std_err</span> <span class="o">=</span> <span class="n">stats</span><span class="p">.</span><span class="nf">linregress</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y1</span><span class="p">)</span>
<span class="c1"># z = np.polyfit(x, y1, 1)
</span><span class="n">s_slope</span> <span class="o">=</span> <span class="n">slope</span> <span class="o">*</span> <span class="n">math</span><span class="p">.</span><span class="nf">sqrt</span><span class="p">((</span><span class="n">r_value</span> <span class="o">**</span> <span class="o">-</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">l</span> <span class="o">-</span> <span class="mi">2</span><span class="p">))</span>
<span class="n">s_intercept</span> <span class="o">=</span> <span class="n">s_slope</span> <span class="o">*</span> <span class="n">math</span><span class="p">.</span><span class="nf">sqrt</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">mean</span><span class="p">(</span><span class="n">x</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">linear regression:</span><span class="sh">'</span> <span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">slope:</span><span class="sh">'</span><span class="p">,</span> <span class="n">slope</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">intercept:</span><span class="sh">'</span><span class="p">,</span> <span class="n">intercept</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">r-value:</span><span class="sh">'</span><span class="p">,</span> <span class="n">r_value</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">p-value:</span><span class="sh">'</span><span class="p">,</span> <span class="n">p_value</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">std-err:</span><span class="sh">'</span><span class="p">,</span> <span class="n">std_err</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">r-squared:</span><span class="sh">'</span><span class="p">,</span> <span class="n">r_value</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">斜率标准差:</span><span class="sh">'</span><span class="p">,</span> <span class="n">s_slope</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">截距标准差:</span><span class="sh">'</span><span class="p">,</span> <span class="n">s_intercept</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">算得重力加速度:</span><span class="sh">'</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">slope</span><span class="p">)</span>
<span class="c1">#plot
</span><span class="n">plt</span><span class="p">.</span><span class="nf">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="sh">'</span><span class="s">*</span><span class="sh">'</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="sh">'</span><span class="s">black</span><span class="sh">'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sh">'</span><span class="s">原始数据</span><span class="sh">'</span><span class="p">)</span>
<span class="c1"># plt.plot(x, y1, '--', color='green', label='光滑曲线')
</span><span class="n">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">intercept</span> <span class="o">+</span> <span class="n">slope</span> <span class="o">*</span> <span class="n">x</span><span class="p">,</span> <span class="sh">'</span><span class="s">r</span><span class="sh">'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sh">'</span><span class="s">拟合直线</span><span class="sh">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">xlabel</span><span class="p">(</span><span class="sh">'</span><span class="s">时间 t/s</span><span class="sh">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">ylabel</span><span class="p">(</span><span class="sh">'</span><span class="s">平均速度 H/t / m/s</span><span class="sh">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">title</span><span class="p">(</span><span class="sh">'</span><span class="s">小球下落平均速度与时间关系图</span><span class="sh">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">savefig</span><span class="p">(</span><span class="sh">'</span><span class="s">pic.png</span><span class="sh">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>
</code></pre>
      </div>
    </div>
    <p><img src="/static/planet/2021-01-25-physexp-using-python-1.png" alt="1" /></p>
    <p>只是画了张图就这么麻烦，很明显，除了练习了 Python 之外，和 Origin 相比生产力负提升。</p>
    <p>之后的问题就是简化这些过程了。</p>
    <h2 id="两年之后">两年之后</h2>
    <p>经过一年多的开发，我将一些常用的画图和数据处理操作打包成库，并添加了方便的文件输入和自动生成 docx 文件的功能。同时将 Python 包 <code class="language-plaintext highlighter-rouge">physicsexp</code> 发布到了 PyPI（和 AUR 一样，在 PyPI 发布包的门槛几乎没有）。</p>
    <p>这里以三级大物 β 射线吸收为例。现在，读入文件只需要这样：</p>
    <div class="language-python highlighter-rouge">
      <div class="highlight">
        <pre class="highlight"><code><span class="n">fin</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="sh">'</span><span class="s">./data.txt</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">r</span><span class="sh">'</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="sh">'</span><span class="s">utf-8</span><span class="sh">'</span><span class="p">)</span>
<span class="n">pos</span> <span class="o">=</span> <span class="nf">readoneline</span><span class="p">(</span><span class="n">fin</span><span class="p">)</span>
<span class="n">N</span> <span class="o">=</span> <span class="nf">readoneline</span><span class="p">(</span><span class="n">fin</span><span class="p">)</span>
<span class="n">Al_num</span> <span class="o">=</span> <span class="nf">readoneline</span><span class="p">(</span><span class="n">fin</span><span class="p">)</span>
<span class="n">Cnt</span> <span class="o">=</span> <span class="nf">readoneline</span><span class="p">(</span><span class="n">fin</span><span class="p">)</span>
<span class="n">fin</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
</code></pre>
      </div>
    </div>
    <p>数据做图也只要一行代码，一张图上多个曲线也只是一个参数的事，比如这是一张有三条线的图：</p>
    <div class="language-python highlighter-rouge">
      <div class="highlight">
        <pre class="highlight"><code><span class="nf">simple_plot</span><span class="p">(</span><span class="n">Momentum</span><span class="p">,</span> <span class="n">Emeasure</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">issetrange</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dot</span><span class="o">=</span><span class="sh">'</span><span class="s">+</span><span class="sh">'</span><span class="p">,</span> <span class="n">lab</span><span class="o">=</span><span class="sh">'</span><span class="s">测量动能</span><span class="sh">'</span><span class="p">)</span>
<span class="nf">simple_plot</span><span class="p">(</span><span class="n">Momentum</span><span class="p">,</span> <span class="n">Eclassic</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">issetrange</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dot</span><span class="o">=</span><span class="sh">'</span><span class="s">*</span><span class="sh">'</span><span class="p">,</span> <span class="n">lab</span><span class="o">=</span><span class="sh">'</span><span class="s">经典动能</span><span class="sh">'</span><span class="p">)</span>
<span class="nf">simple_plot</span><span class="p">(</span><span class="n">Momentum</span><span class="p">,</span> <span class="n">Erela</span><span class="p">,</span> <span class="n">dot</span><span class="o">=</span><span class="sh">'</span><span class="s">o</span><span class="sh">'</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="sh">'</span><span class="s">1.png</span><span class="sh">'</span><span class="p">,</span> <span class="n">issetrange</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">xlab</span><span class="o">=</span><span class="sh">'</span><span class="s">$pc/MeV$</span><span class="sh">'</span><span class="p">,</span> <span class="n">ylab</span><span class="o">=</span><span class="sh">'</span><span class="s">$E/MeV$</span><span class="sh">'</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="sh">'</span><span class="s">电子动能随动量变化曲线</span><span class="sh">'</span><span class="p">,</span> <span class="n">lab</span><span class="o">=</span><span class="sh">'</span><span class="s">相对论动能</span><span class="sh">'</span><span class="p">)</span>
</code></pre>
      </div>
    </div>
    <p>画图并线性拟合也是非常常见的操作，于是也加入了库：</p>
    <div class="language-python highlighter-rouge">
      <div class="highlight">
        <pre class="highlight"><code><span class="n">slope</span><span class="p">,</span> <span class="n">intercept</span> <span class="o">=</span> <span class="nf">simple_linear_plot</span><span class="p">(</span><span class="n">Al_Real</span><span class="p">,</span> <span class="n">CntLn</span><span class="p">,</span> <span class="n">xlab</span><span class="o">=</span><span class="sh">'</span><span class="s">质量厚度$g/cm^{-2}$</span><span class="sh">'</span><span class="p">,</span> <span class="n">ylab</span><span class="o">=</span><span class="sh">'</span><span class="s">选区计数率对数(射线强度)</span><span class="sh">'</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="sh">'</span><span class="s">半对数曲线曲线</span><span class="sh">'</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="sh">'</span><span class="s">3.png</span><span class="sh">'</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="o">-</span><span class="n">slope</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">math</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="mf">1e4</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="o">-</span><span class="n">slope</span><span class="p">))</span>
<span class="nf">print</span><span class="p">((</span><span class="n">math</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="n">Cnt</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">math</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">-</span> <span class="n">intercept</span><span class="p">)</span> <span class="o">/</span> <span class="n">slope</span><span class="p">)</span>
</code></pre>
      </div>
    </div>
    <p>最后，一行代码将所有的数据和图片生成直接可以打印的 docx 文件，包含名字和日期：</p>
    <div class="language-python highlighter-rouge">
      <div class="highlight">
        <pre class="highlight"><code><span class="nf">gendocx</span><span class="p">(</span><span class="sh">'</span><span class="s">gen.docx</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">1.png</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">2.png</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">3.png</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">slope, intercept: %f %f</span><span class="sh">'</span> <span class="o">%</span> <span class="p">(</span><span class="n">slope</span><span class="p">,</span> <span class="n">intercept</span><span class="p">))</span>
</code></pre>
      </div>
    </div>
    <p>文件如图所示，可以直接拿去打印了：</p>
    <p><img src="/static/planet/2021-01-25-physexp-using-python-2.png" alt="2" /></p>
    <p>下面是整体代码：</p>
    <div class="language-python highlighter-rouge">
      <div class="highlight">
        <pre class="highlight"><code><span class="c1">#!/usr/bin/env python3
# -*- coding: utf-8 -*-
</span>
<span class="kn">from</span> <span class="n">physicsexp.mainfunc</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="n">physicsexp.gendocx</span> <span class="kn">import</span> <span class="o">*</span>

<span class="c1"># read data
</span><span class="n">fin</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="sh">'</span><span class="s">./data.txt</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">r</span><span class="sh">'</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="sh">'</span><span class="s">utf-8</span><span class="sh">'</span><span class="p">)</span>
<span class="n">pos</span> <span class="o">=</span> <span class="nf">readoneline</span><span class="p">(</span><span class="n">fin</span><span class="p">)</span>
<span class="n">N</span> <span class="o">=</span> <span class="nf">readoneline</span><span class="p">(</span><span class="n">fin</span><span class="p">)</span>
<span class="n">Al_num</span> <span class="o">=</span> <span class="nf">readoneline</span><span class="p">(</span><span class="n">fin</span><span class="p">)</span>
<span class="n">Cnt</span> <span class="o">=</span> <span class="nf">readoneline</span><span class="p">(</span><span class="n">fin</span><span class="p">)</span>
<span class="n">fin</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>

<span class="c1"># data process
</span>
<span class="c1"># calculated calibration values in class
</span><span class="n">a</span> <span class="o">=</span> <span class="mf">2.373e-3</span>
<span class="n">b</span> <span class="o">=</span> <span class="o">-</span><span class="p">.</span><span class="mi">0161</span>
<span class="n">dEk</span> <span class="o">=</span> <span class="p">.</span><span class="mi">20</span>

<span class="n">c0</span> <span class="o">=</span> <span class="mf">299792458.</span>
<span class="n">MeV</span> <span class="o">=</span> <span class="mf">1e6</span> <span class="o">*</span> <span class="n">electron</span>

<span class="n">Emeasure</span> <span class="o">=</span> <span class="n">a</span> <span class="o">*</span> <span class="n">N</span> <span class="o">+</span> <span class="n">b</span> <span class="o">+</span> <span class="n">dEk</span>
<span class="n">x0</span> <span class="o">=</span> <span class="p">.</span><span class="mi">10</span>
<span class="n">R</span> <span class="o">=</span> <span class="p">(</span><span class="n">pos</span> <span class="o">-</span> <span class="n">x0</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
<span class="n">B</span> <span class="o">=</span> <span class="mf">640.01e-4</span>
<span class="n">Momentum</span> <span class="o">=</span> <span class="mi">300</span> <span class="o">*</span> <span class="n">B</span> <span class="o">*</span> <span class="n">R</span>
<span class="n">Eclassic</span> <span class="o">=</span> <span class="p">((</span><span class="n">Momentum</span> <span class="o">*</span> <span class="n">MeV</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">me</span> <span class="o">*</span> <span class="n">c0</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="o">/</span> <span class="n">MeV</span>
<span class="n">Erela</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([</span><span class="n">math</span><span class="p">.</span><span class="nf">sqrt</span><span class="p">((</span><span class="n">i</span> <span class="o">*</span> <span class="n">MeV</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">me</span> <span class="o">*</span> <span class="n">c0</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">me</span> <span class="o">*</span> <span class="n">c0</span><span class="o">**</span><span class="mi">2</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">Momentum</span><span class="p">])</span> <span class="o">/</span> <span class="n">MeV</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">pos</span><span class="se">\t</span><span class="sh">'</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">R</span><span class="se">\t</span><span class="sh">'</span><span class="p">,</span> <span class="n">R</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">pc</span><span class="se">\t</span><span class="sh">'</span><span class="p">,</span> <span class="n">Momentum</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">N</span><span class="se">\t</span><span class="sh">'</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">Eclas</span><span class="se">\t</span><span class="sh">'</span><span class="p">,</span> <span class="n">Eclassic</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">Erela</span><span class="se">\t</span><span class="sh">'</span><span class="p">,</span> <span class="n">Erela</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">Emes</span><span class="se">\t</span><span class="sh">'</span><span class="p">,</span> <span class="n">Emeasure</span><span class="p">)</span>

<span class="nf">simple_plot</span><span class="p">(</span><span class="n">Momentum</span><span class="p">,</span> <span class="n">Emeasure</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">issetrange</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dot</span><span class="o">=</span><span class="sh">'</span><span class="s">+</span><span class="sh">'</span><span class="p">,</span> <span class="n">lab</span><span class="o">=</span><span class="sh">'</span><span class="s">测量动能</span><span class="sh">'</span><span class="p">)</span>
<span class="nf">simple_plot</span><span class="p">(</span><span class="n">Momentum</span><span class="p">,</span> <span class="n">Eclassic</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">issetrange</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dot</span><span class="o">=</span><span class="sh">'</span><span class="s">*</span><span class="sh">'</span><span class="p">,</span> <span class="n">lab</span><span class="o">=</span><span class="sh">'</span><span class="s">经典动能</span><span class="sh">'</span><span class="p">)</span>
<span class="nf">simple_plot</span><span class="p">(</span><span class="n">Momentum</span><span class="p">,</span> <span class="n">Erela</span><span class="p">,</span> <span class="n">dot</span><span class="o">=</span><span class="sh">'</span><span class="s">o</span><span class="sh">'</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="sh">'</span><span class="s">1.png</span><span class="sh">'</span><span class="p">,</span> <span class="n">issetrange</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">xlab</span><span class="o">=</span><span class="sh">'</span><span class="s">$pc/MeV$</span><span class="sh">'</span><span class="p">,</span> <span class="n">ylab</span><span class="o">=</span><span class="sh">'</span><span class="s">$E/MeV$</span><span class="sh">'</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="sh">'</span><span class="s">电子动能随动量变化曲线</span><span class="sh">'</span><span class="p">,</span> <span class="n">lab</span><span class="o">=</span><span class="sh">'</span><span class="s">相对论动能</span><span class="sh">'</span><span class="p">)</span>

<span class="n">Len</span> <span class="o">=</span> <span class="mi">150</span>
<span class="n">Cnt</span> <span class="o">=</span> <span class="n">Cnt</span> <span class="o">/</span> <span class="n">Len</span>
<span class="nf">simple_plot</span><span class="p">(</span><span class="n">Al_num</span><span class="p">,</span> <span class="n">Cnt</span><span class="p">,</span> <span class="n">xlab</span><span class="o">=</span><span class="sh">'</span><span class="s">铝片数</span><span class="sh">'</span><span class="p">,</span> <span class="n">ylab</span><span class="o">=</span><span class="sh">'</span><span class="s">选区计数率(射线强度)</span><span class="sh">'</span><span class="p">,</span>
            <span class="n">title</span><span class="o">=</span><span class="sh">'</span><span class="s">$</span><span class="se">\\</span><span class="s">beta$射线强度随铝片数衰减曲线</span><span class="sh">'</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="sh">'</span><span class="s">2.png</span><span class="sh">'</span><span class="p">)</span>
<span class="n">CntLn</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="n">Cnt</span><span class="p">)</span>
<span class="c1"># d = 50 mg / cm^2
</span><span class="n">d</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">Al_Real</span> <span class="o">=</span> <span class="n">Al_num</span> <span class="o">*</span> <span class="n">d</span>
<span class="n">slope</span><span class="p">,</span> <span class="n">intercept</span> <span class="o">=</span> <span class="nf">simple_linear_plot</span><span class="p">(</span><span class="n">Al_Real</span><span class="p">,</span> <span class="n">CntLn</span><span class="p">,</span> <span class="n">xlab</span><span class="o">=</span><span class="sh">'</span><span class="s">质量厚度$g/cm^{-2}$</span><span class="sh">'</span><span class="p">,</span> <span class="n">ylab</span><span class="o">=</span><span class="sh">'</span><span class="s">选区计数率对数(射线强度)</span><span class="sh">'</span><span class="p">,</span>
                                      <span class="n">title</span><span class="o">=</span><span class="sh">'</span><span class="s">半对数曲线曲线</span><span class="sh">'</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="sh">'</span><span class="s">3.png</span><span class="sh">'</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="o">-</span><span class="n">slope</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">math</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="mf">1e4</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="o">-</span><span class="n">slope</span><span class="p">))</span>
<span class="nf">print</span><span class="p">((</span><span class="n">math</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="n">Cnt</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">math</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">-</span> <span class="n">intercept</span><span class="p">)</span> <span class="o">/</span> <span class="n">slope</span><span class="p">)</span>

<span class="nf">gendocx</span><span class="p">(</span><span class="sh">'</span><span class="s">gen.docx</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">1.png</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">2.png</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">3.png</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">slope, intercept: %f %f</span><span class="sh">'</span> <span class="o">%</span> <span class="p">(</span><span class="n">slope</span><span class="p">,</span> <span class="n">intercept</span><span class="p">))</span>
</code></pre>
      </div>
    </div>
    <p>整个代码不含空行和注释共 46 行，而上面的自由落体代码 45 行。可见包装程度还是不错的。先计算然后画这三张图，写上面的代码和 Origin 相比哪个更快呢？还是看个人习惯，反正我是比较习惯代码。至少，这说明了大物实验需要的数据处理还是有很多相似点的，以至于打包一些函数可以提高一些生产力。</p>
    <p>当然，这只是一个例子，对于个别实验，不管怎么处理都是要多花写时间的（直流辉光等离子体，说的就是你）。</p>
    <p>你可能会问，为什么没有误差分析的功能。这确实是一个问题：计算 A 类和 B 类不确定度等不同实验差别很大，水平有限，我能做的除了将常数打表提供最基础的功能外，好像就没什么了。并且，开发得差不多时已经到二级中期了，算不确定度也不常见了（所以，别被一级吓怕了），所以这部分也没怎么测试过，属于 TODO。</p>
    <h2 id="迟到的-jupyter-notebook">迟到的 Jupyter Notebook</h2>
    <p>以上还是标准的 Python，但五级大物时，我尝试了仅一次就发现明显 Jupyter Notebook 更适合做类似的工作——尽管它不能用 Vim 编辑代码！这下子，数据直接输入在 Notebook 里就好了，画图也是所见即所得，不用等一张一张弹出来了。而进行临时的运算也不必影响正常流程。如图：</p>
    <p><img src="/static/planet/2021-01-25-physexp-using-python-3.png" alt="3" /></p>
    <p>既然都到了 Jupyter ，如果<strong>多人合作</strong>的话，<a href="https://github.com/jupyterhub/jupyterhub">JupyterHub</a> 是非常不错的选择，可以多个人在一台服务器上使用 Jupyter Notebook 。我之前配置的是每个用户一个隔离的 Docker 容器，里面的 Python 已经装好了包，可以直接使用，同时挂载了一个共享空间可以分享写好的 Notebook 。其实 JupyterHub 有用 Github 帐号登录之类的权限管理功能，但当时我们是几个认识的人合作，就没有管这些。</p>
    <p>具体的代码在我的 <a href="https://github.com/ustcpetergu/physicsexp">GitHub</a> 上，如果有人在写大物实验报告的过程中无聊了想找个地方摸鱼浪费点时间，不妨来看看。</p>
    <h2 id="总结">总结</h2>
    <p>如果您想尝试用 Python 处理大物实验数据，我可以比较负责地说对于 95% 以上的实验是完全没有问题的。使用 NumPy 和 SciPy 计算， Matplotlib 做图，配以 docx 生成、Jupyter Notebook 或 JupyterHub 团队合作，可以比较轻松（但不意味着节省时间）地完成所有需要的操作，并可以通过包装库提高效率。</p>
    <p>之前也有学长学姐尝试过类似的大物实验自动化项目，但因为暂时无法全部找到并对比，这里就不说了。大一的时候确实是想搞一套自动化程度很高的东西，但水平实在有限，并且不同的实验处理过程不太一样，一己之力完成每一个实验专属的程序也不太现实，所以结果就是自己挖了个坑并跳进去出不来：有时想想，或许还是左手卡西欧 991 右手座标纸来得快一些呢！</p>
    ]]></content><author><name>petergu</name></author><category term="USTC" /><category term="大物实验" /><category term="Python" /><summary type="html"><![CDATA[身为某世界一流退学的学生，大物实验自然是逃不过。本人有幸选择了大物实验最多的专业方向，从一级做到六级，直到上学期刚刚结束。大物实验里数据处理是占了很多时间的，那么怎么才能「优雅」地完成这一工作呢？]]></summary></entry><entry><title type="html">在 Linux 内核中测试程序性能</title><link href="https://lug.ustc.edu.cn/planet/2020/12/tic-toc-in-kernel/" rel="alternate" type="text/html" title="在 Linux 内核中测试程序性能" /><published>2020-12-19T00:00:00+08:00</published><updated>2020-12-19T16:01:47+08:00</updated><id>https://lug.ustc.edu.cn/planet/2020/12/tic-toc-in-kernel</id><content type="html" xml:base="https://lug.ustc.edu.cn/planet/2020/12/tic-toc-in-kernel/"><![CDATA[<p>本学期，我担任了李诚老师编译原理课程的助教。在课程实验中，我们基于 LLVM 构建了一套编译系统，其中一个实验需要编写后端优化算法。为了评估学生们的优化代码，我们需要比较优化前后的代码（在这里是 LLVM IR）的性能。我们通过统计程序运行的时间来比较代码的性能，但是用户程序会受到<a href="https://101.lug.ustc.edu.cn/Ch04/#schedule">内核调度</a>。因为不是连续执行程序，所以受到调度造成的延迟会导致统计到的时间出现噪音，这些噪音可能会让测试结果不准确<del>甚至影响到了同学们的分数</del>。最开始，我想到是不是可以统计指令数来评估性能，打算用 <code class="language-plaintext highlighter-rouge">perf stat</code> 进行测试。然而，我们提供的实验环境基于虚拟机，<a href="https://www.virtualbox.org/ticket/10754?cversion=0&amp;cnum_hist=5">VirtualBox</a> 和 <a href="https://github.com/microsoft/WSL/issues/4678">WSL</a> 都没有实现相关的虚拟寄存器，要让同学们方便地使用该指令会比较困难，只得作罢。这时，我突然想到，内核线程可以不受到调度，那么使用内核线程是不是可以更精确的测量时间呢？于是我便开始了尝试。</p>
  <p>注：由于原本目的是用于 LLVM IR，所以使用了 <code class="language-plaintext highlighter-rouge">clang</code> 来编译内核，没有这种需求可以完全无视 <code class="language-plaintext highlighter-rouge">clang</code>。</p>
  <h2 id="编写内核模块">编写内核模块</h2>
  <h3 id="超简单的内核模块编写方法">超简单的内核模块编写方法</h3>
  <p>为了创建内核线程，我们可以构建一个内核模块，由它来执行相关的函数。构建一个基础的内核模块非常简单，这里我们 参考 <a href="https://tldp.org/LDP/lkmpg/2.6/html/x121.html"><strong>The Linux Kernel Module Programming Guide</strong></a>：</p>
  <div class="language-c highlighter-rouge">
    <div class="highlight">
      <pre class="highlight"><code><span class="cm">/*
 *  hello_mod.c - The simplest kernel module.
 */</span>
<span class="cp">#include</span> <span class="cpf">&lt;linux/module.h&gt;</span><span class="c1">	/* Needed by all modules */</span><span class="cp">
#include</span> <span class="cpf">&lt;linux/kernel.h&gt;</span><span class="c1">	/* Needed for KERN_INFO */</span><span class="cp">
</span>
<span class="kt">int</span> <span class="nf">init_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">"Hello world.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>

	<span class="cm">/*
	 * A non 0 return means init_module failed; module can't be loaded.
	 */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">cleanup_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">"Goodbye world.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="p">}</span>
</code></pre>
    </div>
  </div>
  <p>然后再加上一个简单的 Makefile：</p>
  <div class="language-makefile highlighter-rouge">
    <div class="highlight">
      <pre class="highlight"><code><span class="c"># obj-m 告诉构建系统以模块编译，编译目标是 hello.ko
</span><span class="nv">obj-m</span> <span class="o">+=</span> hello.o
<span class="nv">hello-objs</span> <span class="o">:=</span> hello_mod.o

<span class="nl">all</span><span class="o">:</span>
	make <span class="nt">-C</span> /lib/modules/<span class="p">$(</span>shell <span class="nb">uname</span> <span class="nt">-r</span><span class="p">)</span>/build <span class="nv">M</span><span class="o">=</span><span class="p">$(</span>PWD<span class="p">)</span> modules

<span class="nl">clean</span><span class="o">:</span>
	make <span class="nt">-C</span> /lib/modules/<span class="p">$(</span>shell <span class="nb">uname</span> <span class="nt">-r</span><span class="p">)</span>/build <span class="nv">M</span><span class="o">=</span><span class="p">$(</span>PWD<span class="p">)</span> clean
</code></pre>
    </div>
  </div>
  <p>这样，一个超简单的内核模块就完成啦！</p>
  <p>为了编译内核模块，我们需要有头文件，在 Ubuntu 上可以安装 <code class="language-plaintext highlighter-rouge">linux-headers-&lt;version&gt;</code> 来实现。又或者你像我一样需要用到 <code class="language-plaintext highlighter-rouge">clang</code> ，那就下载 Linux 源码重新编译安装（PS：如果全量编译搭配 VSCode 补全体验很好）。在这之后，运行 <code class="language-plaintext highlighter-rouge">sudo make CC=/path/to/clang</code> 就可以编译这个模块了。编译完成后，会发现目录下多出来一个叫 <code class="language-plaintext highlighter-rouge">hello.ko</code> 的文件，它就是我们编译得到的内核模块。</p>
  <p>在这个模块中，<code class="language-plaintext highlighter-rouge">init_module</code> 会在模块被载入时调用，而 <code class="language-plaintext highlighter-rouge">cleanup_module</code> 会被模块被卸载时被调用。通过 <code class="language-plaintext highlighter-rouge">insmod hello.ko</code>，可以载入它，而 <code class="language-plaintext highlighter-rouge">rmmod hello</code> 可以卸载这个模块。<code class="language-plaintext highlighter-rouge">printk</code>会将日志打印到内核的日志中，调用 <code class="language-plaintext highlighter-rouge">dmesg</code> 可以看到模块打印的欢迎和告别信息。</p>
  <h3 id="tic-toc-">Tic-Toc …</h3>
  <p>虽然已经编写了一个模块，但是它啥都干不来，我们还得实现计时功能。在编写用户态程序时，语言库里通常有获取当前时间的函数，内核也一样。我们可以通过<code class="language-plaintext highlighter-rouge">ktime.h</code> 中的 <code class="language-plaintext highlighter-rouge">ktime_get</code> 来获取时间，大概的逻辑如下：</p>
  <div class="language-c highlighter-rouge">
    <div class="highlight">
      <pre class="highlight"><code><span class="n">ktime_t</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">;</span>
<span class="n">u64</span> <span class="n">dur_ns</span><span class="p">;</span>
<span class="n">start</span> <span class="o">=</span> <span class="n">ktime_get</span><span class="p">();</span>
<span class="n">foo</span><span class="p">();</span> <span class="c1">// 被测试的函数</span>
<span class="n">end</span> <span class="o">=</span> <span class="n">ktime_get</span><span class="p">();</span>
<span class="n">dur_ns</span> <span class="o">=</span> <span class="n">ktime_to_ns</span><span class="p">(</span><span class="n">ktime_sub</span><span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="n">start</span><span class="p">));</span>
<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">"foo runtime: %lluns"</span><span class="p">,</span> <span class="n">dur_ns</span><span class="p">);</span>
</code></pre>
    </div>
  </div>
  <p>看得出来，内核里的函数接口也很平易近人，简单几行就把我们最核心的算法实现完了。</p>
  <h3 id="怎么使用它">怎么使用它？</h3>
  <p>现在，我们已经知道了如何统计时间，还得设计一个接口来让人触发相关的功能。虽然让模块在初始化时运行也不是不行，但是扩展性就变得太糟糕了。我决定用 <a href="https://en.wikipedia.org/wiki/Procfs">procfs</a> 来设计一个接口。Procfs 来源于 UNIX 哲学中一切皆文件的思想，它把系统运行时的一些信息用文件目录的形式展示出来，这样可以通过简单的文件操作（比如 <code class="language-plaintext highlighter-rouge">cat</code>、管道等）来访问和控制系统相关的参数，你可以通过 <code class="language-plaintext highlighter-rouge">/proc/</code> 目录访问里面的内容。</p>
  <p>在初始化的时候，我们通过 <code class="language-plaintext highlighter-rouge">proc_mkdir</code> 和 <code class="language-plaintext highlighter-rouge">proc_create</code> 可以像普通的文件系统一样在 <code class="language-plaintext highlighter-rouge">/proc/</code> 目录下创建目录和文件：</p>
  <div class="language-c highlighter-rouge">
    <div class="highlight">
      <pre class="highlight"><code><span class="c1">// 在 /proc/ 下创建一个目录</span>
<span class="k">if</span> <span class="p">((</span><span class="n">root</span> <span class="o">=</span> <span class="n">proc_mkdir</span><span class="p">(</span><span class="n">proc_dirname</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="k">return</span> <span class="o">-</span><span class="n">EEXIST</span><span class="p">;</span>
<span class="c1">// 在 /proc/&lt;proc_dirname&gt;/ 目录下创建一个文件，并让该文件使用 bench_fops</span>
<span class="k">if</span> <span class="p">(</span><span class="n">proc_create</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bench_fops</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
</code></pre>
    </div>
  </div>
  <p>这里的 <code class="language-plaintext highlighter-rouge">bench_fops</code> 是一个类型为 <code class="language-plaintext highlighter-rouge">struct file_operations</code> 的结构体。它能为这个文件注册功能，比如 open、read、write 等。在内核中设计一个文件系统也需要实现类似的操作，万幸的是， procfs 下不需要实现 <a href="https://en.wikipedia.org/wiki/POSIX">POSIX</a> 语义。在这里，我希望只要有 <code class="language-plaintext highlighter-rouge">write</code> 被调用时，就会运行我的测试程序，这样我只要在 shell 中用 <code class="language-plaintext highlighter-rouge">echo</code> 和管道重定向就能调用它了：</p>
  <div class="language-c highlighter-rouge">
    <div class="highlight">
      <pre class="highlight"><code><span class="c1">// 所有参数都用不到，我们只希望触发一次测试</span>
<span class="kt">ssize_t</span> <span class="nf">run_bench</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
                  <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 测试相关的函数</span>
    <span class="n">foo</span><span class="p">();</span>
    <span class="c1">// 返回长度和参数一样代表写入成功</span>
    <span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// 这是 C99 加入的结构体指定初始化，其它成员默认为空。</span>
<span class="c1">// 这意味着该文件只支持写</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">bench_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span>		<span class="o">=</span> <span class="n">run_bench</span>
<span class="p">}</span>
</code></pre>
    </div>
  </div>
  <p>模块功能已经完成了，最后得给模块取个好听的名字。我把英文中表示时间流逝的 tic-toc （tick-tock） 和表示内核的 kernel 合在一起，就变成了 tiktok。</p>
  <h2 id="链接函数">链接函数</h2>
  <p>我本以为编写了寥寥数行 tiktok，将 LLVM IR 编译到目标文件再链接到模块上便可以了。然而经过测试，这样做会导致进程一直无法返回。经过反汇编比较了同一段代码在内核模块里编译的结果和外部产生的结果后，我才理解是因为编译选项不同导致了内存布局的差别，这使得默认参数编译的代码无法在内核中使用。由于内核编译选项繁杂，根据不同架构也会产生不同的选项，我们必须把代码放置进内核的构建系统内来让它产生内核想要的汇编（现在的内核中禁用了浮点数，所以浮点计算就无法测试了）。对于普通的 c 文件，只需要在 Makefile 中加上几句，比如：</p>
  <div class="language-makefile highlighter-rouge">
    <div class="highlight">
      <pre class="highlight"><code><span class="nv">hello-objs</span> <span class="o">:=</span> hello_mod.o another_file.o
</code></pre>
    </div>
  </div>
  <p>但是 LLVM IR 还需要一些技巧来骗过编译系统才行。我把自制编译器产生的 IR 文件改成了 .c 文件，并修改了 Makefile：</p>
  <div class="language-makefile highlighter-rouge">
    <div class="highlight">
      <pre class="highlight"><code><span class="nv">hello-objs</span> <span class="o">:=</span> hello_mod.o another_file.o
<span class="nv">CFLAGS_another_file.o</span> <span class="o">:=</span> <span class="nt">-O0</span> <span class="nt">-x</span> ir
</code></pre>
    </div>
  </div>
  <p>内核编译系统会在产生 another_file.o 时将这里的 <code class="language-plaintext highlighter-rouge">-O0 -x ir</code> 传给编译器，这让编译器知道接下来要读的语言是 LLVM IR，并且关掉大部分优化（这样才能体现出自制编译器中的优化效果）。由于 LLVM IR 编译时会忽略一些选项，所以我让编译器在产生中间代码时就加上了属性来确保编译正确。</p>
  <p>虽然知道了怎么链接函数，但是内核是无法链接库函数的，而 IO 函数也无法直接在内核中使用。对此，我们可以修改相关的函数，在 tiktok 实现相似的功能。比如， <code class="language-plaintext highlighter-rouge">printf</code> 可以转换成 <code class="language-plaintext highlighter-rouge">printk</code>，而 <code class="language-plaintext highlighter-rouge">exit</code> 可以换成内核中的 <code class="language-plaintext highlighter-rouge">do_exit</code>。<code class="language-plaintext highlighter-rouge">malloc</code> 和 <code class="language-plaintext highlighter-rouge">free</code> 比较复杂，内核中的内存可没有进程那样退出就自动释放这么好的待遇。所以，在内核中必须得手动维护每一次分配和释放，避免出现事故导致 panic 或者内存泄漏（当然我很懒，课程不需要我就都没实现）。</p>
  <h2 id="一个小测试">一个小测试</h2>
  <p>既然实现完了，我们进行一个测试来检验 tiktok 的功能：</p>
  <div class="language-c highlighter-rouge">
    <div class="highlight">
      <pre class="highlight"><code><span class="cp">#define OUT_LOOP 100
</span><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">){</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">a</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">j</span><span class="p">;</span>

    <span class="n">a</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;</span> <span class="n">OUT_LOOP</span><span class="p">){</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">while</span><span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">1000000</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">a</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">j</span> <span class="o">=</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">a</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
    </div>
  </div>
  <p>上面是一段进行一些无意义计算的代码，我们修改 <code class="language-plaintext highlighter-rouge">OUT_LOOPS</code> 的大小（100、99、98）来比较不同方法的灵敏度。除了普通的 time 测量，我还加入了一组使用 <code class="language-plaintext highlighter-rouge">taskset(1)</code> 的对照组。 <code class="language-plaintext highlighter-rouge">taskset</code> 控制了程序的亲核性，这使得程序总能被调度到同一个核上，减少了跨核导致的缓存失效开销。为了减少随机误差，每种配置我都运行进行了 100 次函数得到虚列。实验数据可以在<a href="https://github.com/gloit042/tiktok/tree/main/bench">这里</a>查看。要反映灵敏度，我们无法直接拿不同方法的结果进行比较，而是要在同一个方法内看看能否显著区分出不同循环次数带来运行时间差距（约为 1%~%2）。短暂尝试了复习概率论和数理统计后，我谷歌到了 <a href="https://en.wikipedia.org/wiki/Kolmogorov%E2%80%93Smirnov_test">K-S 检验</a> （Kolmogorov-Smirnov test），对于两组输入数据它可以检验它们是否同分布。这里我们假设实际运行时间是固有的，而调度等开销造成的是一个均匀同分布的随机误差。如果测量工具对两种配置得到的两组数据无法拒绝同分布假设，我们可以认为它无法准确得检测出程序性能的差异（统计全忘光了，我不知道我在说啥，如果有误欢迎指正）。我使用了 <code class="language-plaintext highlighter-rouge">scipy.stat.kstest</code> 来进行了 K-S 检验，结果如下表 （p 值小于 0.05 拒绝同分布假设）：</p>
  <table>
    <thead>
      <tr>
        <th style="text-align: center">p 值</th>
        <th style="text-align: center">98-99</th>
        <th style="text-align: center">99-100</th>
        <th style="text-align: center">98-100</th>
        <th style="text-align: center">98-98</th>
        <th style="text-align: center">99-99</th>
        <th style="text-align: center">100-100</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td style="text-align: center">normal_time</td>
        <td style="text-align: center">$2.11*10^{-1}$</td>
        <td style="text-align: center">$5.83*10^{-1}$</td>
        <td style="text-align: center">$3.68*10^{-1}$</td>
        <td style="text-align: center">$3.6*10^{-2}$</td>
        <td style="text-align: center">$5.83*10^{-1}$</td>
        <td style="text-align: center">$1.29*10^{-3}$</td>
      </tr>
      <tr>
        <td style="text-align: center">taskset_time</td>
        <td style="text-align: center">$1.56*10^{-2}$</td>
        <td style="text-align: center">$2.11*10^{-1}$</td>
        <td style="text-align: center">$3.21*10^{-5}$</td>
        <td style="text-align: center">$8.15*10^{-1}$</td>
        <td style="text-align: center">$8.15*10^{-1}$</td>
        <td style="text-align: center">$2.4*10^{-2}$</td>
      </tr>
      <tr>
        <td style="text-align: center">tiktok</td>
        <td style="text-align: center">$3.73*10^{-36}$</td>
        <td style="text-align: center">$6.31*10^{-19}$</td>
        <td style="text-align: center">$2.6*10^{-38}$</td>
        <td style="text-align: center">$4.11*10^{-43}$</td>
        <td style="text-align: center">$1.41*10^{-28}$</td>
        <td style="text-align: center">$2.24*10^{-4}$</td>
      </tr>
    </tbody>
  </table>
  <p>gg，完全没有用，连同一个配置都分不清楚。虽然占据了一个核，但是虚拟机本身也在被调度，这个误差并不满足我们的假设。但是，还不能放弃，还可以抢救一下，我把 tiktok 放裸机上测试了一下，得到的结果如下：</p>
  <table>
    <thead>
      <tr>
        <th style="text-align: center">p 值</th>
        <th style="text-align: center">98-99</th>
        <th style="text-align: center">99-100</th>
        <th style="text-align: center">98-100</th>
        <th style="text-align: center">98-98</th>
        <th style="text-align: center">99-99</th>
        <th style="text-align: center">100-100</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td style="text-align: center">normal_time</td>
        <td style="text-align: center">$4.04*10^{-35}$</td>
        <td style="text-align: center">$2.82*10^{-1}$</td>
        <td style="text-align: center">$3.05*10^{-31}$</td>
        <td style="text-align: center">$8.15*10^{-1}$</td>
        <td style="text-align: center">$5.83*10^{-1}$</td>
        <td style="text-align: center">$1.54*10^{-1}$</td>
      </tr>
      <tr>
        <td style="text-align: center">taskset_time</td>
        <td style="text-align: center">$1.42*10^{-51}$</td>
        <td style="text-align: center">$3.64*10^{-2}$</td>
        <td style="text-align: center">$4.39*10^{-55}$</td>
        <td style="text-align: center">$5.39*10^{-1}$</td>
        <td style="text-align: center">$9.08*10^{-1}$</td>
        <td style="text-align: center">$2.11*10^{-1}$</td>
      </tr>
      <tr>
        <td style="text-align: center">tiktok</td>
        <td style="text-align: center">$2.20*10^{-59}$</td>
        <td style="text-align: center">$4.39*10^{-55}$</td>
        <td style="text-align: center">$2.20*10^{-59}$</td>
        <td style="text-align: center">$2.11*10^{-1}$</td>
        <td style="text-align: center">$7.02*10^{-1}$</td>
        <td style="text-align: center">$2.11*10^{-1}$</td>
      </tr>
    </tbody>
  </table>
  <p>在裸机上，tiktok 的优势就体现了出来，它比 <code class="language-plaintext highlighter-rouge">taskset</code> 要更加灵敏一点。然而裸机上使用 <code class="language-plaintext highlighter-rouge">perf stat</code>就可以看到更加精确的指令数结果…</p>
  <h2 id="小结">小结</h2>
  <p>虽然 tiktok 被证明没有太多实际价值，但是研究的过程中我还是学到了挺多 Linux 内核编译系统的知识。我想分享一下这个过程，是因为我觉得这很有趣。如果你对 tiktok 感兴趣，它在我的 <a href="https://github.com/gloit042/tiktok">Github</a> 上，它比本文介绍的要稍微复杂一丢丢。如果你想要了解更多关于 Linux 内核的内容，网络上有许多很好的资料。至于编译课程，我估计细小的差距是没法在虚拟机里准确测量了，还是要尽量避开这种测试样例（Windows 上应该也有工具，但是不太方便）。</p>
  ]]></content><author><name>gloit</name></author><category term="Technology" /><category term="Benchmark" /><category term="Kernel" /><category term="LLVM" /><summary type="html"><![CDATA[本学期，我担任了李诚老师编译原理课程的助教。在课程实验中，我们基于 LLVM 构建了一套编译系统，其中一个实验需要编写后端优化算法。为了评估学生们的优化代码，我们需要比较优化前后的代码（在这里是 LLVM IR）的性能。我们通过统计程序运行的时间来比较代码的性能，但是用户程序会受到内核调度。因为不是连续执行程序，所以受到调度造成的延迟会导致统计到的时间出现噪音，这些噪音可能会让测试结果不准确甚至影响到了同学们的分数。最开始，我想到是不是可以统计指令数来评估性能，打算用 perf stat 进行测试。然而，我们提供的实验环境基于虚拟机，VirtualBox 和 WSL 都没有实现相关的虚拟寄存器，要让同学们方便地使用该指令会比较困难，只得作罢。这时，我突然想到，内核线程可以不受到调度，那么使用内核线程是不是可以更精确的测量时间呢？于是我便开始了尝试。]]></summary></entry><entry><title type="html">使用 Beancount 进行记账并自动记录一卡通消费</title><link href="https://lug.ustc.edu.cn/planet/2020/08/keeping-account-with-beancount/" rel="alternate" type="text/html" title="使用 Beancount 进行记账并自动记录一卡通消费" /><published>2020-08-06T00:00:00+08:00</published><updated>2020-11-09T14:22:35+08:00</updated><id>https://lug.ustc.edu.cn/planet/2020/08/keeping-account-with-beancount</id><content type="html" xml:base="https://lug.ustc.edu.cn/planet/2020/08/keeping-account-with-beancount/"><![CDATA[<p>本文首发于 <a href="https://charlesliu7.github.io/blackboard/2019/07/24/beancount/">https://charlesliu7.github.io/blackboard/2019/07/24/beancount/</a></p>
  <p>偶尔看到了复式记账这个概念，对精细记账的我而言很受用，选择 Beancount 这样的开源工具的原因莫过于账本数据完全由自己掌握，而不是被各大 APP
    所保管。本文从一次个人实践的角度来说明一下复式记账的使用。</p>
  <p>本篇文章是一个从零开始的个人实践记录，涵盖 <strong>文件组织 -&gt; 基本账本书写 -&gt; 爬取一卡通数据并自动记录</strong>，供同样使用 Beancount
    的同学做参考，但此实践并不一定完全合乎其他人的使用习惯，如果有其它记录策略也是可以的。本文内容基于读者对复式记账和 Beancount
    语法有一定了解的情况下撰写的，关于复式记账的概念和一些诸多基本功能介绍，可以参考阅读以下文章：</p>
  <ul>
    <li><a href="https://plaintextaccounting.org/#comparisons">文本记账综述、复式记账开源工具比较</a></li>
    <li><a href="https://www.byvoid.com/zhs/blog/beancount-bookkeeping-1">Beancount 复式记账（一）：为什么</a></li>
  </ul>
  <p>开始！</p>
  <h2 id="安装使用">安装使用</h2>
  <p>Beancount 是一个 Python 实现的开源工具，在本地即可运行，首先从 PyPI 获取：</p>
  <div class="language-shell highlighter-rouge">
    <div class="highlight">
      <pre class="highlight"><code>pip <span class="nb">install </span>beancount fava
</code></pre>
    </div>
  </div>
  <p>其中 <code class="language-plaintext highlighter-rouge">beancount</code> 是核心包，包含核心的命令行工具；<code class="language-plaintext highlighter-rouge">fava</code> 是网页可视化工具。 <del>这里有一个<a href="https://fava.pythonanywhere.com/huge-example-file/balance_sheet/">fava
        示例账本</a> ，对应的
      Beancount 源代码可以在 <a href="https://bitbucket.org/blais/beancount/src/default/examples/">Bitbucket
        上下载</a>。</del>
    本文的示例账本以及可视化可以在该<a href="https://git.lug.ustc.edu.cn/Charles/ecard_beancount/-/tree/master">仓库</a>查看。</p>
  <p>克隆该仓库，在命令行中使用 <code class="language-plaintext highlighter-rouge">fava main.beancount</code>。</p>
  <div class="language-console highlighter-rouge">
    <div class="highlight">
      <pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>fava main.beancount
<span class="go">Running Fava on http://localhost:5000
</span></code></pre>
    </div>
  </div>
  <p>打开浏览器即可看到可视化账本。</p>
  <h2 id="文件结构">文件结构</h2>
  <p>Beancount 支持 <code class="language-plaintext highlighter-rouge">include</code> 语法来拓展账簿，个人采用按时间划分文件，辅之特殊事件（比如旅游）单独记录的方法，目录结构如下：</p>
  <div class="language-text highlighter-rouge">
    <div class="highlight">
      <pre class="highlight"><code>.
├── 2018
│   └── ...
├── 2019
│   └── 01.beancount
│   └── 02.beancount
│   └── 03.beancount
│   └── 04.beancount ; 注释用分号
│   └── xx.event.beancount ; 单独针对某一特别事件的账本，比如旅游
│   └── 05.beancount
│   └── 06.beancount
│   └── 07.beancount
├── accounts.beancount ; 记录初始账户信息
├── main.beancount ; 主文件
</code></pre>
    </div>
  </div>
  <h2 id="账本书写">账本书写</h2>
  <h3 id="账户信息设置">账户信息设置</h3>
  <p>首先要定义账户，即文件 <code class="language-plaintext highlighter-rouge">accounts.beancount</code>，Beancount 系统中预定义了五个分类：</p>
  <ul>
    <li>
      <p>Assets 资产：本人按照<code class="language-plaintext highlighter-rouge">账户类型:国家:金融机构名字:具体账户</code>的策略划分，时间是开户时间，比如：</p>
      <div class="language-conf highlighter-rouge">
        <div class="highlight">
          <pre class="highlight"><code><span class="m">2017</span>-<span class="m">01</span>-<span class="m">01</span> <span class="n">open</span> <span class="n">Assets</span>:<span class="n">CN</span>:<span class="n">Bank</span>:<span class="n">BoC</span>:<span class="n">C1234</span> <span class="n">CNY</span> ; 学校银行卡
<span class="m">2017</span>-<span class="m">01</span>-<span class="m">01</span> <span class="n">open</span> <span class="n">Assets</span>:<span class="n">CN</span>:<span class="n">Card</span>:<span class="n">USTC</span> <span class="n">CNY</span> ; 一卡通
<span class="m">2017</span>-<span class="m">01</span>-<span class="m">01</span> <span class="n">open</span> <span class="n">Assets</span>:<span class="n">CN</span>:<span class="n">Web</span>:<span class="n">AliPay</span> <span class="n">CNY</span> ; 支付宝
<span class="m">2017</span>-<span class="m">01</span>-<span class="m">01</span> <span class="n">open</span> <span class="n">Assets</span>:<span class="n">CN</span>:<span class="n">Web</span>:<span class="n">WeChatPay</span> <span class="n">CNY</span> ; 微信支付
</code></pre>
        </div>
    </div>
      <p>有一类针对 AA 付款或者个人向自己借款的账户，需要专门记录。</p>
      <div class="language-conf highlighter-rouge">
        <div class="highlight">
          <pre class="highlight"><code><span class="m">2017</span>-<span class="m">01</span>-<span class="m">01</span> <span class="n">open</span> <span class="n">Assets</span>:<span class="n">Receivables</span>:<span class="n">X</span> ; 对 <span class="n">X</span> 的应收款项
</code></pre>
        </div>
    </div>
    </li>
    <li>
      <p>Liabilities 负债：本人主要是信用卡和向他人借款的账户，比如：</p>
      <div class="language-conf highlighter-rouge">
        <div class="highlight">
          <pre class="highlight"><code><span class="m">2017</span>-<span class="m">01</span>-<span class="m">01</span> <span class="n">open</span> <span class="n">Liabilities</span>:<span class="n">Payable</span>:<span class="n">X</span> ; 对 <span class="n">X</span> 的债务
<span class="m">2017</span>-<span class="m">01</span>-<span class="m">01</span> <span class="n">open</span> <span class="n">Liabilities</span>:<span class="n">CreditCard</span>:<span class="n">CN</span>:<span class="n">BoC</span>:<span class="n">C1111</span> <span class="n">CNY</span> ; 信用卡
<span class="m">2017</span>-<span class="m">01</span>-<span class="m">01</span> <span class="n">open</span> <span class="n">Liabilities</span>:<span class="n">CreditCard</span>:<span class="n">CN</span>:<span class="n">Huabei</span> <span class="n">CNY</span> ; 花呗
</code></pre>
        </div>
    </div>
    </li>
    <li>
      <p>Equity 权益（净资产）：目前只有一个用于平衡开户的时候账户资金的权益。</p>
      <div class="language-conf highlighter-rouge">
        <div class="highlight">
          <pre class="highlight"><code><span class="m">1990</span>-<span class="m">01</span>-<span class="m">01</span> <span class="n">open</span> <span class="n">Equity</span>:<span class="n">Opening</span>-<span class="n">Balances</span>
</code></pre>
        </div>
    </div>
    </li>
    <li>
      <p>Expenses 支出：支出就非常的多样化，可以根据自己需求分门别类，比如：</p>
      <div class="language-conf highlighter-rouge">
        <div class="highlight">
          <pre class="highlight"><code><span class="m">2017</span>-<span class="m">01</span>-<span class="m">01</span> <span class="n">open</span> <span class="n">Expenses</span>:<span class="n">Clothing</span> ; 包括上衣，裤子和装饰，袜子，围巾，帽子
<span class="m">2017</span>-<span class="m">01</span>-<span class="m">01</span> <span class="n">open</span> <span class="n">Expenses</span>:<span class="n">Shoes</span> ; 鞋
<span class="m">2017</span>-<span class="m">01</span>-<span class="m">01</span> <span class="n">open</span> <span class="n">Expenses</span>:<span class="n">Food</span>:<span class="n">Dinner</span>
<span class="m">2017</span>-<span class="m">01</span>-<span class="m">01</span> <span class="n">open</span> <span class="n">Expenses</span>:<span class="n">Food</span>:<span class="n">Lunch</span>
<span class="m">2017</span>-<span class="m">01</span>-<span class="m">01</span> <span class="n">open</span> <span class="n">Expenses</span>:<span class="n">Food</span>:<span class="n">Breakfast</span>
<span class="m">2017</span>-<span class="m">01</span>-<span class="m">01</span> <span class="n">open</span> <span class="n">Expenses</span>:<span class="n">Food</span>:<span class="n">Fruits</span>
<span class="m">2017</span>-<span class="m">01</span>-<span class="m">01</span> <span class="n">open</span> <span class="n">Expenses</span>:<span class="n">Food</span>:<span class="n">Nightingale</span> ; 校门口夜宵
<span class="m">2017</span>-<span class="m">01</span>-<span class="m">01</span> <span class="n">open</span> <span class="n">Expenses</span>:<span class="n">Food</span>:<span class="n">Drinks</span>
<span class="m">2017</span>-<span class="m">01</span>-<span class="m">01</span> <span class="n">open</span> <span class="n">Expenses</span>:<span class="n">Food</span>:<span class="n">Snack</span> ; 杂食、零食
</code></pre>
        </div>
    </div>
      <p>等等……</p>
    </li>
    <li>
      <p>Income 收入：收入也可以根据自己的实际收入来源来建立账户，比如：</p>
      <div class="language-conf highlighter-rouge">
        <div class="highlight">
          <pre class="highlight"><code><span class="m">2017</span>-<span class="m">01</span>-<span class="m">01</span> <span class="n">open</span> <span class="n">Income</span>:<span class="n">Salary</span>:<span class="n">XXX</span>
<span class="m">2017</span>-<span class="m">01</span>-<span class="m">01</span> <span class="n">open</span> <span class="n">Income</span>:<span class="n">Salary</span>:<span class="n">Others</span>
<span class="m">2017</span>-<span class="m">01</span>-<span class="m">01</span> <span class="n">open</span> <span class="n">Income</span>:<span class="n">Others</span>
</code></pre>
        </div>
    </div>
    </li>
  </ul>
  <h3 id="主文件设置">主文件设置</h3>
  <p>然后设置主文件 <code class="language-plaintext highlighter-rouge">main.beancount</code> 内容，主文件任务是设置全局变量，然后去涵盖各个子账本：</p>
  <div class="language-conf highlighter-rouge">
    <div class="highlight">
      <pre class="highlight"><code><span class="n">option</span> <span class="s2">"title"</span> <span class="s2">"取个霸气的名字吧"</span> ; 账簿名称
<span class="n">option</span> <span class="s2">"operating_currency"</span> <span class="s2">"CNY"</span> ; 账簿主货币
<span class="n">option</span> <span class="s2">"operating_currency"</span> <span class="s2">"USD"</span> ; 可以添加多个主货币

<span class="n">include</span> <span class="s2">"accounts.beancount"</span> ; 包含账户信息

; 每个月的账本
<span class="n">include</span> <span class="s2">"2020/06.beancount"</span>
<span class="n">include</span> <span class="s2">"2020/07.beancount"</span>
</code></pre>
    </div>
  </div>
  <h3 id="账户初始余额设置">账户初始余额设置</h3>
  <p>在开始记账前，要设置每个账户的余额信息，采用以下方法来给每个账户设置余额/借记账单:</p>
  <div class="language-conf highlighter-rouge">
    <div class="highlight">
      <pre class="highlight"><code><span class="m">2019</span>-<span class="m">01</span>-<span class="m">01</span> <span class="n">pad</span> <span class="n">Assets</span>:<span class="n">Bank</span>:<span class="n">CN</span>:<span class="n">BoC</span>:<span class="n">C1111</span> <span class="n">Equity</span>:<span class="n">Opening</span>-<span class="n">Balances</span> ; 从 <span class="n">Opening</span>-<span class="n">Balances</span> 中划取 <span class="n">XX</span> 帐到银行卡中
<span class="m">2019</span>-<span class="m">01</span>-<span class="m">02</span> <span class="n">balance</span> <span class="n">Assets</span>:<span class="n">Bank</span>:<span class="n">CN</span>:<span class="n">BoC</span>:<span class="n">C1111</span>    +<span class="n">xxx</span>.<span class="n">xx</span> <span class="n">CNY</span> ; 银行卡余额为 <span class="n">xxx</span>.<span class="n">xx</span>
</code></pre>
    </div>
  </div>
  <p>该语句的含义是无论 <code class="language-plaintext highlighter-rouge">Assets:Bank:CN:BoC:C1111</code> 之前余额多少，在 2019 年 1 月 2 日开始之前都调整到 xxx.xx
    CNY，差额从 Equity:Opening-Balances 来。注意两行之间差一天的时间，<code class="language-plaintext highlighter-rouge">balance</code>
    断言界定为当天开始；一般储蓄卡余额为正，信用卡余额为负。</p>
  <h3 id="记账">记账</h3>
  <ul>
    <li>
      <p>基本记账，记账语法为：</p>
      <div class="language-text highlighter-rouge">
        <div class="highlight">
          <pre class="highlight"><code>YYYY-mm-dd * ["Payee"] "Narration"
  posting 1
  posting 2
  posting 3
  ...
</code></pre>
        </div>
    </div>
      <p>比如：</p>
      <div class="language-text highlighter-rouge">
        <div class="highlight">
          <pre class="highlight"><code>2019-01-01 * "Walmart" "在超市买两件衣服和晚餐"
  Expenses:Clothing 20 USD
  Expenses:Clothing 10 USD
  Expenses:Food:Dinner 10 USD
  Liabilities:CreditCard:US:Discover -40 USD
</code></pre>
        </div>
    </div>
    </li>
    <li>
      <p>多货币转换使用 <code class="language-plaintext highlighter-rouge">@@</code> 作为货币转换即可，货币 Beancount 会进行汇率计算，比如：</p>
      <div class="language-text highlighter-rouge">
        <div class="highlight">
          <pre class="highlight"><code>2019-01-01 * "日本航空" "纽约-东京"
  Expenses:Transport:Airline 1000 USD @@ 110000 JPY
  Liabilities:CreditCard:JP:Rakuten -110000 JPY
</code></pre>
        </div>
    </div>
    </li>
    <li>
      <p>账户结息：账户的利息肯定难以每日都记录，本人采用 <code class="language-plaintext highlighter-rouge">pad</code>+<code class="language-plaintext highlighter-rouge">balance</code> 断言，每隔一段时间结算一下。</p>
    </li>
    <li>
      <p>分期付款：这是个常见的购买方式，需要单独设置开一个 Liabilities Account，手续费记利息支出，每个月账单出现的时候转移一下。 Beancount 提供了一个<a href="https://beancount.github.io/fava/api/beancount.plugins.html">插件</a> <code class="language-plaintext highlighter-rouge">plugin "beancount.plugins.forecast</code> 专门用来处理分期、订阅情况，可以用于每月费用的自动生成。</p>
    </li>
  </ul>
  <h3 id="核账">核账</h3>
  <p>本人选择每个月还款日核实一下账本，在 Fava 左侧 <code class="language-plaintext highlighter-rouge">Balance Sheet</code> 或者 <code class="language-plaintext highlighter-rouge">Holdings</code>
    里可以看到各个账户当前的状况，如果和实际的账户金额有出入的话就需要点进对应账户查看每笔交易的情况，看看是否漏记或者错记。</p>
  <h2 id="用-importer-自动记录一卡通消费">用 Importer 自动记录一卡通消费</h2>
  <h3 id="综述">综述</h3>
  <p><code class="language-plaintext highlighter-rouge">Importer</code> 个人理解的作用是将整理好的账单文本转化为 Beancount 记录的形式，即格式化 (表格, JSON 等) 账单 -&gt; Importer -&gt;
    Beancount 记录，Importer 在其中起到一个消费记录格式转化作用。</p>
  <p>Beancount 作者对 Importer 有详细的文档叙述，即 <a href="http://furius.ca/beancount/doc/ingest">Importing External Data in
      Beancount</a>。Beancount 官方也有基于机器学习的智能
    importer
    <a href="https://github.com/beancount/smart_importer">beancount/smart_importer</a>。</p>
  <p>而本人的需求是：</p>
  <ol>
    <li>利用<a href="https://ecard.ustc.edu.cn/login">校园一卡通门户系统</a>获取每日的一卡通使用记录，并生成 <code class="language-plaintext highlighter-rouge">CSV</code> 记录。</li>
    <li>基于 <code class="language-plaintext highlighter-rouge">CSV</code> 的账单生成 <code class="language-plaintext highlighter-rouge">beancount</code> 文件。</li>
    <li>能够自行定制规则来实现对不同消费的分类。</li>
  </ol>
  <h3 id="将当日的一卡通消费生成为-csv">将当日的一卡通消费生成为 <code class="language-plaintext highlighter-rouge">CSV</code></h3>
  <p>爬取一卡通数据的代码为
    <a href="https://git.lug.ustc.edu.cn/Charles/ecard_beancount/-/blob/master/crawler.py">crawler.py</a>
    ，其作用为爬取当日的一卡通消费记录，并自定义规则区分早、午、晚餐，生成符合 Beancount 格式的 <code class="language-plaintext highlighter-rouge">CSV</code>。（代码可以直接运行）</p>
  <div class="language-python highlighter-rouge">
    <div class="highlight">
      <pre class="highlight"><code><span class="kn">import</span> <span class="n">requests</span>
<span class="kn">from</span> <span class="n">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="n">bs4</span> <span class="kn">import</span> <span class="n">BeautifulSoup</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">codecs</span>
<span class="kn">import</span> <span class="n">csv</span>

<span class="n">name</span> <span class="o">=</span> <span class="sh">'</span><span class="s">XXX</span><span class="sh">'</span>  <span class="c1"># 姓名
</span><span class="n">stu_no</span> <span class="o">=</span> <span class="sh">'</span><span class="s">PBXXXXXXXX</span><span class="sh">'</span>  <span class="c1"># 学号
</span><span class="n">pwd</span> <span class="o">=</span> <span class="sh">'</span><span class="s">user_pwd</span><span class="sh">'</span>  <span class="c1"># 统一身份认证密码
</span>
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">'</span><span class="s">__main__</span><span class="sh">'</span><span class="p">:</span>
    <span class="c1"># 利用统一身份认证登陆校园一卡通门户系统
</span>    <span class="n">casurl</span> <span class="o">=</span> <span class="sh">'</span><span class="s">https://passport.ustc.edu.cn/login?service=http%3A%2F%2Fecard.ustc.edu.cn%2Fcaslogin</span><span class="sh">'</span>
    <span class="n">caspost</span> <span class="o">=</span> <span class="p">{</span><span class="sh">'</span><span class="s">username</span><span class="sh">'</span><span class="p">:</span> <span class="n">stu_no</span><span class="p">,</span> <span class="sh">'</span><span class="s">password</span><span class="sh">'</span><span class="p">:</span> <span class="n">pwd</span><span class="p">}</span>  <span class="c1"># 统一身份认证
</span>    <span class="n">msg</span> <span class="o">=</span> <span class="sh">''</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">session</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="n">casurl</span><span class="p">,</span> <span class="n">caspost</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sh">'</span><span class="s">{0} - INFO: USTC ecard CAS登陆失败 {1}</span><span class="sh">'</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">datetime</span><span class="p">.</span><span class="nf">now</span><span class="p">().</span><span class="nf">strftime</span><span class="p">(</span><span class="sh">'</span><span class="s">%Y-%m-%d %H:%M:%S</span><span class="sh">'</span><span class="p">),</span> <span class="n">e</span><span class="p">)</span>
    <span class="n">remaining</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">r</span><span class="p">.</span><span class="n">text</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sh">'</span><span class="s">{0} - INFO: USTC ecard CAS登陆失败 NOOOOOOOO!!!!!!!!</span><span class="sh">'</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">datetime</span><span class="p">.</span><span class="nf">now</span><span class="p">().</span><span class="nf">strftime</span><span class="p">(</span><span class="sh">'</span><span class="s">%Y-%m-%d %H:%M:%S</span><span class="sh">'</span><span class="p">))</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sh">'</span><span class="s">{0} - INFO: USTC ecard CAS登陆成功</span><span class="sh">'</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">datetime</span><span class="p">.</span><span class="nf">now</span><span class="p">().</span><span class="nf">strftime</span><span class="p">(</span><span class="sh">'</span><span class="s">%Y-%m-%d %H:%M:%S</span><span class="sh">'</span><span class="p">))</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">paylist</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">https://ecard.ustc.edu.cn/paylist</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">b</span> <span class="o">=</span> <span class="nc">BeautifulSoup</span><span class="p">(</span><span class="n">paylist</span><span class="p">.</span><span class="n">text</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="sh">"</span><span class="s">lxml</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">b</span><span class="p">.</span><span class="nf">findAll</span><span class="p">(</span><span class="sh">'</span><span class="s">input</span><span class="sh">'</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="nf">get_attribute_list</span><span class="p">(</span><span class="sh">'</span><span class="s">value</span><span class="sh">'</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="sh">'</span><span class="s">https://ecard.ustc.edu.cn/paylist/ajax_get_paylist</span><span class="sh">'</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="sh">'</span><span class="s">date</span><span class="sh">'</span><span class="p">:</span> <span class="sh">''</span><span class="p">,</span> <span class="sh">'</span><span class="s">page</span><span class="sh">'</span><span class="p">:</span> <span class="sh">''</span><span class="p">},</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="sh">'</span><span class="s">origin</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">https://ecard.ustc.edu.cn</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">referer</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">https://ecard.ustc.edu.cn/paylist</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">sec-fetch-mode</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">cors</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">sec-fetch-site</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">same-origin</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">x-csrf-token</span><span class="sh">'</span><span class="p">:</span> <span class="n">token</span><span class="p">,</span> <span class="sh">'</span><span class="s">x-requested-with</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">XMLHttpRequest</span><span class="sh">'</span><span class="p">})</span>
        <span class="n">b</span> <span class="o">=</span> <span class="nc">BeautifulSoup</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">text</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="sh">"</span><span class="s">lxml</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">table</span> <span class="o">=</span> <span class="n">b</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="sh">'</span><span class="s">table</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">th_index</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">th</span> <span class="ow">in</span> <span class="n">table</span><span class="p">.</span><span class="nf">findAll</span><span class="p">(</span><span class="sh">'</span><span class="s">th</span><span class="sh">'</span><span class="p">):</span>
            <span class="n">th_index</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">th</span><span class="p">.</span><span class="nf">getText</span><span class="p">())</span>
        <span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">.</span><span class="nf">now</span><span class="p">().</span><span class="n">year</span><span class="p">,</span> <span class="n">datetime</span><span class="p">.</span><span class="nf">now</span><span class="p">().</span><span class="n">month</span><span class="p">,</span> <span class="n">datetime</span><span class="p">.</span><span class="nf">now</span><span class="p">().</span><span class="n">day</span>
        <span class="c1"># 根据自己定义的规则判定早餐、午餐、晚餐
</span>        <span class="n">payinfo</span> <span class="o">=</span> <span class="p">{</span><span class="sh">'</span><span class="s">breakfast</span><span class="sh">'</span><span class="p">:</span> <span class="p">{</span><span class="sh">'</span><span class="s">loc</span><span class="sh">'</span><span class="p">:</span> <span class="sh">''</span><span class="p">,</span> <span class="sh">'</span><span class="s">type</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">科大餐饮</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">value</span><span class="sh">'</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="p">},</span> <span class="sh">'</span><span class="s">lunch</span><span class="sh">'</span><span class="p">:</span> <span class="p">{</span><span class="sh">'</span><span class="s">loc</span><span class="sh">'</span><span class="p">:</span> <span class="sh">''</span><span class="p">,</span> <span class="sh">'</span><span class="s">type</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">科大餐饮</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">value</span><span class="sh">'</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="p">},</span> <span class="sh">'</span><span class="s">dinner</span><span class="sh">'</span><span class="p">:</span> <span class="p">{</span><span class="sh">'</span><span class="s">loc</span><span class="sh">'</span><span class="p">:</span> <span class="sh">''</span><span class="p">,</span> <span class="sh">'</span><span class="s">type</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">科大餐饮</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">value</span><span class="sh">'</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="p">},</span> <span class="sh">'</span><span class="s">transferin</span><span class="sh">'</span><span class="p">:</span> <span class="p">{</span><span class="sh">'</span><span class="s">loc</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">一卡通充值</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">type</span><span class="sh">'</span><span class="p">:</span> <span class="sh">''</span><span class="p">,</span> <span class="sh">'</span><span class="s">value</span><span class="sh">'</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="p">}</span> <span class="p">}</span>
        <span class="n">flag</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">table</span><span class="p">.</span><span class="nf">findAll</span><span class="p">(</span><span class="sh">'</span><span class="s">tr</span><span class="sh">'</span><span class="p">):</span>
            <span class="n">line</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">td</span> <span class="ow">in</span> <span class="n">tr</span><span class="p">.</span><span class="nf">findAll</span><span class="p">(</span><span class="sh">'</span><span class="s">td</span><span class="sh">'</span><span class="p">):</span>
                <span class="n">line</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">td</span><span class="p">.</span><span class="nf">getText</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">line</span> <span class="ow">and</span> <span class="n">flag</span><span class="p">:</span>
                <span class="n">remaining</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
                <span class="n">flag</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">elif</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sh">'</span><span class="s">圈存机充值</span><span class="sh">'</span> <span class="ow">and</span> <span class="nf">int</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">payinfo</span><span class="p">[</span><span class="sh">'</span><span class="s">transferin</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">value</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sh">'</span><span class="s">消费</span><span class="sh">'</span><span class="p">:</span>
                <span class="n">linetime</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">.</span><span class="nf">strptime</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="sh">'</span><span class="s">%Y-%m-%d %H:%M:%S</span><span class="sh">'</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">linetime</span> <span class="o">&gt;</span> <span class="nf">datetime</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> <span class="ow">and</span> <span class="n">linetime</span> <span class="o">&lt;</span> <span class="nf">datetime</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span> <span class="mi">10</span><span class="p">):</span> <span class="c1"># 判定为早餐
</span>                    <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="ow">in</span> <span class="n">payinfo</span><span class="p">[</span><span class="sh">'</span><span class="s">breakfast</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">loc</span><span class="sh">'</span><span class="p">]:</span>
                        <span class="k">pass</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">payinfo</span><span class="p">[</span><span class="sh">'</span><span class="s">breakfast</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">loc</span><span class="sh">'</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">+</span> <span class="sh">'</span><span class="s"> </span><span class="sh">'</span><span class="p">)</span>
                    <span class="n">payinfo</span><span class="p">[</span><span class="sh">'</span><span class="s">breakfast</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">value</span><span class="sh">'</span><span class="p">]</span> <span class="o">+=</span> <span class="nf">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
                <span class="k">elif</span> <span class="n">linetime</span> <span class="o">&gt;</span> <span class="nf">datetime</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="ow">and</span> <span class="n">linetime</span> <span class="o">&lt;</span> <span class="nf">datetime</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span> <span class="mi">14</span><span class="p">):</span> <span class="c1"># 判定为午餐
</span>                    <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="ow">in</span> <span class="n">payinfo</span><span class="p">[</span><span class="sh">'</span><span class="s">lunch</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">loc</span><span class="sh">'</span><span class="p">]:</span>
                        <span class="k">pass</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">payinfo</span><span class="p">[</span><span class="sh">'</span><span class="s">lunch</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">loc</span><span class="sh">'</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">+</span> <span class="sh">'</span><span class="s"> </span><span class="sh">'</span><span class="p">)</span>
                    <span class="n">payinfo</span><span class="p">[</span><span class="sh">'</span><span class="s">lunch</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">value</span><span class="sh">'</span><span class="p">]</span> <span class="o">+=</span> <span class="nf">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
                <span class="k">elif</span> <span class="n">linetime</span> <span class="o">&gt;</span> <span class="nf">datetime</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span> <span class="ow">and</span> <span class="n">linetime</span> <span class="o">&lt;</span> <span class="nf">datetime</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span> <span class="mi">20</span><span class="p">):</span> <span class="c1"># 判定为晚餐
</span>                    <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="ow">in</span> <span class="n">payinfo</span><span class="p">[</span><span class="sh">'</span><span class="s">dinner</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">loc</span><span class="sh">'</span><span class="p">]:</span>
                        <span class="k">pass</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">payinfo</span><span class="p">[</span><span class="sh">'</span><span class="s">dinner</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">loc</span><span class="sh">'</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">+</span> <span class="sh">'</span><span class="s"> </span><span class="sh">'</span><span class="p">)</span>
                    <span class="n">payinfo</span><span class="p">[</span><span class="sh">'</span><span class="s">dinner</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">value</span><span class="sh">'</span><span class="p">]</span> <span class="o">+=</span> <span class="nf">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
                <span class="k">elif</span> <span class="n">linetime</span> <span class="o">&lt;</span> <span class="nf">datetime</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">mtmp</span> <span class="o">=</span> <span class="sh">'</span><span class="s">{0} - INFO: 未知消费 {1}</span><span class="sh">'</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">datetime</span><span class="p">.</span><span class="nf">now</span><span class="p">().</span><span class="nf">strftime</span><span class="p">(</span><span class="sh">'</span><span class="s">%Y-%m-%d %H:%M:%S</span><span class="sh">'</span><span class="p">),</span> <span class="n">line</span><span class="p">)</span>
                    <span class="nf">print</span><span class="p">(</span><span class="n">mtmp</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mtmp</span> <span class="o">=</span> <span class="sh">'</span><span class="s">{0} - INFO: 异常消费 {1}</span><span class="sh">'</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">datetime</span><span class="p">.</span><span class="nf">now</span><span class="p">().</span><span class="nf">strftime</span><span class="p">(</span><span class="sh">'</span><span class="s">%Y-%m-%d %H:%M:%S</span><span class="sh">'</span><span class="p">),</span> <span class="n">line</span><span class="p">)</span>
                <span class="nf">print</span><span class="p">(</span><span class="n">mtmp</span><span class="p">)</span>
        <span class="n">mtmp</span> <span class="o">=</span> <span class="sh">'</span><span class="s">{0} - INFO: 卡内余额 {1}</span><span class="sh">'</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span>
            <span class="n">datetime</span><span class="p">.</span><span class="nf">now</span><span class="p">().</span><span class="nf">strftime</span><span class="p">(</span><span class="sh">'</span><span class="s">%Y-%m-%d %H:%M:%S</span><span class="sh">'</span><span class="p">),</span> <span class="n">remaining</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">mtmp</span><span class="p">)</span>

        <span class="c1"># CSV Part
</span>        <span class="n">today</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">.</span><span class="nf">now</span><span class="p">().</span><span class="nf">strftime</span><span class="p">(</span><span class="sh">'</span><span class="s">%Y-%m-%d</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="p">[</span><span class="sh">'</span><span class="s">记账日期</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">收款人</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">交易摘要</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">人民币金额</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">类别</span><span class="sh">'</span><span class="p">]</span>
        <span class="n">csvinfo</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">payinfo</span><span class="p">[</span><span class="sh">'</span><span class="s">transferin</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">value</span><span class="sh">'</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">csvinfo</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="n">headers</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">today</span><span class="p">,</span> <span class="n">headers</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="n">payinfo</span><span class="p">[</span><span class="sh">'</span><span class="s">transferin</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">type</span><span class="sh">'</span><span class="p">],</span> <span class="n">headers</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="n">payinfo</span><span class="p">[</span><span class="sh">'</span><span class="s">transferin</span><span class="sh">'</span><span class="p">]</span>
                            <span class="p">[</span><span class="sh">'</span><span class="s">loc</span><span class="sh">'</span><span class="p">],</span> <span class="n">headers</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span> <span class="sh">"</span><span class="s">%.2f</span><span class="sh">"</span> <span class="o">%</span> <span class="o">-</span><span class="n">payinfo</span><span class="p">[</span><span class="sh">'</span><span class="s">transferin</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">value</span><span class="sh">'</span><span class="p">],</span> <span class="n">headers</span><span class="p">[</span><span class="mi">4</span><span class="p">]:</span> <span class="sh">'</span><span class="s">Transferin</span><span class="sh">'</span><span class="p">})</span>
        <span class="k">if</span> <span class="n">payinfo</span><span class="p">[</span><span class="sh">'</span><span class="s">breakfast</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">value</span><span class="sh">'</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">csvinfo</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="n">headers</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">today</span><span class="p">,</span> <span class="n">headers</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="n">payinfo</span><span class="p">[</span><span class="sh">'</span><span class="s">breakfast</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">type</span><span class="sh">'</span><span class="p">],</span> <span class="n">headers</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="n">payinfo</span><span class="p">[</span><span class="sh">'</span><span class="s">breakfast</span><span class="sh">'</span><span class="p">]</span>
                            <span class="p">[</span><span class="sh">'</span><span class="s">loc</span><span class="sh">'</span><span class="p">],</span> <span class="n">headers</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span> <span class="sh">"</span><span class="s">%.2f</span><span class="sh">"</span> <span class="o">%</span> <span class="n">payinfo</span><span class="p">[</span><span class="sh">'</span><span class="s">breakfast</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">value</span><span class="sh">'</span><span class="p">],</span> <span class="n">headers</span><span class="p">[</span><span class="mi">4</span><span class="p">]:</span> <span class="sh">'</span><span class="s">Breakfast</span><span class="sh">'</span><span class="p">})</span>
        <span class="k">if</span> <span class="n">payinfo</span><span class="p">[</span><span class="sh">'</span><span class="s">lunch</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">value</span><span class="sh">'</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">csvinfo</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="n">headers</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">today</span><span class="p">,</span> <span class="n">headers</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="n">payinfo</span><span class="p">[</span><span class="sh">'</span><span class="s">lunch</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">type</span><span class="sh">'</span><span class="p">],</span> <span class="n">headers</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="n">payinfo</span><span class="p">[</span><span class="sh">'</span><span class="s">lunch</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">loc</span><span class="sh">'</span><span class="p">],</span> <span class="n">headers</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span> <span class="sh">"</span><span class="s">%.2f</span><span class="sh">"</span> <span class="o">%</span> <span class="n">payinfo</span><span class="p">[</span><span class="sh">'</span><span class="s">lunch</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">value</span><span class="sh">'</span><span class="p">],</span> <span class="n">headers</span><span class="p">[</span><span class="mi">4</span><span class="p">]:</span> <span class="sh">'</span><span class="s">Lunch</span><span class="sh">'</span><span class="p">})</span>
        <span class="k">if</span> <span class="n">payinfo</span><span class="p">[</span><span class="sh">'</span><span class="s">dinner</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">value</span><span class="sh">'</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">csvinfo</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="n">headers</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">today</span><span class="p">,</span> <span class="n">headers</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="n">payinfo</span><span class="p">[</span><span class="sh">'</span><span class="s">dinner</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">type</span><span class="sh">'</span><span class="p">],</span> <span class="n">headers</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="n">payinfo</span><span class="p">[</span><span class="sh">'</span><span class="s">dinner</span><span class="sh">'</span><span class="p">]</span>
                            <span class="p">[</span><span class="sh">'</span><span class="s">loc</span><span class="sh">'</span><span class="p">],</span> <span class="n">headers</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span> <span class="sh">"</span><span class="s">%.2f</span><span class="sh">"</span> <span class="o">%</span> <span class="n">payinfo</span><span class="p">[</span><span class="sh">'</span><span class="s">dinner</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">value</span><span class="sh">'</span><span class="p">],</span> <span class="n">headers</span><span class="p">[</span><span class="mi">4</span><span class="p">]:</span> <span class="sh">'</span><span class="s">Dinner</span><span class="sh">'</span><span class="p">})</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">today</span><span class="o">+</span><span class="sh">'</span><span class="s">.csv</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">w</span><span class="sh">'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f_csv</span> <span class="o">=</span> <span class="n">csv</span><span class="p">.</span><span class="nc">DictWriter</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>
            <span class="n">f_csv</span><span class="p">.</span><span class="nf">writeheader</span><span class="p">()</span>
            <span class="n">f_csv</span><span class="p">.</span><span class="nf">writerows</span><span class="p">(</span><span class="n">csvinfo</span><span class="p">)</span>
</code></pre>
    </div>
  </div>
  <p>代码执行完毕后会生成 <code class="language-plaintext highlighter-rouge">20XX-XX-XX.csv</code>，例如 <code class="language-plaintext highlighter-rouge">2020-07-02.csv</code>：</p>
  <table>
    <thead>
      <tr>
        <th>记账日期</th>
        <th>收款人</th>
        <th>交易摘要</th>
        <th>人民币金额</th>
        <th>类别</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>2020-07-02</td>
        <td>科大餐饮</td>
        <td>一卡通充值</td>
        <td>-200.00</td>
        <td>Transferin</td>
      </tr>
      <tr>
        <td>2020-07-02</td>
        <td>科大餐饮</td>
        <td>西区芳华园餐厅</td>
        <td>5.00</td>
        <td>Breakfast</td>
      </tr>
      <tr>
        <td>2020-07-02</td>
        <td>科大餐饮</td>
        <td>西区芳华园餐厅</td>
        <td>10.00</td>
        <td>Lunch</td>
      </tr>
      <tr>
        <td>2020-07-02</td>
        <td>科大餐饮</td>
        <td>西区芳华园餐厅</td>
        <td>10.00</td>
        <td>Dinner</td>
      </tr>
    </tbody>
  </table>
  <h3 id="准备-importer-config">准备 Importer Config</h3>
  <p>Beancount Importer Config 文件为
    <a href="https://git.lug.ustc.edu.cn/Charles/ecard_beancount/-/blob/master/importers/ustc_card_importer.py">importers/ustc_card_importer.py</a>。</p>
  <div class="language-python highlighter-rouge">
    <div class="highlight">
      <pre class="highlight"><code><span class="c1">#!/usr/bin/env python
</span><span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">sys</span>
<span class="kn">import</span> <span class="n">beancount.ingest.extract</span>
<span class="kn">from</span> <span class="n">beancount.ingest.importers</span> <span class="kn">import</span> <span class="n">csv</span>

<span class="n">beancount</span><span class="p">.</span><span class="n">ingest</span><span class="p">.</span><span class="n">extract</span><span class="p">.</span><span class="n">HEADER</span> <span class="o">=</span> <span class="sh">''</span>

<span class="k">def</span> <span class="nf">dumb_USTCecard_categorizer</span><span class="p">(</span><span class="n">txn</span><span class="p">):</span>
    <span class="c1"># At this time the txn has only one posting
</span>    <span class="k">try</span><span class="p">:</span>
        <span class="n">posting1</span> <span class="o">=</span> <span class="n">txn</span><span class="p">.</span><span class="n">postings</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">except</span> <span class="nb">IndexError</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">txn</span>

    <span class="c1"># Guess the account(s) of the other posting(s)
</span>    <span class="k">if</span> <span class="sh">'</span><span class="s">breakfast</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">txn</span><span class="p">.</span><span class="n">narration</span><span class="p">.</span><span class="nf">lower</span><span class="p">():</span>
        <span class="n">account</span> <span class="o">=</span> <span class="sh">'</span><span class="s">Expenses:Food:Breakfast</span><span class="sh">'</span>
    <span class="k">elif</span> <span class="sh">'</span><span class="s">lunch</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">txn</span><span class="p">.</span><span class="n">narration</span><span class="p">.</span><span class="nf">lower</span><span class="p">():</span>
        <span class="n">account</span> <span class="o">=</span> <span class="sh">'</span><span class="s">Expenses:Food:Lunch</span><span class="sh">'</span>
    <span class="k">elif</span> <span class="sh">'</span><span class="s">dinner</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">txn</span><span class="p">.</span><span class="n">narration</span><span class="p">.</span><span class="nf">lower</span><span class="p">():</span>
        <span class="n">account</span> <span class="o">=</span> <span class="sh">'</span><span class="s">Expenses:Food:Dinner</span><span class="sh">'</span>
    <span class="k">elif</span> <span class="sh">'</span><span class="s">transferin</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">txn</span><span class="p">.</span><span class="n">narration</span><span class="p">.</span><span class="nf">lower</span><span class="p">():</span>
        <span class="n">account</span> <span class="o">=</span> <span class="sh">'</span><span class="s">Assets:CN:Bank:BoC:C1234</span><span class="sh">'</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">txn</span>
    <span class="c1"># Make the other posting(s)
</span>    <span class="n">posting2</span> <span class="o">=</span> <span class="n">posting1</span><span class="p">.</span><span class="nf">_replace</span><span class="p">(</span>
        <span class="n">account</span><span class="o">=</span><span class="n">account</span><span class="p">,</span>
        <span class="n">units</span><span class="o">=-</span><span class="n">posting1</span><span class="p">.</span><span class="n">units</span>
    <span class="p">)</span>
    <span class="c1"># Insert / Append the posting into the transaction
</span>    <span class="k">if</span> <span class="n">posting1</span><span class="p">.</span><span class="n">units</span> <span class="o">&lt;</span> <span class="n">posting2</span><span class="p">.</span><span class="n">units</span><span class="p">:</span>
        <span class="n">txn</span><span class="p">.</span><span class="n">postings</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">posting2</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">txn</span><span class="p">.</span><span class="n">postings</span><span class="p">.</span><span class="nf">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">posting2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">txn</span>

<span class="n">CONFIG</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c1"># USTC canteen
</span>    <span class="n">csv</span><span class="p">.</span><span class="nc">Importer</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="n">csv</span><span class="p">.</span><span class="n">Col</span><span class="p">.</span><span class="n">DATE</span><span class="p">:</span> <span class="sh">'</span><span class="s">记账日期</span><span class="sh">'</span><span class="p">,</span>
            <span class="n">csv</span><span class="p">.</span><span class="n">Col</span><span class="p">.</span><span class="n">PAYEE</span><span class="p">:</span> <span class="sh">'</span><span class="s">收款人</span><span class="sh">'</span><span class="p">,</span>
            <span class="n">csv</span><span class="p">.</span><span class="n">Col</span><span class="p">.</span><span class="n">NARRATION1</span><span class="p">:</span> <span class="sh">'</span><span class="s">交易摘要</span><span class="sh">'</span><span class="p">,</span>
            <span class="n">csv</span><span class="p">.</span><span class="n">Col</span><span class="p">.</span><span class="n">AMOUNT_DEBIT</span><span class="p">:</span> <span class="sh">'</span><span class="s">人民币金额</span><span class="sh">'</span><span class="p">,</span>
            <span class="n">csv</span><span class="p">.</span><span class="n">Col</span><span class="p">.</span><span class="n">NARRATION2</span><span class="p">:</span> <span class="sh">'</span><span class="s">类别</span><span class="sh">'</span>
        <span class="p">},</span>
        <span class="n">account</span><span class="o">=</span><span class="sh">'</span><span class="s">Assets:CN:Card:USTC</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">currency</span><span class="o">=</span><span class="sh">'</span><span class="s">CNY</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">categorizer</span><span class="o">=</span><span class="n">dumb_USTCecard_categorizer</span><span class="p">,</span>
    <span class="p">),</span>
<span class="p">]</span>
</code></pre>
    </div>
  </div>
  <p>语法说明参见 <a href="https://charlesliu7.github.io/blackboard/2019/12/03/beancount-importer/">Beancount 系列二： Importer
      设置</a>。</p>
  <p>执行命令生成 beancount 账单。</p>
  <div class="language-shell highlighter-rouge">
    <div class="highlight">
      <pre class="highlight"><code>bean-extract ustc_card_importer.py 2020-07-02.csv
</code></pre>
    </div>
  </div>
  <p>得到账单：</p>
  <div class="language-text highlighter-rouge">
    <div class="highlight">
      <pre class="highlight"><code>**** /path/to/2020-07-02.csv

2020-07-02 * "科大餐饮" "一卡通充值; Transferin"
    Assets:CN:Card:USTC        200.00 CNY
    Assets:CN:Bank:BoC:C1234  -200.00 CNY

2020-07-02 * "科大餐饮" "西区芳华园餐厅; Breakfast"
    Assets:CN:Card:USTC      -5.00 CNY
    Expenses:Food:Breakfast   5.00 CNY

2020-07-02 * "科大餐饮" "西区芳华园餐厅; Lunch"
    Assets:CN:Card:USTC  -10.00 CNY
    Expenses:Food:Lunch   10.00 CNY

2020-07-02 * "科大餐饮" "西区芳华园餐厅; Dinner"
    Assets:CN:Card:USTC   -10.00 CNY
    Expenses:Food:Dinner   10.00 CNY
</code></pre>
    </div>
  </div>
  <p>校园卡消费可以直接使用该 importer。支付宝账单、信用卡账单等也可以通过导出 CSV 账单的方式利用自己编写的 importer 导入。</p>
  <h3 id="自动化">自动化</h3>
  <p>上述过程需要执行多个命令和脚本，利用 <code class="language-plaintext highlighter-rouge">crontab</code> 在每日睡前 (23:30) 执行一遍代码即可自动化记录消费。</p>
  <div class="language-shell highlighter-rouge">
    <div class="highlight">
      <pre class="highlight"><code><span class="nv">$ </span>python crawler.py&gt;&gt;log.log
<span class="nv">$ </span><span class="nb">cd </span>importers
<span class="nv">$ </span>python ustc_card_importer_pipeline.py <span class="c"># 注意这里需要修改要记录的账本文件</span>
</code></pre>
    </div>
  </div>
  <p>Done!</p>
  <h2 id="fava">Fava</h2>
  <ul>
    <li>Fava 可视化网页中提供了编辑功能，对于多文件的编辑，默认打开的是主文件，要想修改编辑器默认打开的文件，需将 <code class="language-plaintext highlighter-rouge">2019-07-11 custom "fava-option" "default-file"</code> 这个设置放在想要设定的文件里。</li>
    <li>Fava 系统中也提供了添加记录的功能，但添加的记录默认写入了主文件里，根据<a href="https://github.com/beancount/fava/issues/875">Fava insert-entry options</a>, <a href="https://github.com/beancount/fava/issues/882">default-file could also set the insertion file</a> 作者似乎不 care 添加在哪个文件里这个问题，但依然可以利用 <code class="language-plaintext highlighter-rouge">insert-entry</code> 关键字变相设置一下，比如将 <code class="language-plaintext highlighter-rouge">2019-01-01 custom "fava-option" "insert-entry" ".*"</code> 断言写在 <code class="language-plaintext highlighter-rouge">2019/01.bean</code> 文件的末尾，所有在 2019-01-01 之后的记录，通过 Fava 添加记录的话，该记录会 write 在这个断言之前。</li>
    <li>Fava 是不带有密码功能的，根据 <a href="https://github.com/beancount/fava/issues/314">Make fava password-protected</a> 作者认为这不应该是 Fava 应该做的工作；利用 <a href="https://www.digitalocean.com/community/tutorials/how-to-set-up-password-authentication-with-apache-on-ubuntu-16-04?comment=76154">Apache</a> 或者 <a href="https://docs.nginx.com/nginx/admin-guide/security-controls/configuring-http-basic-authentication/">Nginx</a> 的认证功能可以满足这个需求。</li>
    <li>
      <p>可视化工具 Fava 也支持 Importer，可以通过设置：</p>
      <div class="language-conf highlighter-rouge">
        <div class="highlight">
          <pre class="highlight"><code><span class="m">2017</span>-<span class="m">01</span>-<span class="m">01</span> <span class="n">custom</span> <span class="s2">"fava-option"</span> <span class="s2">"import-config"</span> <span class="s2">"./importers/path/to/importer.py"</span>
<span class="m">2017</span>-<span class="m">01</span>-<span class="m">01</span> <span class="n">custom</span> <span class="s2">"fava-option"</span> <span class="s2">"import-dirs"</span> <span class="s2">"./importers/path/to/csv_tmp/"</span>
</code></pre>
        </div>
    </div>
      <p>在 Fava 界面侧栏看到 Importer，并手动导入数据。注 ：Importer 在 Fava 中使用的时候 metadata 会被去除。</p>
    </li>
    <li>
      <p>Fava 还支持自定义 side bar link，即：</p>
      <div class="language-conf highlighter-rouge">
        <div class="highlight">
          <pre class="highlight"><code><span class="m">2099</span>-<span class="m">01</span>-<span class="m">01</span> <span class="n">custom</span> <span class="s2">"fava-sidebar-link"</span> <span class="s2">"This Week"</span> <span class="s2">"/jump?time=day-6+-+day"</span>
<span class="m">2099</span>-<span class="m">01</span>-<span class="m">01</span> <span class="n">custom</span> <span class="s2">"fava-sidebar-link"</span> <span class="s2">"This Month"</span> <span class="s2">"/jump?time=month"</span>
<span class="m">2099</span>-<span class="m">01</span>-<span class="m">01</span> <span class="n">custom</span> <span class="s2">"fava-sidebar-link"</span> <span class="s2">"3 Month"</span> <span class="s2">"/jump?time=month-1+-+month%2B1"</span>
<span class="m">2099</span>-<span class="m">01</span>-<span class="m">01</span> <span class="n">custom</span> <span class="s2">"fava-sidebar-link"</span> <span class="s2">"Year-To-Date"</span> <span class="s2">"/jump?time=year+-+month"</span>
<span class="m">2099</span>-<span class="m">01</span>-<span class="m">01</span> <span class="n">custom</span> <span class="s2">"fava-sidebar-link"</span> <span class="s2">"All dates"</span> <span class="s2">"/jump?time="</span>
</code></pre>
        </div>
    </div>
    </li>
  </ul>
  ]]></content><author><name>Xenon</name></author><category term="USTC" /><category term="Beancount" /><category term="eCard" /><summary type="html"><![CDATA[本文首发于 https://charlesliu7.github.io/blackboard/2019/07/24/beancount/]]></summary></entry><entry><title type="html">【译稿】树莓派 4 评测与基准测试：与树莓派 3B+ 相比的改进</title><link href="https://lug.ustc.edu.cn/planet/2019/09/raspberry-4/" rel="alternate" type="text/html" title="【译稿】树莓派 4 评测与基准测试：与树莓派 3B+ 相比的改进" /><published>2019-09-17T00:00:00+08:00</published><updated>2020-11-09T14:22:35+08:00</updated><id>https://lug.ustc.edu.cn/planet/2019/09/raspberry-4</id><content type="html" xml:base="https://lug.ustc.edu.cn/planet/2019/09/raspberry-4/"><![CDATA[<p>原文地址：https://ibugone.com/blog/2019/09/raspberry-pi-4-review-benchmark/，作者为 @iBug 同学。以下为翻译部分。</p>
  <hr />
  <p>前段时间，我终于拿到了自己心念的树莓派 4（4 GB 的型号），之后我就忍不住试了试，看看它在报道中提到的改进与提升究竟是什么样子的。</p>
  <p>我自己的树莓派 3B+ 有个外壳，所以这次购买树莓派 4 的同时，我也订了个铝制的外壳，以减轻发热给树莓派带来的压力。与之前的外壳不同的是，它还配备了两个小风扇，能够大幅度提高散热效率。</p>
  <p>就让我们来看一看吧。</p>
  <h2 id="概览">概览</h2>
  <figure class="third ">
    <a href="/static/planet/box.jpg" title="Package of Raspberry Pi 4">
      <img src="/static/planet/box.jpg" alt="Package of Raspberry Pi 4" />
    </a>
    <a href="/static/planet/box-bottom.jpg" title="Bottom of the package">
      <img src="/static/planet/box-bottom.jpg" alt="Bottom of the package" />
    </a>
    <a href="/static/planet/box-open-1024x768.jpg" title="Opening the package">
      <img src="/static/planet/box-open-1024x768.jpg" alt="The package is open" />
    </a>
  </figure>
  <p>新的树莓派 4 装在了类似 3B+ 的包装中，包装正面是树莓派 4 的红底白线的结构图，与本体大小相同。与树莓派 3B 不同的是，3B+ 和 4 都没有用防静电袋包好。当然，这不是什么问题。</p>
  <p>它的结构与前几代类似，不过有一些明显的变化。比如说，你肯定会最先注意到那几个 USB 3.0 接口——因为它们是蓝色的。在你观察那几个接口的同时，你很可能也注意到了，有可能是因为千兆网口的升级的缘故，以太网接口换了位置。</p>
  <figure class="third ">
    <a href="/static/planet/overview.jpg" title="Overview of Raspberry Pi 4">
      <img src="/static/planet/overview.jpg" alt="Overview of Raspberry Pi 4" />
    </a>
    <a href="/static/planet/overview-usb.jpg" title="The USB ports and the Ethernet port">
      <img src="/static/planet/overview-usb.jpg" alt="Raspberry Pi 4 on top of the box, showing the USB ports and the Ethernet port" />
    </a>
    <a href="/static/planet/overview-side-ports.jpg" title="The USB Type-C port and the HDMI ports">
      <img src="/static/planet/overview-side-ports.jpg" alt="Focusing on the USB Type-C port and the HDMI ports" />
    </a>
  </figure>
  <p>有一些小接口，即供电口和视频输出，也有一些变化。树莓派 4 现在需要一根 Type-C 线供电，并且需求提升到了 5V / 3A。目前尚且不知树莓派 4 是否支持类似于高通快充或者 USB PD 这样的快充技术，但是从用户反馈来看，是没有的。旧款上标准大小的 HDMI 也被 micro-HDMI 口替换——而且变成了两个：它们都支持 4K 60fps 输出，而且可以同时输出！尽管我打算把树莓派当无头（无显示的）服务器来用，用树莓派配桌面环境的人可能会喜欢这个特性。</p>
  <p>内存条也从树莓派的背面移到了正面，现在在 SoC 旁边。SoC 长得和 3B+ 的一样，但是内部却完全不同。Wi-Fi 屏蔽罩和天线没有变化，另外在千兆网口的前面又多出了一个额外的芯片。</p>
  <h2 id="参数">参数</h2>
  <p>新的树莓派 4 带来了大量激动人心的更新，包括了：</p>
  <ul>
    <li>博通 BCM2711 SoC, 四核 1.5 GHz Cortex-A72 CPU</li>
    <li>有 1 GB, 2GB 和 4 GB RAM 四种版本（4 GB 就是我手中的这款）</li>
    <li>博通 VideoCore VI GPU</li>
    <li>真正的千兆以太网口</li>
    <li>蓝牙 5.0</li>
    <li>原生 USB 3.0 支持，包含了 2 个 Type-A 的接口</li>
    <li>双 HDMI 口，支持同时 4K 60fps 输出</li>
    <li>更快的 microSD 卡插槽</li>
  </ul>
  <p>在之后的基准测试中，你可以看到这些更新参数意味着什么。以下是一张对比表：</p>
  <table>
    <thead>
      <tr>
        <th> </th>
        <th style="text-align: center">树莓派 3B</th>
        <th style="text-align: center">树莓派 3B+</th>
        <th style="text-align: center">树莓派 4</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>CPU</td>
        <td style="text-align: center">四核 1.20 GHz Cortex-A53</td>
        <td style="text-align: center">四核 1.40 GHz Cortex-A53</td>
        <td style="text-align: center">四核 1.50 GHz Cortex-A72</td>
      </tr>
      <tr>
        <td>内存</td>
        <td style="text-align: center">1 GB DDR2</td>
        <td style="text-align: center">1 GB DDR2</td>
        <td style="text-align: center">1 / 2 / <strong>4</strong> GB DDR4</td>
      </tr>
      <tr>
        <td>GPU</td>
        <td style="text-align: center">VideoCore IV</td>
        <td style="text-align: center">VideoCore IV</td>
        <td style="text-align: center">VideoCore VI</td>
      </tr>
      <tr>
        <td>以太网</td>
        <td style="text-align: center">100 Mbps</td>
        <td style="text-align: center">300 Mbps 有效</td>
        <td style="text-align: center">1 Gbps</td>
      </tr>
      <tr>
        <td>Wi-Fi</td>
        <td style="text-align: center">2.4 GHz</td>
        <td style="text-align: center">2.4 GHz / 5 GHz</td>
        <td style="text-align: center">2.4 GHz / 5 GHz</td>
      </tr>
      <tr>
        <td>蓝牙</td>
        <td style="text-align: center">4.0</td>
        <td style="text-align: center">4.2</td>
        <td style="text-align: center">5.0</td>
      </tr>
      <tr>
        <td>USB</td>
        <td style="text-align: center">4 个 USB 2.0</td>
        <td style="text-align: center">4 个 USB 2.0</td>
        <td style="text-align: center">2 个 USB 2.0 和 2 个 USB 3.0</td>
      </tr>
      <tr>
        <td>官方价格</td>
        <td style="text-align: center">35 美元</td>
        <td style="text-align: center">35 美元</td>
        <td style="text-align: center">35 / 45 / <strong>55</strong> 美元<br />
          （根据内存选择不同而不同）</td>
      </tr>
    </tbody>
  </table>
  <p>在我买到 3B+ 之后，我就把 3B 卖（给了译者），所以那个树莓派 3B 就没法参与接下来的评测了。（译者注：那个 3B 现在被我放在家里吃灰……对不起……）</p>
  <h2 id="我的设置">我的设置</h2>
  <figure class=" ">
    <a href="/static/planet/rpis-powered.jpg" title="Both Raspberry Pis, powered through their GPIO pins">
      <img src="/static/planet/rpis-powered.jpg" alt="Both Raspberry Pis, powered through their GPIO pins" />
    </a>
  </figure>
  <p>正如你看到的那样，两个树莓派都是无头的服务器，只连接了电源和以太网。你可能在疑惑，为什么它们看起来这么诡异，这是因为我所在的实验室有很多标称 5V / 6A 的电源供应线，所以我就拿了一个来通过 GPIO 给这两个树莓派供电。这两个树莓派峰值标称 5V / 2.5A 和 5V / 3A，所以一根供电线就够了。</p>
  <div class="notice--danger">
    <h4 class="no_toc" id="section"><i class="fas fa-exclamation-circle"></i> 警告</h4>
    <p>除非你有稳定的供电，请不要使用 GPIO 给树莓派供电。手机充电器不能作为电源供应，你永远都不应该用手机充电器通过 GPIO 供电给树莓派。</p>
  </div>
  <h2 id="基准测试">基准测试</h2>
  <p>两个树莓派被分配了静态 IP，所有的操作都通过 SSH 完成。操作系统是最新版的 Raspbian Buster Lite。</p>
  <h3 id="sysbench-cpu-测试">SysBench CPU 测试</h3>
  <p>SysBench 是一个可以快速获取系统性能的测试套件。这里我使用 SysBench 来测试 CPU 与内存。</p>
  <div class="language-shell highlighter-rouge">
    <div class="highlight">
      <pre class="highlight"><code>sysbench <span class="nt">--test</span><span class="o">=</span>cpu run
sysbench <span class="nt">--test</span><span class="o">=</span>cpu <span class="nt">--num-threads</span><span class="o">=</span>4 run
sysbench <span class="nt">--test</span><span class="o">=</span>cpu <span class="nt">--num-threads</span><span class="o">=</span>8 run
</code></pre>
    </div>
  </div>
  <figure class=""><img src="/static/planet/sysbench-cpu.png" alt="" />
    <figcaption>
      SysBench CPU 性能，单位为秒，越低越好
    </figcaption>
  </figure>
  <p>如表中显示的那样，在 CPU 性能方面，树莓派 4 相比 3B+ 而言有巨大提升，在所有情况中都少花了 19.3% 的时间。</p>
  <h3 id="sysbench-内存测试">SysBench 内存测试</h3>
  <p>内存测试有点复杂，并且我发现了一些意料之外的结果。</p>
  <div class="language-shell highlighter-rouge">
    <div class="highlight">
      <pre class="highlight"><code>sysbench <span class="nt">--test</span><span class="o">=</span>memory <span class="nt">--memory-block-size</span><span class="o">=</span>1K <span class="nt">--memory-total-size</span><span class="o">=</span>2G <span class="nt">--memory-oper</span><span class="o">=</span><span class="nb">read </span>run
sysbench <span class="nt">--test</span><span class="o">=</span>memory <span class="nt">--memory-block-size</span><span class="o">=</span>1K <span class="nt">--memory-total-size</span><span class="o">=</span>2G <span class="nt">--memory-oper</span><span class="o">=</span>write run
sysbench <span class="nt">--test</span><span class="o">=</span>memory <span class="nt">--memory-block-size</span><span class="o">=</span>1K <span class="nt">--memory-total-size</span><span class="o">=</span>2G <span class="nt">--memory-oper</span><span class="o">=</span><span class="nb">read</span> <span class="nt">--num-threads</span><span class="o">=</span>4 run
sysbench <span class="nt">--test</span><span class="o">=</span>memory <span class="nt">--memory-block-size</span><span class="o">=</span>1K <span class="nt">--memory-total-size</span><span class="o">=</span>2G <span class="nt">--memory-oper</span><span class="o">=</span>write <span class="nt">--num-threads</span><span class="o">=</span>4 run
sysbench <span class="nt">--test</span><span class="o">=</span>memory <span class="nt">--memory-block-size</span><span class="o">=</span>1M <span class="nt">--memory-total-size</span><span class="o">=</span>2G <span class="nt">--memory-oper</span><span class="o">=</span>write <span class="nt">--num-threads</span><span class="o">=</span>4 run
</code></pre>
    </div>
  </div>
  <figure class=""><img src="/static/planet/sysbench-memory.png" alt="" />
    <figcaption>
      SysBench 内存性能，单位为每秒指令数，越高越好
    </figcaption>
  </figure>
  <p>新的 DDR4 内存竟然比老古董 DDR2 内存慢，而且在多线程情况下差距进一步拉大了！唯一一点合理的是，当单个块大小到 1 MiB 的时候，树莓派 4 要小幅好于 3B+。</p>
  <p>一件有意思的事情是，我没有包含“1 MiB Read MT”（1 MiB 单块，读取，多线程）这一列。SysBench 在两块树莓派上都给我返回了超过 200 GB/s 的结果，有时候结果还高达 500 GB/s。这显然太滑稽了，所以我直接忽略了那个结果。</p>
  <h3 id="fio-microsd-卡速度测试">FIO microSD 卡速度测试</h3>
  <p>此测试结果依赖于 microSD 卡本身，所以我拿出了我拥有的最快的 SD 卡：Lexar 667x 128 GB microSD 卡，外观类似下面这张图：</p>
  <figure class=""><img src="/static/planet/microsd-card-1024x752.jpg" alt="" /></figure>
  <p>我使用 <code class="language-plaintext highlighter-rouge">fio</code> 作为磁盘（microSD 卡）I/O 性能测试工具。因为我更熟悉 Crystal DiskMark，我调整了 <code class="language-plaintext highlighter-rouge">fio</code> 的参数，以与其一致。</p>
  <div class="language-shell highlighter-rouge">
    <div class="highlight">
      <pre class="highlight"><code>fio <span class="nt">--loops</span><span class="o">=</span>5 <span class="nt">--size</span><span class="o">=</span>500m <span class="nt">--filename</span><span class="o">=</span>fiotest.tmp <span class="nt">--stonewall</span> <span class="nt">--ioengine</span><span class="o">=</span>libaio <span class="nt">--direct</span><span class="o">=</span>1 <span class="se">\</span>
  <span class="nt">--name</span><span class="o">=</span>SeqRead <span class="nt">--bs</span><span class="o">=</span>1m <span class="nt">--rw</span><span class="o">=</span><span class="nb">read</span> <span class="se">\</span>
  <span class="nt">--name</span><span class="o">=</span>SeqWrite <span class="nt">--bs</span><span class="o">=</span>1m <span class="nt">--rw</span><span class="o">=</span>write <span class="se">\</span>
  <span class="nt">--name</span><span class="o">=</span>512Kread <span class="nt">--bs</span><span class="o">=</span>512k <span class="nt">--rw</span><span class="o">=</span>randread <span class="se">\</span>
  <span class="nt">--name</span><span class="o">=</span>512Kwrite <span class="nt">--bs</span><span class="o">=</span>512k <span class="nt">--rw</span><span class="o">=</span>randwrite <span class="se">\</span>
  <span class="nt">--name</span><span class="o">=</span>4KQD32read <span class="nt">--bs</span><span class="o">=</span>4k <span class="nt">--iodepth</span><span class="o">=</span>32 <span class="nt">--rw</span><span class="o">=</span>randread <span class="se">\</span>
  <span class="nt">--name</span><span class="o">=</span>4KQD32write <span class="nt">--bs</span><span class="o">=</span>4k <span class="nt">--iodepth</span><span class="o">=</span>32 <span class="nt">--rw</span><span class="o">=</span>randwrite <span class="se">\</span>
  <span class="nt">--name</span><span class="o">=</span>4Kread <span class="nt">--bs</span><span class="o">=</span>4k <span class="nt">--rw</span><span class="o">=</span>randread <span class="se">\</span>
  <span class="nt">--name</span><span class="o">=</span>4Kwrite <span class="nt">--bs</span><span class="o">=</span>4k <span class="nt">--rw</span><span class="o">=</span>randwrite
</code></pre>
    </div>
  </div>
  <figure class=""><img src="/static/planet/fio-microsd.png" alt="" />
    <figcaption>
      MicroSD 性能，单位为 MB/s，越高越好
    </figcaption>
  </figure>
  <p>从结果来看，树莓派 4 的性能有巨大提升，在许多测试中都比 3B+ 快出 50%。这可能是树莓派 4 最有用的更新，因为性能的瓶颈几乎都在缓慢的磁盘 I/O 上。</p>
  <h3 id="p7zip-基准测试">p7zip 基准测试</h3>
  <p>7-zip 有个自带的基准测试工具，当然 <code class="language-plaintext highlighter-rouge">p7zip</code>（7-zip 的 POSIX 移植）也有。我使用这个工具来测试树莓派的压缩与解压性能。</p>
  <div class="language-shell highlighter-rouge">
    <div class="highlight">
      <pre class="highlight"><code>7zr b <span class="nt">-mmt1</span>
7zr b
</code></pre>
    </div>
  </div>
  <figure class=""><img src="/static/planet/p7zip.png" alt="" />
    <figcaption>
      p7zip 基准测试，越高越好
    </figcaption>
  </figure>
  <p>如<a href="https://sevenzip.osdn.jp/chm/cmdline/commands/bench.htm">此帮助文档</a>所言，压缩更依赖于内存的吞吐量与延迟，这可能是两块树莓派间在压缩测试中差距增大的原因。总之，树莓派 4 在 p7zip 测试中有 1/3 的性能提升。</p>
  <h3 id="openssl-速度测试">OpenSSL 速度测试</h3>
  <p>OpenSSL 是目前最流行的密码学软件库，它也包含了一个内置的速度测试。结果是在所有块大小中最快的那个——在 4 个测试中大小都是 16,384 字节。</p>
  <div class="language-shell highlighter-rouge">
    <div class="highlight">
      <pre class="highlight"><code>openssl speed <span class="nt">-evp</span> aes-256-cbc
openssl speed <span class="nt">-evp</span> aes-256-gcm
openssl speed <span class="nt">-evp</span> sha1
openssl speed <span class="nt">-evp</span> sha256
</code></pre>
    </div>
  </div>
  <figure class=""><img src="/static/planet/openssl.png" alt="" />
    <figcaption>
      OpenSSL 基准测试，单位为 MB/s，越高越好
    </figcaption>
  </figure>
  <h3 id="网络速度测试">网络速度测试</h3>
  <p>树莓派 4 将 300 Mbps 以太网升级到了真正的千兆网口，如果你打算用它来当离线下载器或者 NAS 的话，这是极好的。这里我跑了两个测试，看看网络究竟如何。</p>
  <h4 id="curl-文件下载测试">CURL 文件下载测试</h4>
  <p>这项测试非常简单：使用 cURL 从局域网机器下载文件，查看速度。</p>
  <figure class=""><img src="/static/planet/cURL.png" alt="" />
    <figcaption>
      cURL 下载速度，单位为 MB/s，越高越好
    </figcaption>
  </figure>
  <p>结果不如预想那么好：树莓派 4 没能跑出千兆的速度，而我旁边的 x86 Linux 盒子就做到了。</p>
  <h4 id="nginx-性能测试">NGINX 性能测试</h4>
  <p>另一个常见的场景是：使用 NGINX 提供网页服务（对不起，这里没有 Apache 的位置）。我在两块树莓派上都安装了 NGINX，设置了 <code class="language-plaintext highlighter-rouge">access_log off</code>，并在我的 x86 盒子上使用 Siege 4.0.4 对树莓派服务器进行基准测试。</p>
  <div class="language-shell highlighter-rouge">
    <div class="highlight">
      <pre class="highlight"><code>siege <span class="nt">-c</span> 10 <span class="nt">-r</span> 1000 <span class="o">[</span>host]
siege <span class="nt">-c</span> 25 <span class="nt">-r</span> 400 <span class="o">[</span>host]
</code></pre>
    </div>
  </div>
  <figure class=""><img src="/static/planet/nginx.png" alt="" />
    <figcaption>
      NGINX 性能，单位为请求数每秒，越高越好
    </figcaption>
  </figure>
  <p>在 CPU 性能与网络速度的双重提升下，新的树莓派 4 速度接近 3B+ 的两倍。如果你想用树莓派搭个网站的话，这是个好消息。</p>
  <h3 id="应用程序性能">应用程序性能</h3>
  <p>我选择了两个我最熟悉的编程语言环境：Python 和 Ruby（我对 Node 不熟）来进行测试。</p>
  <p>Python 测试使用了<a href="https://stackoverflow.com/a/44677724/8460426">此 Stack Overflow 回答</a>中的那个蠢极了的脚本，运行时间作为结果。</p>
  <div class="language-python highlighter-rouge">
    <div class="highlight">
      <pre class="highlight"><code><span class="k">def</span> <span class="nf">test</span><span class="p">():</span>
    <span class="sh">"""</span><span class="s">Stupid test function</span><span class="sh">"""</span>
    <span class="n">lst</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
        <span class="n">lst</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">'</span><span class="s">__main__</span><span class="sh">'</span><span class="p">:</span>
    <span class="kn">import</span> <span class="n">timeit</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">timeit</span><span class="p">.</span><span class="nf">timeit</span><span class="p">(</span><span class="sh">"</span><span class="s">test()</span><span class="sh">"</span><span class="p">,</span> <span class="n">setup</span><span class="o">=</span><span class="sh">"</span><span class="s">from __main__ import test</span><span class="sh">"</span><span class="p">))</span>
</code></pre>
    </div>
  </div>
  <p>Ruby 测试就简单很多：使用 Jekyll 构建<a href="https://ibugone.com/">我的站点</a>，查看消耗的时间。</p>
  <figure class=""><img src="/static/planet/python-ruby.png" alt="" />
    <figcaption>
      应用程序性能，单位为秒，越低越好
    </figcaption>
  </figure>
  <p>Ruby 测试比 Python 测试更加均衡，因为它主要测试的是纯计算性能，结果 Ruby 测试中性能差距就要小一些。</p>
  <p>不过等等，这不代表树莓派 4 对大型的 Python 或者 Ruby 项目来说是个好的选择。相同的测试在我的 x86 盒子（i7-8850H, 32 GB DDR4, NVMe SSD）上<strong>快了 10 倍</strong>，其仅使用 5 秒运行 Python 脚本，4 秒构建我的 Jekyll 站点。毕竟，你不能期望一个只卖 55 美元的板子能够有毁天灭地的性能，不是吗？</p>
  <h3 id="usb-io-性能">USB I/O 性能</h3>
  <p>我拿出了我的 USB 3.1 SSD（由 LiteOn L9M 512 GB 和一个包含了 VL716 SATA 转 USB 芯片的硬盘盒组装而成）。但是，我一把 SSD 插上树莓派，它就没电了。之后我发现这是因为供电不足（GPIO 针脚无法提供足够的电力），所以一天之后，我从 MicroUSB / Type-C 接口重新供电。这一次，3B+ 很顺利，但是树莓派 4 在测试时再一次因为电力问题出错。最后，我只能<strong>同时</strong>从 Type-C 和 GPIO 给树莓派供电，以便在不断电的情况下完成 SSD 测试。</p>
  <p>这次的供电问题真的很严重，但先不去管它。让我们看看结果。</p>
  <div class="language-shell highlighter-rouge">
    <div class="highlight">
      <pre class="highlight"><code>fio <span class="nt">--loops</span><span class="o">=</span>5 <span class="nt">--size</span><span class="o">=</span>1g <span class="nt">--filename</span><span class="o">=</span>fiotest.tmp <span class="nt">--stonewall</span> <span class="nt">--ioengine</span><span class="o">=</span>libaio <span class="se">\</span>
  <span class="nt">--direct</span><span class="o">=</span>1 <span class="nt">--name</span><span class="o">=</span>SeqRead <span class="nt">--bs</span><span class="o">=</span>1m <span class="nt">--rw</span><span class="o">=</span><span class="nb">read</span> <span class="nt">--name</span><span class="o">=</span>SeqWrite <span class="nt">--bs</span><span class="o">=</span>1m <span class="nt">--rw</span><span class="o">=</span>write
</code></pre>
    </div>
  </div>
  <figure class=""><img src="/static/planet/fio-usb.png" alt="" />
    <figcaption>
      USB 速度，单位为 MB/s，越高越好
    </figcaption>
  </figure>
  <p>结果很棒！升级后的 USB 3.0 接口，即使没有跑到最高速，也比前代树莓派高出很多。但在享受高速 USB 之前，再让我强调一次：请特别关注你的 USB 外设，特别是那些有点儿耗电的设备，像机械硬盘和 SSD。如果电力得以保证，利用那两个高速 USB 接口对于 NAS 或者其他存储扩展来说好处多多。</p>
  <h2 id="总结">总结</h2>
  <p>在体验过 3B 到 3B+ 的小小提升后，新的树莓派 4 对于大多数树莓派爱好者来说，都是一场盛宴。价格不变，即使你已经有个 3B+，树莓派 4 也可以说是必买的。尽管在供电和散热上有缺点，如果你不插太多外设，不在树莓派上放太多重型任务的话，也没什么关系。</p>
  ]]></content><author><name>taoky</name></author><category term="Technology" /><category term="Translation" /><category term="树莓派" /><summary type="html"><![CDATA[原文地址：https://ibugone.com/blog/2019/09/raspberry-pi-4-review-benchmark/，作者为 @iBug 同学。以下为翻译部分。]]></summary></entry><entry><title type="html">萌新入门手册：如何使用 nc/ncat？</title><link href="https://lug.ustc.edu.cn/planet/2019/09/how-to-use-nc/" rel="alternate" type="text/html" title="萌新入门手册：如何使用 nc/ncat？" /><published>2019-09-16T00:00:00+08:00</published><updated>2022-10-28T11:15:51+08:00</updated><id>https://lug.ustc.edu.cn/planet/2019/09/how-to-use-nc</id><content type="html" xml:base="https://lug.ustc.edu.cn/planet/2019/09/how-to-use-nc/"><![CDATA[<p>本文用于介绍信息安全大赛中不少题目需要使用的 nc/ncat 工具。</p>
  <h2 id="nc-是什么"><code class="language-plaintext highlighter-rouge">nc</code> 是什么？</h2>
  <p><code class="language-plaintext highlighter-rouge">nc/ncat</code> 是 netcat 的缩写，它可以读写 TCP 与 UDP 端口——或许你看不懂这句话，这没有关系。简单地说，它可以在字符界面下，让你和服务器沟通交流。</p>
  <p>一般来说，有很多题目都会要求你使用 <code class="language-plaintext highlighter-rouge">nc</code> 连接到他们的服务器，并且进行交互，获得 flag。</p>
  <h2 id="如何安装-nc">如何安装 <code class="language-plaintext highlighter-rouge">nc</code>？</h2>
  <p><code class="language-plaintext highlighter-rouge">nc</code> 命令在 macOS 中是自带的，在 Linux 中一般自带，或是可以使用相应的软件包管理器安装（如在 Debian/Ubuntu 中这个包名叫 netcat）。</p>
  <p>当然，如果你在看这篇手册，你的操作系统很有可能是 Windows。它不自带 <code class="language-plaintext highlighter-rouge">nc</code>，尽管可以用 WSL 或者虚拟机的方式解决，但是如果你觉得这样太麻烦了，也有另外一些方法。</p>
  <h3 id="使用静态链接的-ncat-程序">使用静态链接的 <code class="language-plaintext highlighter-rouge">ncat</code> 程序</h3>
  <p>前往 <a href="https://github.com/andrew-d/static-binaries/blob/master/binaries/windows/x86/ncat.exe">https://github.com/andrew-d/static-binaries/blob/master/binaries/windows/x86/ncat.exe</a> 下载此程序。我们也在这里提供了一份。下载下来即可。</p>
  <p><a href="https://planet.ustclug.org/wp-content/uploads/2019/09/ncat.zip">ncat.zip 下载</a></p>
  <p><em>注：<code class="language-plaintext highlighter-rouge">nc</code>/<code class="language-plaintext highlighter-rouge">ncat</code> 事实上是两个不同的程序，但在我们接下来的使用上，基本没有区别。<code class="language-plaintext highlighter-rouge">ncat</code> 是由 Nmap 项目开发的“重置版的 Netcat”。</em></p>
  <h4 id="我的杀毒软件报毒">我的杀毒软件报毒！</h4>
  <p>这是 virustotal 的检测结果：<a href="https://www.virustotal.com/gui/file/d0baada87420dd7c2e63d0dd3248749c06b53806d3021863c4fa659608053a8a/detection">https://www.virustotal.com/gui/file/d0baada87420dd7c2e63d0dd3248749c06b53806d3021863c4fa659608053a8a/detection</a></p>
  <p>如果你不相信此来源，也可以下载 <code class="language-plaintext highlighter-rouge">nmap</code>（一个网络探测、扫描工具），它会附带一个 <code class="language-plaintext highlighter-rouge">ncat</code>。</p>
  <h2 id="如何使用-nc">如何使用 <code class="language-plaintext highlighter-rouge">nc</code>?</h2>
  <h3 id="windows">Windows</h3>
  <p>直接双击，你会看到一个窗口一扫而过——这是正常现象。你需要使用「命令提示符」或者「PowerShell」来访问这个程序。</p>
  <p>Windows 10 中，你可以使用资源管理器 -&gt; 文件来在你存放 <code class="language-plaintext highlighter-rouge">nc</code> 的目录中打开命令提示符或 PowerShell。</p>
  <figure class=""><img src="/static/planet/explorer-1024x510.png" alt="" />
    <figcaption>
      在 Windows 资源管理器中打开命令提示符或 PowerShell
    </figcaption>
  </figure>
  <p>或者，你也可以在开始菜单 -&gt; Windows 系统中打开命令提示符，或者在开始菜单 -&gt; Windows PowerShell 中打开 PowerShell，然后使用 <code class="language-plaintext highlighter-rouge">cd</code> 命令转移到对应的目录：输入 <code class="language-plaintext highlighter-rouge">cd 文件夹名</code> 可以让你转移到对应的文件夹，输入 <code class="language-plaintext highlighter-rouge">cd ..</code> 可以让你转移到上面一层目录。使用 <code class="language-plaintext highlighter-rouge">dir</code> 命令，可以显示当前目录下所有文件。同时，使用 Tab 键可以帮助你补全名称。</p>
  <p>当跳转到你存放 <code class="language-plaintext highlighter-rouge">nc</code> 的文件夹后：</p>
  <ul>
    <li>如果你使用的是 PowerShell（蓝色背景），输入 <code class="language-plaintext highlighter-rouge">./ncat</code>（根据 <code class="language-plaintext highlighter-rouge">nc</code> 对应的名称不同而不同）。</li>
    <li>如果你使用的是命令提示符（黑色背景），输入 <code class="language-plaintext highlighter-rouge">ncat</code>（根据 <code class="language-plaintext highlighter-rouge">nc</code> 对应的名称不同而不同）。</li>
  </ul>
  <p>当显示以下内容时，说明你成功运行了它。</p>
  <figure class=""><img src="/static/planet/cmdncat-1024x596.png" alt="" />
    <figcaption>
      成功运行 <code class="language-plaintext highlighter-rouge">ncat</code>
    </figcaption>
  </figure>
  <h3 id="linux--macos">Linux &amp; macOS</h3>
  <p>打开「终端」，输入 <code class="language-plaintext highlighter-rouge">nc</code>。</p>
  <div class="language-plaintext highlighter-rouge">
    <div class="highlight">
      <pre class="highlight"><code>$ nc
usage: nc [-46AacCDdEFhklMnOortUuvz] [-K tc] [-b boundif] [-i interval] [-p source_port] [--apple-delegate-pid pid] [--apple-delegate-uuid uuid]
	  [-s source_ip_address] [-w timeout] [-X proxy_version]
	  [-x proxy_address[:port]] [hostname] [port[s]]
</code></pre>
    </div>
  </div>
  <p>出现了类似上面的输出，说明运行成功了。</p>
  <h3 id="示例">示例</h3>
  <p>在我们使用浏览器上网的时候，我们和服务器使用了 HTTP 协议进行连接。关于 HTTP 协议的更多细节，你需要自己上网搜索。一般来说，默认是 80 端口。</p>
  <p>我们可以使用 <code class="language-plaintext highlighter-rouge">nc</code>，尝试一次与网页服务器的连接，以百度为例。</p>
  <p>输入 <code class="language-plaintext highlighter-rouge">nc www.baidu.com 80</code>（或者 <code class="language-plaintext highlighter-rouge">ncat www.baidu.com 80</code>，或者 <code class="language-plaintext highlighter-rouge">./ncat www.baidu.com 80</code>，请根据以上的介绍自行修改），程序会等待你的输入。</p>
  <p>输入 <code class="language-plaintext highlighter-rouge">GET / HTTP/1.0</code>。这表示，我们使用 <code class="language-plaintext highlighter-rouge">HTTP/1.0</code> 这个协议版本，用 <code class="language-plaintext highlighter-rouge">GET</code> 的方式请求根 <code class="language-plaintext highlighter-rouge">/</code>。输入两下回车，代表我们的 HTTP 请求完成。如果你的网络畅通，百度的网页服务器会立刻返回大量信息，可以自行搜索，了解它们的含义。现在，你成功（在不使用浏览器的情况下）完成了一次与百度网站的连接！</p>
  <figure class=""><img src="/static/planet/nc-1024x596.png" alt="" />
    <figcaption>
      Success!
    </figcaption>
  </figure>
  <p>如果你成功了，那么你可以开始愉快地完成我们的题目了！</p>
  <p>除了使用 <code class="language-plaintext highlighter-rouge">nc</code> 直接与服务器交互之外，也可以编程与服务器交互。例如：</p>
  <ul>
    <li>在信息安全类的竞赛中一个常用的工具是 Python 的 <a href="https://docs.pwntools.com/en/stable/intro.html"><code class="language-plaintext highlighter-rouge">pwntools</code></a>，具体使用方法可以自行搜索了解。</li>
    <li><code class="language-plaintext highlighter-rouge">nc</code> 也可以使用 <code class="language-plaintext highlighter-rouge">-e</code> 参数设定交互脚本，可参考<a href="https://github.com/ustclug/hackergame2018-writeups/blob/master/official/python_simulator/README.md">科大信息安全大赛 2018 年「猫咪克星」题目的题解</a>（部分 <code class="language-plaintext highlighter-rouge">nc</code> 版本不支持）。</li>
  </ul>
  <h3 id="注意事项">注意事项</h3>
  <blockquote>
    <p>以下内容目前对于比赛中需要 token 的题目不适用，需使用编程方法与题目交互。</p>
  </blockquote>
  <p>由于 <a href="http://blog.chaitanya.im/4096-limit">tty 默认每行的长度最长为 4096</a>，<strong>在粘贴过长的输入时内容可能会被截断</strong>。遇到这种情况时，可以使用文件重定向解决：将需要输入的内容放置在文件中，然后 <code class="language-plaintext highlighter-rouge">cat 你的文件 - | nc 服务器 端口</code>（Windows cmd.exe 中 <code class="language-plaintext highlighter-rouge">type 你的文件 CON | ncat 服务器 端口</code>）即可。</p>
  ]]></content><author><name>taoky</name></author><category term="Tech Tutorial" /><category term="hackergame" /><category term="netcat" /><summary type="html"><![CDATA[本文用于介绍信息安全大赛中不少题目需要使用的 nc/ncat 工具。]]></summary></entry><entry><title type="html">一个 NFS 的简介</title><link href="https://lug.ustc.edu.cn/planet/2019/08/NFS-intro/" rel="alternate" type="text/html" title="一个 NFS 的简介" /><published>2019-08-28T00:00:00+08:00</published><updated>2020-11-09T14:22:35+08:00</updated><id>https://lug.ustc.edu.cn/planet/2019/08/NFS-intro</id><content type="html" xml:base="https://lug.ustc.edu.cn/planet/2019/08/NFS-intro/"><![CDATA[<p>NFS（网络文件系统，Network File System）是一个分布式的文件系统，可以用于在局域网中共享文件。它通常运用在 Unix 与类 Unix 操作系统中。对于 Linux 服务器之间的文件共享来说，NFS 相比于其他的方案（如 Samba）更加方便，性能也更好。对于应用程序来说，NFS 也是透明的。</p>
  <h2 id="简单配置-nfs">简单配置 NFS</h2>
  <p>我们以两台 Debian 10 的机器为例<sup id="fnref:1" role="doc-noteref"><a href="#fn:1" class="footnote" rel="footnote">1</a></sup>简单配置 NFS 服务端。其余的发行版可以查询各自的手册以获取详细信息。</p>
  <p>在绝大多数情况下，NFS 支持已经安装在 Linux 内核中。我们可以使用以下命令安装内核态的 NFS 服务器实现：</p>
  <div class="language-shell highlighter-rouge">
    <div class="highlight">
      <pre class="highlight"><code><span class="nb">sudo </span>apt <span class="nb">install </span>nfs-kernel-server
</code></pre>
    </div>
  </div>
  <p>（如果有兼容 NFSv2 和 NFSv3 的需求，需要安装 <code class="language-plaintext highlighter-rouge">portmap</code>）</p>
  <p>出于安全性的考虑<sup id="fnref:2" role="doc-noteref"><a href="#fn:2" class="footnote" rel="footnote">2</a></sup>，我们假设 NFS 共享的根目录是 <code class="language-plaintext highlighter-rouge">/srv/nfs4</code>。 如果需要共享的目录在其他位置，可以使用 bind mount 的方式挂载上去。（当然，对于简单的配置来说，不这样做问题也不大）</p>
  <div class="language-shell highlighter-rouge">
    <div class="highlight">
      <pre class="highlight"><code>mount <span class="nt">--bind</span> 实际放置文件的目录 /srv/nfs/your_folder_name
</code></pre>
    </div>
  </div>
  <p>编辑 <code class="language-plaintext highlighter-rouge">/etc/exports</code>，设置共享文件夹的位置、允许访问的 IP、权限等，以下是一个示例。</p>
  <div class="language-shell highlighter-rouge">
    <div class="highlight">
      <pre class="highlight"><code>/srv/nfs4/Downloads 192.168.124.0/24<span class="o">(</span>rw,sync<span class="o">)</span>
</code></pre>
    </div>
  </div>
  <p>这里设置了 <code class="language-plaintext highlighter-rouge">/srv/nfs4/Downloads</code> 可以被 192.168.124.0/24 的子网访问，如果希望所有人都可以访问，可以用星号 <code class="language-plaintext highlighter-rouge">*</code> 代替这里的网段。参数为可读写 (rw)，同步 (sync，即更改操作完成之后才会返回用户的请求)。更多的参数细节可以至 <code class="language-plaintext highlighter-rouge">man exports</code> 查看。</p>
  <p>接下来，重启 NFS 服务，服务器端就配置好了。</p>
  <div class="language-shell highlighter-rouge">
    <div class="highlight">
      <pre class="highlight"><code><span class="nb">sudo </span>systemctl restart nfs-kernel-server
</code></pre>
    </div>
  </div>
  <p>接下来配置一下客户端。安装 <code class="language-plaintext highlighter-rouge">nfs-common</code>，之后就可以愉快地挂载了。</p>
  <div class="language-shell highlighter-rouge">
    <div class="highlight">
      <pre class="highlight"><code><span class="nb">sudo </span>mount <span class="nt">-t</span> nfs4 192.168.124.18:/srv/nfs4/Downloads /mnt/nfs_mount/
</code></pre>
    </div>
  </div>
  <p>此处将服务器 192.168.124.18 上的 NFS 共享挂载到了 <code class="language-plaintext highlighter-rouge">/mnt/nfs_mount/</code> 文件夹下。可以看到服务器的文件显示在了客户端中，可以正常打开。</p>
  <p>可以使用 <code class="language-plaintext highlighter-rouge">showmount -e 服务器名称或 IP</code> 来查看某台服务器上可挂载的 NFS 共享。</p>
  <p>如果发现写入没有权限的话，这是由于客户端用户访问时的权限在服务器端会变为匿名用户 (nobody. uid, gid = 65534) 以保障安全性。可以调整文件夹的权限、调整「匿名用户」为指定的 UID 和 GID，或者设置导出参数 <code class="language-plaintext highlighter-rouge">no_root_squash</code>，使客户端用户权限可以在服务端保持（很危险，因为在挂载点中，客户端的 root 和服务端的 root 是一样的）。</p>
  <h2 id="windows-和-macos-也支持当客户端吗">Windows 和 macOS 也支持（当客户端）吗？</h2>
  <p>当然啦。（虽然可能有点麻烦）</p>
  <h3 id="windows">Windows</h3>
  <p>下面以一台在同一局域网的 Windows 10 机器为例。在「启用或关闭 Windows 功能」中添加 NFS 客户端支持。</p>
  <figure class=""><img src="/static/planet/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7-2019-08-28-13.57.03-1.png" alt="" />
    <figcaption>
      Windows 功能 =&gt; NFS 服务 =&gt; NFS 客户端
    </figcaption>
  </figure>
  <p>此客户端会在系统中安装 <code class="language-plaintext highlighter-rouge">mount</code> 等工具。</p>
  <figure class=""><img src="/static/planet/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7-2019-08-28-13.59.48-1-1024x824.png" alt="" />
    <figcaption>
      Windows 版本 <code class="language-plaintext highlighter-rouge">mount</code> 的使用帮助
    </figcaption>
  </figure>
  <p>如果我们需要挂载上面那个服务器的共享，可以输入以下命令：</p>
  <pre><code class="language-cmd">mount \\服务器名称\共享路径 设备名（盘符）
</code></pre>
  <figure class=""><img src="/static/planet/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7-2019-08-28-14.10.47.png" alt="" />
    <figcaption>
      大概是成功挂载了
    </figcaption>
  </figure>
  <p>只不过……好像哪里不太对劲？</p>
  <figure class=""><img src="/static/planet/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7-2019-08-28-14.14.09-1024x555.png" alt="" />
    <figcaption>
      中文的文件名变成了乱码
    </figcaption>
  </figure>
  <p>Windows 中官方的 NFS 支持提供的 <code class="language-plaintext highlighter-rouge">mount</code> 不支持 UTF-8 编码，导致了乱码的产生。如果需要 Windows 支持，考虑以下一些方法：</p>
  <ul>
    <li>使用 <code class="language-plaintext highlighter-rouge">fuse-convmvfs</code> 修改服务端文件的编码，详见<a href="https://superuser.com/questions/302407/what-to-do-with-nfs-server-utf-8-and-windows-7">此 Super User 上的回答</a>。</li>
    <li>找一个别的 Windows 的 NFS 客户端。</li>
    <li>如果正在使用新版的 Windows 10，在区域设置中启用 Beta 版本的 UTF-8 支持。注意这可能会导致一部分软件出现乱码。</li>
  </ul>
  <p>如果要取消挂载，使用 <code class="language-plaintext highlighter-rouge">umount</code> 即可。</p>
  <h3 id="macos">macOS</h3>
  <p>相比于 Windows 的挂载体验来说，macOS 由于是 Unix 系的操作系统，挂载 NFS 就方便一些。直接把 Linux 的命令复制过来就……</p>
  <div class="language-console highlighter-rouge">
    <div class="highlight">
      <pre class="highlight"><code><span class="gp">$</span><span class="w"> </span><span class="nb">sudo </span>mount <span class="nt">-t</span> nfs4 192.168.124.18:/srv/nfs4/Downloads nfs_mount
<span class="go">Password:
mount: exec /Library/Filesystems/nfs4.fs/Contents/Resources/mount_nfs4 for /Users/tao/nfs_mount: No such file or directory
</span></code></pre>
    </div>
  </div>
  <p>诶？稍微调整一下……</p>
  <div class="language-console highlighter-rouge">
    <div class="highlight">
      <pre class="highlight"><code><span class="gp">$</span><span class="w"> </span><span class="nb">sudo </span>mount <span class="nt">-t</span> nfs 192.168.124.18:/srv/nfs4/Downloads nfs_mount
<span class="go">mount_nfs: can't mount /srv/nfs4/Downloads from 192.168.124.18 onto /Users/tao/nfs_mount: Operation not permitted
</span></code></pre>
    </div>
  </div>
  <p>这是因为 NFS 服务器默认配置要求来源端口小于 1024 以「保障安全」（因为这样的端口只有 root 用户可以开）。当然 macOS 中 mount_nfs 的文档里面也这样吐槽：</p>
  <blockquote>
    <p>resvport: Use a reserved socket port number.</p>
    <p>This is useful for mounting servers that require clients to use a reserved port number on the mistaken belief that this makes NFS more secure. (For the rare case where the client has a trusted root account but untrustworthy users and the network cables are in secure areas this does help, but for normal desktop clients this does not apply.)</p>
    <p>BSD System Manager’s Manual, mount_nfs</p>
  </blockquote>
  <p>有两个解决方案：</p>
  <ul>
    <li>服务器端参数加入 <code class="language-plaintext highlighter-rouge">insecure</code>。这样的话 Finder 也可以轻松挂载。</li>
    <li>命令行加入 <code class="language-plaintext highlighter-rouge">-o resvport</code> 参数。</li>
  </ul>
  <p>挂载之后，在 Finder 侧边栏也会显示。编码显示非常正常。<del>MS 出来挨打</del></p>
  <h2 id="在-mirrors-中的实践">在 mirrors 中的实践</h2>
  <p>在新的存储等设备买来配置好之前，我们的 mirrors 服务由服务器 mirrors2 提供。随着各种镜像逐年增大，我们的 ZFS pool 的空间越来越小，尤其是在同步的时候。这个月已经出现了多次空间吃光的情况，出现时会导致导致同步任务堆积无法完成，系统负载达到 100 以上，I/O 性能急剧下降。</p>
  <p>我们对日志分析后发现，bioc 仓库（R 语言的分子生物学软件仓库）访问量很小，但是空间占用巨大（约 1.4 TB）。由于我们前段时间多出一台闲置的服务器（命名为 mirrors3），目前我们将 bioc 放置在了 mirrors3 上，同步任务也由 mirrors3 完成，NFS 到 mirrors2 上继续正常提供服务。这一项工作主要由付佳伟同学完成。多出来的磁盘空间应该可以维持比较长一段时间的稳定工作。</p>
  <p>在一部分细节方面，服务器还没有配置完成，在 <a href="https://mirrors.ustc.edu.cn/status/">status 页面</a>的显示也比较奇怪，这是因为此页面读取的是 mirrors2 的数据。我们未来会进行改进，如果你在使用 bioc 仓库时遇到问题，也欢迎通过发送邮件到 <a href="mailto:lug@ustc.edu.cn">lug@ustc.edu.cn</a> 或者在 <a href="https://github.com/ustclug/discussions">https://github.com/ustclug/discussions</a> 中提交 issue 进行反馈。</p>
  <hr />
  <p>另外，planet 已经有将近一年的时间处于死寂的状态。我写的其实不太好，此次更新主要是希望能够引起大家的注意，收到更多的稿件。另外有一些（未完成的）稿件在我们的草稿箱里，我会去给对应的作者催稿的（</p>
  <p>由于 WordPress 的用户权限配置问题，你在注册账号后可能找不到投稿的地方。直接发送邮件到 <a href="mailto:planet@ustclug.org">planet@ustclug.org</a> 跟我们说吧（当然 <a href="mailto:lug@ustc.edu.cn">lug@ustc.edu.cn</a> 也行，我也会处理的）！也欢迎提供你的博客的 RSS 地址，我们可以选择文章转载到这里。</p>
  <div class="footnotes" role="doc-endnotes">
    <ol>
      <li id="fn:1" role="doc-endnote">
        <p>https://wiki.debian.org/NFSServerSetup <a href="#fnref:1" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
      </li>
      <li id="fn:2" role="doc-endnote">
        <p>https://wiki.archlinux.org/index.php/NFS#Server <a href="#fnref:2" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
      </li>
    </ol>
  </div>
  ]]></content><author><name>taoky</name></author><category term="Technology" /><category term="NFS" /><summary type="html"><![CDATA[NFS（网络文件系统，Network File System）是一个分布式的文件系统，可以用于在局域网中共享文件。它通常运用在 Unix 与类 Unix 操作系统中。对于 Linux 服务器之间的文件共享来说，NFS 相比于其他的方案（如 Samba）更加方便，性能也更好。对于应用程序来说，NFS 也是透明的。]]></summary></entry><entry><title type="html">一根网线安装 Linux——PXE 介绍</title><link href="https://lug.ustc.edu.cn/planet/2018/10/PXE-intro/" rel="alternate" type="text/html" title="一根网线安装 Linux——PXE 介绍" /><published>2018-10-07T00:00:00+08:00</published><updated>2021-09-27T21:52:59+08:00</updated><id>https://lug.ustc.edu.cn/planet/2018/10/PXE-intro</id><content type="html" xml:base="https://lug.ustc.edu.cn/planet/2018/10/PXE-intro/"><![CDATA[<p><em>预启动执行环境（Preboot eXecution Environment，PXE，也被称为预执行环境)提供了一种使用网络接口（Network Interface）启动计算机的机制。这种机制让计算机的启动可以不依赖本地数据存储设备（如硬盘）或本地已安装的操作系统。——摘自 <a href="https://wiki.archlinux.org/index.php/PXE">Archwiki</a></em></p>
  <h3 id="pxe-原理介绍">PXE 原理介绍</h3>
  <p>PXE 协议是由 Intel 设计的，它可以使计算机通过网络启动。协议分为 client 和 server 两端，PXE client 在网卡的 ROM 中，当计算机引导时，BIOS 把 PXE client 调入内存执行，并显示出命令菜单，经用户选择后，PXE client 将放置在远端的操作系统通过网络下载到本地运行。</p>
  <p>PXE 可以通过网络直接启动一些 Live Linux，或者调用 Linux Installer，GParted 等工具，较使用 U 盘启动更加方便快捷，有多种工具，Live 系统等可供用户挑选，在紧急维护情况下也有很大的作用。</p>
  <h3 id="例子图书馆查询机">例子：图书馆查询机</h3>
  <p>图书馆内的图书查询机就是用 PXE 启动的，启动镜像叫 liims，里面包含了一个以图书馆透明计算系统为主页的浏览器（主页包括了图书查询，邮箱登录，学习空间预约等功能），还有瀚海星云的 telnet 客户端和彩虹猫，用户也可以自己启动一个虚拟机，用 PXE 启动进入查询系统。</p>
  <h2 id="pxe-怎么用">PXE 怎么用</h2>
  <h3 id="使用条件">使用条件</h3>
  <p>电脑最好内置有 PXE Boot Agent，并且已经<a href="https://lug.ustc.edu.cn/wiki/server/pxe/faq#如何激活我电脑中的-pxe-boot-agent">激活</a>；没有现成支持的话，有<a href="https://lug.ustc.edu.cn/wiki/server/pxe/faq#我的电脑没有内置-pxe-boot-agent我该怎么做">几种解决办法</a>。
    所在的网段最好有能提供正确的 PXE 信息的 DHCP 服务器，以及可以通过 TFTP 数据包的网关；没有的话可以请管理员加以<a href="https://lug.ustc.edu.cn/wiki/server/pxe/faq#我们实验室有自己的网关和-dhcp-服务器该如何设置以便子网内的计算机能够访问-pxe-服务">设置</a>，或自己动手<a href="https://lug.ustc.edu.cn/wiki/server/pxe/faq#如何把某个-pxeustc-上的网络启动系统直接加入-grublilo-的启动菜单">把网络启动系统加入 GRUB/LILO 菜单</a>。
    如果所在实验室用地址转换/伪装技术建立了自己的子网，则需要<a href="https://lug.ustc.edu.cn/wiki/server/pxe/faq#我们实验室有自己的网关和-dhcp-服务器该如何设置以便子网内的计算机能够访问-pxe-服务">配置</a>。</p>
  <h4 id="科大校园网">科大校园网</h4>
  <p>连接校园网（一般需要插网线）调节 BIOS 设置进入 PXE 环境即可直接进入 USTC PXE</p>
  <h4 id="非科大校园网">非科大校园网</h4>
  <p>首先需要进入 PXE 环境，这里以在 virtualbox 虚拟机使用 iPXE 为例， virtualbox 自带的 PXE 功能比较简单，所以使用 iPXE 替代之。从 iPXE 官网下载 iPXE 的 <a href="http://boot.ipxe.org/ipxe.iso">ISO</a>，然后让虚拟机从这个 ISO 启动。 按 Ctrl + B 进入 iPXE 的命令行模式。然后输入以下命令：</p>
  <div class="language-plaintext highlighter-rouge">
    <div class="highlight">
      <pre class="highlight"><code>dhcp //如果已经获取到了地址则请忽略
set 210:string http://202.38.93.94/boot/tftp/
chain ${210:string}pxelinux.0
</code></pre>
    </div>
  </div>
  <p>注：目前 PXE 处于更新状态，新版 PXE 还有一些问题，使用上述命令出现问题的同学请使用旧版 PXE，使用 Windows PE 的同学也请先使用旧版 PXE，命令如下</p>
  <div class="language-plaintext highlighter-rouge">
    <div class="highlight">
      <pre class="highlight"><code>dhcp //如果已经获取到了地址则请忽略
set 210:string http://202.38.93.94/boot/tftp/
chain ${210:string}lpxelinux.0
</code></pre>
    </div>
  </div>
  <p>接下来你就能见到 USTC PXE 的界面了 🙂</p>
  <p>注意到我们使用的 iPXE 的命令里使用的是 http 协议，这也为一些在 NAT 后面而无法使用 tftp 的用户提供使用 USTC PXE 的方法。</p>
  <p>另外 iPXE 也可以刻录到 usb 上，这样主机如果想用 PXE 就可以用 usb 启动 iPXE （如果主机自带的 PXE 比较弱），然后使用上面的命令进入 USTC PXE 了。 iPXE 的 usb 镜像可以从 http://boot.ipxe.org/ipxe.usb 下载，然后用 <code class="language-plaintext highlighter-rouge">dd if=ipxe.usb of=/dev/sdX </code>来刻录。</p>
  <p>下载 iso 作为虚拟光驱挂载在虚拟机上，从 CD 启动，</p>
  <h2 id="pxe-有什么">PXE 有什么</h2>
  <figure class=""><img src="/static/planet/2018-08-11-1720-ScreenShot.png" alt="" />
    <figcaption>
      PXE 的启动菜单
    </figcaption>
  </figure>
  <h3 id="linux-安装工具">Linux 安装工具</h3>
  <ul>
    <li>Ubuntu</li>
    <li>Debian</li>
    <li>Kali</li>
    <li>OpenSUSE</li>
    <li>Centos</li>
    <li>Arch Linux</li>
    <li>Fedora</li>
  </ul>
  <h3 id="live-system">Live System</h3>
  <ul>
    <li>Ubuntu</li>
    <li>Debian</li>
    <li>Deepin</li>
    <li>Archlinux</li>
    <li>Manjaro</li>
  </ul>
  <h3 id="windows-pe">Windows PE</h3>
  <p><img src="/static/planet/2018-08-11-1733-ScreenShot-2.png" alt="img" /></p>
  <h3 id="实用工具">实用工具</h3>
  <ul>
    <li>
      <p>Hardware Detection Tools (hdt)</p>
      <figure class=""><img src="/static/planet/2018-08-11-1726-ScreenShot.png" alt="" />
        <figcaption>
          hdt 中的查看硬盘信息部分
        </figcaption>
      </figure>
    </li>
    <li>PXE Knife</li>
    <li>GParted Live</li>
    <li>Clonezilla live</li>
  </ul>
  <h3 id="图书馆查询系统">图书馆查询系统</h3>
  <p><img src="/static/planet/2018-08-11-1943-ScreenShot.png" alt="img" /></p>
  <h2 id="应用场景分析">应用场景分析</h2>
  <h3 id="体验新系统">体验新系统</h3>
  <p>PXE 的 Live System 菜单中包含了 Debian，Deepin，Arch Linux，Manjaro 等 Live 系统，选择一个 Live 系统启动，就可以不用安装就能体验 Linux 的使用。</p>
  <h3 id="安装新系统">安装新系统</h3>
  <p>PXE 中 Linux Installer 菜单下有 Debian，Kali 等多种 Linux 发行版的安装器，当然也可以通过 Live System 进行安装，PXE 使用的 Live System 与写了 Live iso 的 U 盘功能是一样的。</p>
  <h3 id="linux-密码恢复磁盘检查等">Linux 密码恢复，磁盘检查等</h3>
  <p>Linux 用户通常需要准备一个 Live USB，在忘记密码，磁盘检查等需要对根分区进行操作等情况下能够进入 Live，再 Live 上面对本机系统进行各种操作。PXE 其实就在不需要 U 盘的前提下实现了这个功能，而且由于 PXE 上面有多种镜像，用户就有了多种选择。</p>
  <p>进入 Live 之后，如果进入图形界面，启动一个终端模拟器（即 terminal）即可，或者进入 tty。进行密码恢复等操作一般需要 root 权限。</p>
  <p>密码恢复：首先挂载本机系统的根分区（mount <em>设备名(如 /dev/sda1)**挂载点</em>），然后 chroot 进入挂载点，再用 passwd <em>用户名</em>（root 可以不加参数）命令修改密码。</p>
  <p>磁盘检查，分区修改等：fsck 和 fdisk 命令均需要进行操作的分区未被挂载。如果磁盘检查，fsck <em>设备名</em> 即可。分区修改，如扩容等操作先 fdisk <em>设备名</em>，进入 fdisk 程序内部，再执行 fdisk 命令即可。fdisk 命令可以使用 m 查看。fdisk 命令较为简单，如 p 为打印分区表，d 为删除分区，n 为新建一个分区，w 为写入分区表等，执行命令后 fdisk 会对接下来进行的操作给出提示。分区修改也可以使用 gparted live，图形界面可能更友好一些，下文会进行介绍。</p>
  <h3 id="硬盘分区扩容">硬盘分区扩容</h3>
  <p>GParted 的界面较为直观，选择设备后界面就会出现这个设备的分区情况，点击一块分区可以进行删除，移动，改变大小或复制，如果有空闲空间也可以点击 New 新建分区。移动分区或向前扩容时要注意，<strong>改变分区起始位置可能会使文件系统损坏</strong>。每次进行一次操作后最下方会增加一个条目，确认修改时要点击 Apply，此时 GParted 会根据 operation list 进行操作并给出日志，在完成之后会更新分区表。</p>
  <p><img src="/static/planet/2018-08-11-1717-ScreenShot-1.png" alt="img" />
    使用 GParted 改变分区大小和位置</p>
  <h3 id="windows-下的启动修复等">Windows 下的启动修复等</h3>
  <p>PXE 上还有 Windows PE 的镜像，因此也可以通过 PE 来对本机的 Windows 进行启动修复，文件移动复制，修改注册表等操作。</p>
  <h2 id="总结">总结</h2>
  <p>相比使用 U 盘安装时还需要下载镜像，制作启动盘等繁琐的操作，使用 PXE 只需要插上网线，并且调节 BIOS 设置即可进入 live linux，而且还有 GParted 等一系列工具可用，在服务器等出现问题时应急处理也很有帮助，还是很方便的。同学们也可以事先安装 ipxe，以便在校外或直接连接时连接不上等特殊情况时也可以使用 PXE。</p>
  <p>PXE 目前由李文睿同学维护，如果需要反馈 BUG，可以发邮件到 lug AT ustc.edu.cn 或 sirius AT ustclug.org。</p>
  ]]></content><author><name>sirius</name></author><category term="Technology" /><category term="PXE" /><summary type="html"><![CDATA[预启动执行环境（Preboot eXecution Environment，PXE，也被称为预执行环境)提供了一种使用网络接口（Network Interface）启动计算机的机制。这种机制让计算机的启动可以不依赖本地数据存储设备（如硬盘）或本地已安装的操作系统。——摘自 Archwiki]]></summary></entry><entry><title type="html">USTC Linux 用户生存指南</title><link href="https://lug.ustc.edu.cn/planet/2018/08/USTC-Linux-user-guide/" rel="alternate" type="text/html" title="USTC Linux 用户生存指南" /><published>2018-08-08T00:00:00+08:00</published><updated>2021-08-10T23:02:31+08:00</updated><id>https://lug.ustc.edu.cn/planet/2018/08/USTC-Linux-user-guide</id><content type="html" xml:base="https://lug.ustc.edu.cn/planet/2018/08/USTC-Linux-user-guide/"><![CDATA[<p>本指南指导中科大 Linux 用户如何使用 Linux 完成各门课程、处理学业事项，以及运行需要的专业软件。“兼容性”仅代表使用 Linux 完成任务的难易程度，与其他指标（如课程本身质量和难度）无关。</p>
  <p><strong><del>注意：本指南目前仅包含部分计算机专业本科课程。</del></strong>欢迎其他同学贡献更多内容！</p>
  <h2 id="课程">课程</h2>
  <h3 id="程序设计">程序设计</h3>
  <p>mk (16 级):</p>
  <p>程序设计课程主要讲授 C 语言知识，而 C 语言本身就是用来 UNIX 的原生语言，所以不会有任何障碍。</p>
  <p>建议使用 GCC 或 Clang 作为编译器，使用 GDB 作为调试器。可以选用任意一款文本编辑器（Vim、Emacs、Sublime、Atom、VSCode、gedit、Kate 等）或集成开发环境（如 CLion、Geany、KDevelop）。</p>
  <p>兼容性：★★★★★</p>
  <h3 id="数据结构">数据结构</h3>
  <p>mk (16 级):</p>
  <p>主要讲授数据结构及其 C 语言实现。和程序设计一样没有任何问题。</p>
  <p>课本（严蔚敏版数据结构）分光盘版和无盘版。光盘内容为算法和数据结构的演示程序，仅支持 MS-DOS 和 Windows，其功能可完全由 VisuAlgo 替代。所以建议购买无盘版。</p>
  <p>taoky (17 级):</p>
  <p>补充一点，如果真的要跑光盘的话，用 wine 和 DOSBOX 可以顺利执行。</p>
  <p>兼容性：★★★★★</p>
  <h3 id="模拟与数字电路实验">模拟与数字电路实验</h3>
  <p>mk (16 级):</p>
  <p>旧开发板：Digilent Nexys 2 和 3 均有 Linux 工具，Xilinx ISE 也有 Linux 版本。笔者经验是 Xilinx ISE 可以正常使用。</p>
  <p>新开发板(Digilent Nexys 4 DDR)：Xilinx Vivado 有 Linux 版本。可模拟，综合，实现，烧录。（含串口通讯等 exe 文件的实验可能无法正常开展）</p>
  <p>注：除了烧录 FPGA，可以完全使用自由软件替代。仿真可以使用 Icarus Verilog 和 GTKWave。</p>
  <p>兼容性：★★★☆☆</p>
  <p>taoky (17 级):</p>
  <p>我们这一届开始全面用新的开发板 (Nexys 4 DDR)，实验可以完整在 Linux 上完成。（没有见到上面说的串口通讯实验）</p>
  <p>兼容性：★★★★★</p>
  <h3 id="计算机系统概论h">计算机系统概论（H）</h3>
  <p>mk (16 级):</p>
  <p>LC3 Tools 提供 Linux 版本。作业和 Lab 只需提交 PDF 版本。教学资源、课程要求见课本官网或课程官网：http://acsa.ustc.edu.cn/ics/。</p>
  <p><a href="https://github.com/chiragsakhuja/lc3tools/releases">LC3 Tools 二进制文件(.AppImage)</a></p>
  <p>taoky (17 级):</p>
  <p>LC3 Tools Linux version 没有中断的支持。不过我们这一届没有出这个实验。</p>
  <p>兼容性：★★★★☆</p>
  <h3 id="计算机组成原理">计算机组成原理</h3>
  <p>mk (16 级):</p>
  <p>实验主要为仿真，FPGA 开发板使用较少。部分仿真实验使用 Xilinx ISE 较为方便。最后的大作业可选烧录到 FPGA 上。</p>
  <p>注意，本课程可能必须使用 Xilinx ISE 进行仿真，因为只有 ISE 支持以直观方式查看「内存」的内容。</p>
  <p>兼容性：★★★☆☆</p>
  <p>taoky (17 级):</p>
  <p>和数电实验一样。而且我觉得搞 MIPS/RISC-V 的 toolchain Linux 更方便。</p>
  <p>兼容性：★★★★★</p>
  <p>regymm (17 级):</p>
  <p>注：如果有串口通信实验，在 Linux 上有 picocom 等工具，不必非要使用专门的 exe 软件。</p>
  <h3 id="操作系统原理与设计">操作系统原理与设计</h3>
  <p>mk (16 级):</p>
  <p>操作系统课不可能绕过 Linux！就算是 Windows 用户也会被迫安装 Linux 虚拟机。所以 Linux 用户不会遇到任何问题。</p>
  <p>兼容性：★★★★★</p>
  <h3 id="编译原理与技术">编译原理与技术</h3>
  <p>mk (16 级):</p>
  <p>本课程会大量使用开源/自由软件，如 Flex、Bison、ANTLR、LLVM 等。作为 Linux 用户，当然 Feel at home~</p>
  <p>兼容性：★★★★★</p>
  <h3 id="计算机网络">计算机网络</h3>
  <p>mk (16 级):</p>
  <p>使用 Wireshark，支持 Linux。</p>
  <p>taoky (17 级):</p>
  <p>不同班级的实验会不一样，但是基本上都需要使用 Wireshark。有些实验会有 socket 编程相关的内容，兼容性上没有问题。</p>
  <p>兼容性：★★★★★</p>
  <h3 id="微机原理与系统">微机原理与系统</h3>
  <p>mk (16 级):</p>
  <p>需要用到 MASM。大概使用 DOSBox 就能应付（？）</p>
  <p>taoky (17 级):</p>
  <p>我记得我做微机原理实验的时候，开了个 Windows XP 的 VM，毕竟实模式的 DOS 还是有点麻烦的，如果处理不好，每次都要重开 DOSBOX。而 XP 的好处是可以用 NTVDM 直接跑 MASM，并且大部分实验中编译得到的 .com 文件也可以直接跑，只有少部分实验不得不开 DOSBox。</p>
  <p>另一个麻烦的东西是 Emu8086。没有测试过它能不能用 wine 跑起来（感觉应该可以）。</p>
  <p>相比于其他依赖 Windows 的实验来说，微机原理比较好的一点是，可以直接开个非常轻量的 Windows XP 虚拟机完成所有实验。不过这门课现在变成选修了。</p>
  <p>BTW: 有同学问如何让 DOSBox 在 Linux 下在当前终端处理输入输出。如果有这样的需求（比如说你在用 VSCode Remote 连到某台机器上做实验），可以尝试 <a href="https://github.com/dosemu2/dosemu2">https://github.com/dosemu2/dosemu2</a>，参考 <a href="https://retrocomputing.stackexchange.com/questions/16173/emulate-a-text-mode-dos-program-using-a-unix-terminal">https://retrocomputing.stackexchange.com/questions/16173/emulate-a-text-mode-dos-program-using-a-unix-terminal</a>。</p>
  <p>兼容性：★★★☆☆</p>
  <h3 id="算法基础">算法基础</h3>
  <p>mk (16 级):</p>
  <p>和数据结构差不多，写一些与平台无关的算法代码。</p>
  <p>兼容性：★★★★★</p>
  <h3 id="数据库系统及应用">数据库系统及应用</h3>
  <p>mk (16 级):</p>
  <p>PowerDesigner?! 看起来只能 Wine / 虚拟机 了。</p>
  <p>taoky (17 级):</p>
  <p>我这届金培权老师班级的实验是：实验一写 SQL，实验二用 PowerDesigner 画图，实验三写使用 MySQL 的小 project。实验一和三都可以在 Linux 下顺利完成，只有实验二需要依赖 Windows。</p>
  <p>兼容性：★★☆☆☆</p>
  <h3 id="人工智能基础">人工智能基础</h3>
  <p>mk (16 级):</p>
  <p>实验与操作系统关系不是很大~</p>
  <p>兼容性：★★★★★</p>
  <h3 id="计算机体系结构">计算机体系结构</h3>
  <p>mk (16 级):</p>
  <p>写模拟程序，可以使用任何语言，所以问题不大。</p>
  <p>兼容性：★★★★★</p>
  <p>taoky (17 级):</p>
  <p>目前体系结构实验变成了写 Verilog，跑 Vivado。最后一个实验要求运行多 Cache 一致性和 Tomasulo 模拟器，这两个是 Windows 程序。我用 wine 尝试跑过，发现显示有一些问题。</p>
  <p>兼容性：★★★☆☆</p>
  <h3 id="大学英语听说-i-iv">大学英语听说 I-IV</h3>
  <p>regymm (17 级):</p>
  <p>这门课可能需要随书附带光盘中的练习资料。自带的练习软件无法在 wine 中运行。然而，光盘中的音频和视频文件均可以直接播放（老师可能也会提到这一点）。</p>
  <p>同时，二教 8 楼等听力考试的机房似乎也在平时开放供同学使用。</p>
  <p>兼容性：★★★☆☆</p>
  <h3 id="金工实习">金工实习</h3>
  <p>regymm (17 级):</p>
  <p>需要使用 AutoCAD 和 SolidWorks 完成课后设计作业。<em>或许</em>有自由软件替代。这类软件对图形要求较高，VirtualBox 上表现不佳，我只能选择使用 VMWare。这方面似乎 Linux 上确实无太好的解决方案。</p>
  <p>虚拟仿真实验需要安装科大平台提供的 Windows 程序并在指定浏览器运行。在 VirtualBox 中使用时图形性能十分低下，不影响完成实验但体验不佳。</p>
  <p>如果手头没有性能较好能够在 VMWare 中运行 CAD 软件的机器，可以选择在工院机房完成，那里有性能不错并预装好所需软件的 Windows 机器。</p>
  <p>兼容性：★☆☆☆☆</p>
  <h3 id="大物实验">大物实验</h3>
  <p>regymm (17 级):</p>
  <p>对于大部分实验，只需要处理数据并绘图。<a href="#origin">Origin</a> 是”官方推荐“的软件，但是用 <a href="#matlab">MATLAB</a> 或 Python 等可以胜任。</p>
  <p>个别实验似乎会要求用 U 盘拷贝 Origin 文件并课下分析，这就没有办法只能用 Origin 了。而也有个别实验让我觉得 Origin 明显是更加明智的选择。</p>
  <p>个别实验需要用（可能是实验室助教自己编写的）基于 MFC 等框架的处理程序，但我遇见的所有情况都是在课上分析完成，并不需要在自己电脑上使用这些程序。</p>
  <p>核物理专业实验等需要分析一些专门处理软件（探测器上位机）或示波器导出的数据，但似乎都是纯文本，用 Linux 不会有什么困难。有时也可能使用 <a href="#root">ROOT</a>.</p>
  <p>总之，如果你只需要做一级实验，应该不会遇到任何 Linux 无法处理的情况。然而如果你需要做三级甚至更多级，最好为 corner case 做好准备。对于这一系列本就较为繁琐的课程，从节约时间的角度考虑，装上 Origin 以备不时之需也是应该的，即使是在偶有问题的 wine 上。</p>
  <p>兼容性：★★★★☆（一级二级），★★★☆☆（三级至五十三级）</p>
  <h3 id="计算物理">计算物理</h3>
  <p>regymm (17 级):</p>
  <p>除了 C、C++、Fortran 等编程外，可能用到 <a href="#matlab">MATLAB</a>、<a href="#mathematica">Mathematica</a>、<a href="#origin">Origin </a> 等，但没有任何一个是必须的。可以根据个人喜好或兼容性选择。</p>
  <p>兼容性：★★★★★</p>
  <h3 id="计算方法">计算方法</h3>
  <p>regymm (17 级):</p>
  <p>除了基本程序设计软件之外，可能会用到 <a href="#matlab">MATLAB</a>.</p>
  <p>兼容性：★★★★★</p>
  <h2 id="学业杂项">学业杂项</h2>
  <h3 id="托福">托福</h3>
  <p>regymm (17 级):</p>
  <p>小站托福可以在 Crossover 中较好的运行，有 bug 但并不会在做题过程中出现。不建议在虚拟机中使用，因为音频可能质量下降。</p>
  <p>兼容性：★★★★☆</p>
  <h3 id="实验报告文书编写">实验报告/文书编写</h3>
  <p>regymm (17 级):</p>
  <p>无论是 LaTeX、LyX、Texmacs 还是 IDE 如 TexStudio，都有 Linux 版本，甚至可能安装更加容易。</p>
  <p>Word 或 Excel 等格式的文件主要是社团/学生会/班级的填报表格等，WPS for Linux 可以胜任。如果不放心，可以在手机上的 Office 软件中 double check. 另外，我在 Crossover 中安装的 Office 2010 套装运行良好（而 Office 2013 和 Office 2016 经常出现各种问题）。</p>
  <p>兼容性：★★★★☆</p>
  <h3 id="申请出国">申请出国</h3>
  <p>regymm (17 级):</p>
  <p>文书可以用 TeX，填写各种申请表也只需要一个 modern 的浏览器。需要在 PDF 中添加注释，或在 Word 文档中编辑的情况很少但确实存在。Linux 上的 Foxit Reader 是不错的 PDF 编辑器，但在这种事情上我还是选择了虚拟机中的福昕企业版（科大正版软件有提供）和较新的 Office 套装。</p>
  <p>兼容性：★★★★★</p>
  <h2 id="专业软件">专业软件</h2>
  <h3 id="matlab">MATLAB</h3>
  <p>regymm (17 级):</p>
  <p>专利软件 MATLAB 是有 Linux 版的，并且科大正版软件有所提供。本人在用 MATLAB 完成计算、绘图、网络编程、Simulink 等任务时均未遇到任何问题。</p>
  <p>然而，如果要使用一些第三方厂商提供的模块和/或进行硬件控制，可能会遇到 Linux 上无法正常使用的情况。</p>
  <p>兼容性：★★★★☆</p>
  <h3 id="mathematica">Mathematica</h3>
  <p>regymm (17 级):</p>
  <p>专利软件 Mathematica 是有 Linux 版的，并且科大正版软件有所提供。尽管界面相比 Windows 版稍丑（个人看法），未遇到任何功能问题。</p>
  <p>兼容性：★★★★★</p>
  <h3 id="origin">Origin</h3>
  <p>regymm (17 级):</p>
  <p>专利软件 Origin 是交互式科学绘图和数据分析工具，没有 Linux 版。在 Origin 2017 / Origin 最新版 / wine 32 位 Win10 模式 / wine 64 位 Win10 模式的组合中，大部分可以正常安装运行。</p>
  <p>然而，需要注意的是，尽管大部分功能能正常运行，一些个别功能可能会 fail silently，如果遇到某一操作无法执行，除了自己操作错误外，也可能是其本身的问题。这可能耽误很多时间。</p>
  <p>VirtualBox 可以正常运行。</p>
  <p>可以考虑 QtiPlot、gnuplot、甚至 <a href="#root">ROOT</a> 完成绘图。</p>
  <p>兼容性：★★☆☆☆</p>
  <h3 id="root">ROOT</h3>
  <p>regymm (17 级):</p>
  <p>CERN 的 ROOT 同样有原生 Linux 支持。课程提供的程序文件中只可能有个别地方，如文件路径格式等，需要修改。</p>
  <p>兼容性：★★★★★</p>
  ]]></content><author><name>Kai Ma</name></author><category term="Experience" /><category term="Courses" /><summary type="html"><![CDATA[本指南指导中科大 Linux 用户如何使用 Linux 完成各门课程、处理学业事项，以及运行需要的专业软件。“兼容性”仅代表使用 Linux 完成任务的难易程度，与其他指标（如课程本身质量和难度）无关。]]></summary></entry></feed>